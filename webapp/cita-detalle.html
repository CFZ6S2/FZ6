<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validar Cita - TuCitaSegura</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- iOS PWA Support -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TuCitaSegura">
  <meta name="theme-color" content="#764ba2">
  <link rel="stylesheet" href="./css/output.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- QR Code Generator (Using cdnjs for reliability) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
  <!-- QR Scanner (html5-qrcode) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.3), transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(255, 0, 128, 0.2), transparent 50%);
      animation: backgroundMove 15s ease infinite;
      z-index: 0;
    }

    @keyframes backgroundMove {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }

    /* Glassmorphism containers */
    .glass-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    .glass-input {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      transition: all 0.3s ease;
    }

    .glass-input:focus {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      outline: none;
      transform: translateY(-2px);
    }

    .glass-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Gradient Buttons */
    .gradient-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .gradient-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    /* Map Container */
    #map {
      width: 100%;
      height: 400px;
      border-radius: 16px;
      overflow: hidden;
    }

    /* PIN Input Styling */
    .pin-input {
      width: 60px;
      height: 70px;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      transition: all 0.3s ease;
    }

    .pin-input:focus {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
      outline: none;
      transform: scale(1.05);
    }

    /* Status Badges */
    .status-pending {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .status-validated {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .status-expired {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    /* Loading Overlay */
    .loading-overlay {
      background: rgba(102, 126, 234, 0.95);
      backdrop-filter: blur(10px);
    }

    /* Floating Animation */
    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .float-animation {
      animation: float 3s ease-in-out infinite;
    }

    /* Distance Indicator */
    .distance-circle {
      position: absolute;
      border: 3px dashed rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      pointer-events: none;
    }

    /* Hide scrollbar but keep functionality */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
  </style>
</head>

<body class="relative">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay fixed inset-0 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
      <p class="text-white text-xl font-semibold">Cargando cita...</p>
    </div>
  </div>

  <!-- Navigation Bar -->
  <nav class="glass-container fixed top-0 left-0 right-0 z-40 mx-4 mt-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-2 rounded-xl">
            <i class="fas fa-calendar-check text-white text-xl"></i>
          </div>
          <span class="text-white font-bold text-xl">TuCitaSegura</span>
        </div>

        <div class="hidden md:flex items-center space-x-6">
          <a href="/buscar-usuarios.html" class="text-white hover:text-purple-200 transition">
            <i class="fas fa-search mr-2"></i>Buscar
          </a>
          <a href="/conversaciones.html" class="text-white hover:text-purple-200 transition">
            <i class="fas fa-comments mr-2"></i>Chats
          </a>
          <a href="/perfil.html" class="text-white hover:text-purple-200 transition">
            <i class="fas fa-user mr-2"></i>Perfil
          </a>
        </div>

        <button id="logoutBtn" class="text-white hover:bg-white hover:bg-opacity-20 px-4 py-2 rounded-lg transition">
          <i class="fas fa-sign-out-alt mr-2"></i>Salir
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="relative z-10 pt-24 pb-12 px-4">
    <div class="max-w-4xl mx-auto">

      <!-- Page Header -->
      <div class="text-center mb-8 float-animation">
        <div class="inline-block bg-gradient-to-r from-green-500 to-emerald-500 p-4 rounded-2xl mb-4">
          <i class="fas fa-calendar-check text-white text-5xl"></i>
        </div>
        <h1 class="text-white text-4xl md:text-5xl font-bold mb-3">Validar Cita</h1>
        <p class="text-white text-opacity-90 text-lg">Confirma tu asistencia con PIN y ubicaci√≥n</p>
      </div>

      <!-- Date Info Card -->
      <div id="dateInfoCard" class="glass-container p-8 mb-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-white text-2xl font-bold">Informaci√≥n de la Cita</h2>
          <span id="dateStatusBadge" class="status-pending px-4 py-2 rounded-full text-white font-semibold text-sm">
            Pendiente
          </span>
        </div>

        <div class="space-y-4" id="dateInfo">
          <!-- Date info will be loaded here -->
        </div>
      </div>

      <!-- Map Section -->
      <div class="glass-container p-8 mb-6">
        <h2 class="text-white text-2xl font-bold mb-4 flex items-center">
          <i class="fas fa-map-marker-alt mr-3 text-red-300"></i>
          Ubicaci√≥n de la Cita
        </h2>

        <div id="map" class="mb-4"></div>

        <div id="locationStatus"
          class="bg-blue-500 bg-opacity-20 border border-blue-300 border-opacity-30 rounded-lg p-4">
          <p class="text-white text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Debes estar dentro de un radio de 250 metros del lugar de la cita para validarla.
          </p>
        </div>
      </div>

      <!-- Validation Section (New Flow) -->
      <div id="validationSection" class="glass-container p-8 mb-6">
        <h2 class="text-white text-2xl font-bold mb-4 flex items-center">
          <i class="fas fa-shield-alt mr-3 text-yellow-300"></i>
          Validaci√≥n de Cita
        </h2>

        <!-- Not Ready Yet (time/location not met) -->
        <div id="notReadySection" class="hidden">
          <div
            class="bg-orange-500 bg-opacity-20 border border-orange-400 border-opacity-40 rounded-xl p-6 text-center">
            <i class="fas fa-clock text-orange-300 text-4xl mb-4"></i>
            <h3 class="text-white text-xl font-bold mb-2">A√∫n no puedes validar</h3>
            <p id="notReadyMessage" class="text-white text-opacity-80">
              La validaci√≥n se activa 30 minutos antes de la cita y cuando est√©s a menos de 250m del punto de encuentro.
            </p>
            <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
              <div id="timeStatus" class="bg-white bg-opacity-10 rounded-lg p-3">
                <i class="fas fa-hourglass-half text-white text-opacity-60"></i>
                <p class="text-white text-opacity-70 mt-1">Tiempo: <span id="timeStatusText">Esperando...</span></p>
              </div>
              <div id="locationStatusBox" class="bg-white bg-opacity-10 rounded-lg p-3">
                <i class="fas fa-map-pin text-white text-opacity-60"></i>
                <p class="text-white text-opacity-70 mt-1">Ubicaci√≥n: <span id="locationStatusText">Esperando...</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 1: Confirm presence with own PIN -->
        <div id="confirmPresenceSection" class="hidden">
          <p class="text-white text-opacity-80 mb-6">
            Introduce tu PIN personal para confirmar que has llegado al punto de encuentro.
          </p>

          <!-- Your PIN (generated) -->
          <div class="mb-6">
            <label class="text-white font-semibold mb-2 block">Tu PIN de confirmaci√≥n</label>
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-6 rounded-2xl text-center">
              <p id="yourPin" class="text-white text-5xl font-bold tracking-widest">----</p>
            </div>
          </div>

          <!-- Enter YOUR PIN -->
          <div class="mb-6">
            <label class="text-white font-semibold mb-2 block">Escribe tu PIN para confirmar que est√°s aqu√≠</label>
            <div class="flex justify-center space-x-3">
              <input type="text" maxlength="1" class="pin-input" id="pin1" inputmode="numeric" />
              <input type="text" maxlength="1" class="pin-input" id="pin2" inputmode="numeric" />
              <input type="text" maxlength="1" class="pin-input" id="pin3" inputmode="numeric" />
              <input type="text" maxlength="1" class="pin-input" id="pin4" inputmode="numeric" />
            </div>
          </div>

          <button id="confirmPresenceBtn" class="gradient-button w-full py-4 rounded-xl text-white font-bold text-lg">
            <i class="fas fa-check mr-2"></i>
            Confirmar mi llegada
          </button>
        </div>

        <!-- Step 2a: Waiting for other user -->
        <div id="waitingSection" class="hidden">
          <div class="bg-blue-500 bg-opacity-20 border border-blue-400 border-opacity-40 rounded-xl p-6 text-center">
            <i class="fas fa-spinner fa-spin text-blue-300 text-4xl mb-4"></i>
            <h3 class="text-white text-xl font-bold mb-2">¬°Has confirmado tu llegada!</h3>
            <p class="text-white text-opacity-80">
              Esperando a que tu cita tambi√©n confirme su llegada...
            </p>
          </div>
        </div>

        <!-- Step 2b: QR Code (for female user) -->
        <div id="qrCodeSection" class="hidden">
          <div class="text-center">
            <h3 class="text-white text-xl font-bold mb-4">¬°Ambos hab√©is llegado!</h3>
            <p class="text-white text-opacity-80 mb-6">
              Muestra este c√≥digo QR a tu cita para completar la validaci√≥n.
            </p>
            <div class="bg-white p-6 rounded-2xl inline-block mb-4">
              <canvas id="qrCanvas"></canvas>
            </div>
            <p class="text-white text-opacity-60 text-sm">
              <i class="fas fa-info-circle mr-1"></i>
              Tu cita debe escanear este c√≥digo con su tel√©fono
            </p>
          </div>
        </div>

        <!-- Step 2c: QR Scanner (for male user) -->
        <div id="qrScannerSection" class="hidden">
          <div class="text-center">
            <h3 class="text-white text-xl font-bold mb-4">¬°Ambos hab√©is llegado!</h3>
            <p class="text-white text-opacity-80 mb-6">
              Escanea el c√≥digo QR que te muestra tu cita para completar la validaci√≥n.
            </p>
            <div id="qrReader" class="mb-4 rounded-xl overflow-hidden"></div>
            <button id="startScanBtn" class="gradient-button py-3 px-6 rounded-xl text-white font-bold">
              <i class="fas fa-qrcode mr-2"></i>
              Abrir esc√°ner
            </button>
          </div>
        </div>

      </div>

      <!-- Validation Rules -->
      <div class="glass-container p-8">
        <h2 class="text-white text-2xl font-bold mb-6 flex items-center">
          <i class="fas fa-clipboard-list mr-3 text-blue-300"></i>
          Requisitos de Validaci√≥n
        </h2>

        <div class="space-y-3">
          <div id="rule1" class="bg-white bg-opacity-10 p-4 rounded-lg flex items-center space-x-3">
            <i class="fas fa-circle text-white text-opacity-50 text-sm"></i>
            <p class="text-white">Estar dentro de 250 metros del lugar de la cita</p>
          </div>

          <div id="rule2" class="bg-white bg-opacity-10 p-4 rounded-lg flex items-center space-x-3">
            <i class="fas fa-circle text-white text-opacity-50 text-sm"></i>
            <p class="text-white">Estar dentro de la ventana de tiempo (30 min antes/despu√©s)</p>
          </div>

          <div id="rule3" class="bg-white bg-opacity-10 p-4 rounded-lg flex items-center space-x-3">
            <i class="fas fa-circle text-white text-opacity-50 text-sm"></i>
            <p class="text-white">Intercambiar PINs correctamente con tu cita</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Success Modal -->
  <div id="successModal"
    class="opacity-0 pointer-events-none fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="glass-container max-w-md w-full p-8 text-center">
      <div class="inline-block bg-green-500 bg-opacity-30 p-4 rounded-full mb-4">
        <i class="fas fa-check-circle text-green-300 text-5xl"></i>
      </div>
      <h2 class="text-white text-2xl font-bold mb-2">¬°Cita Validada!</h2>
      <p class="text-white text-opacity-80 mb-6">
        Tu cita ha sido validada exitosamente. Los dep√≥sitos se liberar√°n en 24 horas.
      </p>
      <button id="closeSuccessModal" class="gradient-button w-full py-3 rounded-lg text-white font-bold">
        Entendido
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-8 right-8 glass-container px-6 py-4 rounded-lg shadow-lg z-50 max-w-md">
    <div class="flex items-center space-x-3">
      <i id="toastIcon" class="fas fa-check-circle text-2xl"></i>
      <p id="toastMessage" class="text-white font-semibold"></p>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
    <div class="glass-container p-8 max-w-sm w-full mx-4 text-center transform transition-all scale-100">
      <div class="mb-4 text-yellow-400 text-5xl">
        <i class="fas fa-question-circle"></i>
      </div>
      <h3 id="confirmTitle" class="text-2xl font-bold text-white mb-2">¬øEst√°s seguro?</h3>
      <p id="confirmMessage" class="text-slate-300 mb-6 font-medium"></p>
      <div class="flex gap-4 justify-center">
        <button id="btnCancelConfirm"
          class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition">
          Cancelar
        </button>
        <button id="btnConfirmAction"
          class="px-6 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold shadow-lg transition transform hover:scale-105">
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editDateModal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4">
    <div
      class="glass-container max-w-lg w-full p-6 text-left transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
      <h3 class="text-2xl font-bold text-white mb-6 flex items-center justify-between">
        <span><i class="fas fa-edit mr-3 text-purple-400"></i>Modificar Cita</span>
        <button onclick="document.getElementById('editDateModal').classList.add('hidden')"
          class="text-slate-400 hover:text-white transition text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </h3>

      <div class="space-y-4">
        <div>
          <label class="text-white text-sm mb-1 block">Fecha</label>
          <input type="date" id="editDate" class="glass-input w-full p-3 text-white bg-white/10 rounded-lg">
        </div>
        <div>
          <label class="text-white text-sm mb-1 block">Hora</label>
          <input type="time" id="editTime" class="glass-input w-full p-3 text-white bg-white/10 rounded-lg">
        </div>
        <div>
          <label class="text-white text-sm mb-1 block">Lugar</label>
          <input type="text" id="editPlace" class="glass-input w-full p-3 text-white bg-white/10 rounded-lg"
            placeholder="Ej: Restaurante XYZ..." autocomplete="off">
        </div>
        <div>
          <label class="text-white text-sm mb-1 block">Mensaje (Opcional)</label>
          <textarea id="editMessage" class="glass-input w-full p-3 text-white bg-white/10 rounded-lg h-24"
            placeholder="Nota sobre el cambio..."></textarea>
        </div>
      </div>

      <div class="flex gap-4 mt-8 pt-4 border-t border-white/10">
        <button onclick="document.getElementById('editDateModal').classList.add('hidden')"
          class="px-6 py-3 rounded-xl bg-slate-600 hover:bg-slate-500 text-white font-semibold transition w-full">
          Cancelar
        </button>
        <button id="btnSaveDateChanges"
          class="px-6 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold shadow-lg transition transform hover:scale-105 w-full">
          Guardar Cambios
        </button>
      </div>
    </div>
  </div>


  <!--
    ‚ö†Ô∏è CRITICAL: Google Maps API Configuration Required

    ACTION NEEDED: Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key

    Documentation: See /GOOGLE_MAPS_API_SETUP.md for complete setup instructions

    Quick setup:
    1. Go to https://console.cloud.google.com/
    2. Enable Maps JavaScript API + Places API
    3. Create API key with HTTP referrer restrictions
    4. Replace YOUR_GOOGLE_MAPS_API_KEY below

    Status: üî¥ NOT CONFIGURED - Map will NOT work without valid API key
  -->
  <!-- DOMPurify for XSS Protection -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <script type="module" src="./js/sanitizer.js"></script>


  <!-- Google Maps API - Loaded dynamically from config -->
  <!-- See: SECURITY_API_KEYS.md for setup instructions -->
  <script>
    if (!window.GOOGLE_MAPS_API_KEY) {
      try { window.GOOGLE_MAPS_API_KEY = localStorage.getItem('GOOGLE_MAPS_API_KEY') || ''; } catch { }
    }
  </script>
  <script type="module">
    import { GOOGLE_MAPS_API_KEY } from './js/google-maps-config-env.js';

    // Dynamically load Google Maps API with the configured key
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>

  <!-- Firebase Scripts -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, getDb } from './js/firebase-config-env.js';
    import { onAuthStateChanged, signOut } from 'firebase/auth';
    import { doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs, onSnapshot, addDoc } from 'firebase/firestore';
    import { loadTheme } from './js/theme.js';

    const db = await getDb();
    let currentUser = null;
    let currentUserData = null;
    let dateData = null;
    let dateId = null;
    let map = null;
    let userMarker = null;
    let dateMarker = null;
    let distanceCircle = null;

    // Get date ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    dateId = urlParams.get('id');

    if (!dateId) {
      window.location.href = '/conversaciones.html';
    }

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        await loadDateData();
        initMap();
        setupPinInputs();
        document.getElementById('loadingOverlay').classList.add('hidden');
      } else {
        window.location.href = '/login.html';
      }
    });

    // Load user data
    async function loadUserData() {
      // This function is no longer called directly from onAuthStateChanged
      // Its logic has been moved into the onAuthStateChanged block for initial load
      // Keep it here in case it's called elsewhere, but it would need 'db' passed or global 'db'
      try {
        if (!db) {
          console.error("Firestore DB not initialized.");
          return;
        }
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          currentUserData = { id: userDoc.id, ...userDoc.data() };

          // Load user theme
          loadTheme(currentUserData);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error al cargar datos de usuario', 'error');
      }
    }

    // Load date data
    async function loadDateData() {
      try {
        if (!dateId) throw new Error("No date ID");

        // Listen for real-time updates
        onSnapshot(doc(db, 'dates', dateId), async (dateDoc) => {
          if (!dateDoc.exists()) {
            showToast('Cita no encontrada', 'error');
            setTimeout(() => window.location.href = '/citas.html', 2000);
            return;
          }

          dateData = { id: dateDoc.id, ...dateDoc.data() };

          // Fetch other user info only if not loaded or id changed (unlikely for date)
          // For simplicity, we can just fetch it again or check if we have it
          const isSentByMe = dateData.hostId === currentUser.uid;
          const otherUserId = isSentByMe ? dateData.guestId : dateData.hostId;

          dateData.isSentByMe = isSentByMe;
          dateData.otherUserId = otherUserId;

          if (!dateData.otherUser) {
            const otherUserDoc = await getDoc(doc(db, 'users', otherUserId));
            if (otherUserDoc.exists()) {
              dateData.otherUser = { id: otherUserDoc.id, ...otherUserDoc.data() };
            } else {
              dateData.otherUser = { alias: 'Usuario Desconocido' };
            }
          }

          displayDateInfo();

          // Only init map if accepted (and not already inited?)
          // initValidationFlow is called inside displayDateInfo if accepted
          if (dateData.status === 'accepted') {
            // Use a flag to avoid re-initing map unnecessarily if we want
            initMap();
          }
        });

      } catch (error) {
        console.error('Error loading date data:', error);
        showToast('Error al cargar informaci√≥n de la cita', 'error');
      }
    }

    // Display date info
    function displayDateInfo() {
      const dateInfo = document.getElementById('dateInfo');
      const dateStatusBadge = document.getElementById('dateStatusBadge');

      const validationSection = document.getElementById('validationSection');
      const mapSection = document.getElementById('map').parentElement; // Parent container of map

      const dateTime = dateData.timestamp?.toDate ? dateData.timestamp.toDate() : (new Date(dateData.createdAt) || new Date());
      const formattedDate = dateTime.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      // Use stored time field directly to avoid timezone issues
      const formattedTime = dateData.time || dateTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

      // Update Badge
      if (dateData.status === 'accepted') {
        dateStatusBadge.textContent = 'Aceptada';
        dateStatusBadge.className = 'status-validated px-4 py-2 rounded-full text-white font-semibold text-sm';
        validationSection.classList.remove('hidden');
        mapSection.classList.remove('hidden');
        // Initialize validation flow check
        initValidationFlow();
      } else if (dateData.status === 'rejected') {
        dateStatusBadge.textContent = 'Rechazada';
        dateStatusBadge.className = 'status-expired px-4 py-2 rounded-full text-white font-semibold text-sm';
        validationSection.classList.add('hidden');
        mapSection.classList.add('hidden');
      } else if (dateData.status === 'completed') {
        dateStatusBadge.textContent = 'Completada';
        dateStatusBadge.className = 'bg-blue-500 text-white px-4 py-2 rounded-full font-semibold text-sm';
        validationSection.classList.add('hidden');
        mapSection.classList.add('hidden');
      } else {
        // Pending
        dateStatusBadge.textContent = 'Pendiente';
        dateStatusBadge.className = 'status-pending px-4 py-2 rounded-full text-white font-semibold text-sm';
        validationSection.classList.add('hidden');
        mapSection.classList.add('hidden');
      }

      if (dateData.validated) {
        dateStatusBadge.textContent = 'Validada';
        validationSection.classList.add('hidden');
      }

      // Sanitize user data
      const safeAlias = sanitizer.text(dateData.otherUser?.alias || 'Usuario');
      const safeDate = sanitizer.text(formattedDate);
      const safeTime = sanitizer.text(formattedTime);
      const safeLocation = sanitizer.text(dateData.place || 'No especificado');
      const safeMessage = sanitizer.text(dateData.message || '');

      let actionButtons = '';

      // If Pending and I am the Guest -> Show Accept/Reject
      if (dateData.status === 'pending' && !dateData.isSentByMe) {
        actionButtons = `
            <div class="flex gap-4 mt-6 pt-6 border-t border-white/10">
                <button onclick="rejectDate()" class="flex-1 bg-red-500/20 hover:bg-red-500/40 text-red-100 border border-red-500/50 py-3 rounded-xl font-bold transition">
                    Rechazar
                </button>
                <button onclick="acceptDate()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition shadow-lg transform hover:scale-105">
                    Aceptar Cita
                </button>
            </div>
          `;
      } else if (dateData.status === 'pending' && dateData.isSentByMe) {
        actionButtons = `
            <div class="mt-6 pt-6 border-t border-white/10 text-center text-slate-300 italic">
                Esperando respuesta de ${safeAlias}...
            </div>
          `;
      }

      // Add Edit Button for both if not completed/rejected
      if (dateData.status !== 'completed' && dateData.status !== 'rejected') {
        actionButtons += `
            <button onclick="openEditModal()" class="w-full mt-4 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-semibold transition text-sm flex items-center justify-center border border-white/10">
                <i class="fas fa-edit mr-2"></i>Modificar Cita
            </button>
          `;
      }

      dateInfo.innerHTML = `
        <div class="bg-white bg-opacity-10 p-4 rounded-lg flex items-center gap-4">
           ${dateData.otherUser?.photoURL ?
          `<img src="${sanitizer.url(dateData.otherUser.photoURL)}" class="w-16 h-16 rounded-full object-cover">` :
          `<div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-xl">${safeAlias.charAt(0)}</div>`
        }
           <div>
              <p class="text-white text-opacity-70 text-sm">Cita con</p>
              <p class="text-white font-semibold text-lg">${safeAlias}</p>
           </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white bg-opacity-10 p-4 rounded-lg">
            <p class="text-white text-opacity-70 text-sm">Fecha</p>
            <p class="text-white font-semibold">${safeDate}</p>
          </div>

          <div class="bg-white bg-opacity-10 p-4 rounded-lg">
            <p class="text-white text-opacity-70 text-sm">Hora</p>
            <p class="text-white font-semibold">${safeTime}</p>
          </div>
        </div>

        <div class="bg-white bg-opacity-10 p-4 rounded-lg">
          <p class="text-white text-opacity-70 text-sm">Lugar</p>
          <p class="text-white font-semibold">${safeLocation}</p>
        </div>
        
        ${safeMessage ? `
        <div class="bg-white bg-opacity-5 p-4 rounded-lg">
          <p class="text-white text-opacity-70 text-sm">Mensaje</p>
          <p class="text-white italic">"${safeMessage}"</p>
        </div>` : ''}
        
        ${actionButtons}
      `;
    }

    // Custom Confirmation Modal Logic
    let pendingAction = null;

    function openConfirmationModal(title, message, action) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmationModal').classList.remove('hidden');
      pendingAction = action;
    }

    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.add('hidden');
      pendingAction = null;
    }

    document.getElementById('btnCancelConfirm').onclick = closeConfirmationModal;
    document.getElementById('btnConfirmAction').onclick = async () => {
      if (pendingAction) await pendingAction();
      closeConfirmationModal();
    };

    // Edit Logic
    window.openEditModal = function () {
      if (!dateData) return;

      let d = new Date();
      if (dateData.timestamp?.toDate) d = dateData.timestamp.toDate();
      else if (dateData.date) {
        // Fallback
      }

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      document.getElementById('editDate').value = `${yyyy}-${mm}-${dd}`;

      document.getElementById('editTime').value = dateData.time || '20:00';
      document.getElementById('editPlace').value = dateData.place || '';
      document.getElementById('editMessage').value = dateData.message || '';

      document.getElementById('editDateModal').classList.remove('hidden');

      // Initialize autocomplete for edit place with coordinate capture
      if (window.google && google.maps && google.maps.places) {
        const editPlaceInput = document.getElementById('editPlace');
        const editAutocomplete = new google.maps.places.Autocomplete(editPlaceInput, {
          fields: ['formatted_address', 'name', 'geometry']
        });

        editAutocomplete.addListener('place_changed', () => {
          const place = editAutocomplete.getPlace();
          if (place.geometry && place.geometry.location) {
            window.editPlaceCoordinates = {
              lat: place.geometry.location.lat(),
              lng: place.geometry.location.lng()
            };
            console.log('üìç Edit place coordinates:', window.editPlaceCoordinates);
          }
          if (place.formatted_address) {
            editPlaceInput.value = place.name + (place.formatted_address ? `, ${place.formatted_address}` : '');
          }
        });
      }

      // Keep existing coordinates if place not changed
      window.editPlaceCoordinates = dateData.coordinates || null;
    };

    window.saveDateChanges = async function () {
      console.log('saveDateChanges called');

      // Disable button and show loading
      const saveBtn = document.getElementById('btnSaveDateChanges');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
      }

      showToast('Guardando cambios...', 'info');

      const newDate = document.getElementById('editDate').value;
      const newTime = document.getElementById('editTime').value;
      const newPlace = document.getElementById('editPlace').value;
      const newMessage = document.getElementById('editMessage').value;

      console.log('Values:', { newDate, newTime, newPlace, newMessage, dateId });

      if (!newDate || !newTime || !newPlace) {
        showToast('Por favor completa fecha, hora y lugar', 'warning');
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = 'Guardar Cambios';
        }
        return;
      }

      try {
        const [year, month, day] = newDate.split('-').map(Number);
        const dateObj = new Date(year, month - 1, day);
        const displayDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        console.log('Updating Firestore...');
        const dateRef = doc(db, 'dates', dateId);
        await updateDoc(dateRef, {
          date: displayDate,
          time: newTime,
          place: newPlace,
          coordinates: window.editPlaceCoordinates || null,
          message: newMessage,
          timestamp: dateObj,
          status: 'pending',
          updatedAt: serverTimestamp(),
          hostValidated: false,
          guestValidated: false
        });
        console.log('Firestore update complete');

        // Send chat notification
        const conversationsRef = collection(db, 'conversations', dateData.conversationId, 'messages');
        await addDoc(conversationsRef, {
          text: `‚úèÔ∏è La cita ha sido modificada:\nüìÖ ${displayDate} a las ${newTime}\nüìç ${newPlace}`,
          senderId: currentUser.uid,
          timestamp: serverTimestamp(),
          read: false,
          type: 'text'
        });
        console.log('Chat message sent');

        // Success - close modal and reload
        document.getElementById('editDateModal').classList.add('hidden');
        showToast('‚úÖ Cita modificada correctamente', 'success');

        setTimeout(() => {
          window.location.reload();
        }, 1000);

      } catch (e) {
        console.error("Error updating date:", e);
        showToast(`Error: ${e.message}`, 'error');
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = 'Guardar Cambios';
        }
      }
    };

    // Actions for Accept/Reject
    window.acceptDate = function () {
      openConfirmationModal(
        'Aceptar Cita',
        '¬øDeseas aceptar esta cita y confirmar tu asistencia?',
        async () => {
          try {
            await updateDoc(doc(db, 'dates', dateId), {
              status: 'accepted',
              updatedAt: serverTimestamp()
            });
            showToast('Cita aceptada', 'success');
            setTimeout(() => window.location.reload(), 1000);
          } catch (e) {
            console.error(e);
            showToast('Error al aceptar', 'error');
          }
        }
      );
    };

    window.rejectDate = function () {
      openConfirmationModal(
        'Rechazar Cita',
        '¬øEst√°s seguro de que quieres rechazar esta propuesta?',
        async () => {
          try {
            await updateDoc(doc(db, 'dates', dateId), {
              status: 'rejected',
              updatedAt: serverTimestamp()
            });
            showToast('Cita rechazada', 'success');
            setTimeout(() => window.location.reload(), 1000);
          } catch (e) {
            console.error(e);
            showToast('Error al rechazar', 'error');
          }
        }
      );
    };

    // Initialize Google Map
    function initMap() {
      if (!dateData || !dateData.coordinates) {
        document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full bg-gray-800 bg-opacity-50"><p class="text-white">Ubicaci√≥n no disponible</p></div>';
        return;
      }

      const dateLocation = {
        lat: dateData.coordinates.lat,
        lng: dateData.coordinates.lng
      };

      // Create map
      map = new google.maps.Map(document.getElementById('map'), {
        center: dateLocation,
        zoom: 15,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] }
        ]
      });

      // Add marker for date location
      dateMarker = new google.maps.Marker({
        position: dateLocation,
        map: map,
        title: 'Lugar de la cita',
        icon: {
          url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        }
      });

      // Add circle showing 250m radius
      distanceCircle = new google.maps.Circle({
        map: map,
        center: dateLocation,
        radius: 250, // 250 meters
        fillColor: '#667eea',
        fillOpacity: 0.2,
        strokeColor: '#667eea',
        strokeOpacity: 0.5,
        strokeWeight: 2
      });

      // Try to get user's location
      if (navigator.geolocation) {
        console.log('GPS: Requesting geolocation...');
        navigator.geolocation.watchPosition(
          (position) => {
            console.log('GPS: Position received', position.coords);
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            // Update or create user marker
            if (userMarker) {
              userMarker.setPosition(userLocation);
            } else {
              userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Tu ubicaci√≥n',
                icon: {
                  url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                }
              });
              console.log('GPS: User marker created');
            }

            // Calculate distance
            const distance = calculateDistance(
              userLocation.lat,
              userLocation.lng,
              dateLocation.lat,
              dateLocation.lng
            );

            updateLocationStatus(distance);
          },
          (error) => {
            // Error callback - this is critical!
            console.error('GPS Error:', error.code, error.message);
            let errorMsg = 'Error de ubicaci√≥n: ';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMsg += 'Permiso denegado. Por favor habilita el GPS en ajustes.';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg += 'Ubicaci√≥n no disponible.';
                break;
              case error.TIMEOUT:
                errorMsg += 'Tiempo de espera agotado.';
                break;
              default:
                errorMsg += error.message;
            }
            showToast(errorMsg, 'error');
            document.getElementById('locationStatus').innerHTML = `
              <p class="text-red-400 text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                ${errorMsg}
              </p>
            `;
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        console.error('GPS: Geolocation not supported');
        showToast('Tu navegador no soporta geolocalizaci√≥n', 'error');
      }
    }

    // Calculate distance using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
        Math.cos(œÜ1) * Math.cos(œÜ2) *
        Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c; // Distance in meters
    }

    // Update location status
    function updateLocationStatus(distance) {
      const locationStatus = document.getElementById('locationStatus');
      const rule1 = document.getElementById('rule1');

      if (distance <= 250) {
        locationStatus.className = 'bg-green-500 bg-opacity-20 border border-green-300 border-opacity-30 rounded-lg p-4';
        locationStatus.innerHTML = `
          <p class="text-white text-sm">
            <i class="fas fa-check-circle mr-2"></i>
            ¬°Est√°s dentro del √°rea! Distancia: ${Math.round(distance)} metros
          </p>
        `;
        rule1.querySelector('i').className = 'fas fa-check-circle text-green-300 text-sm';
      } else {
        locationStatus.className = 'bg-red-500 bg-opacity-20 border border-red-300 border-opacity-30 rounded-lg p-4';
        locationStatus.innerHTML = `
          <p class="text-white text-sm">
            <i class="fas fa-exclamation-circle mr-2"></i>
            Est√°s fuera del √°rea. Distancia: ${Math.round(distance)} metros (m√°ximo: 250m)
          </p>
        `;
      }
    }

    // --- NEW VALIDATION FLOW LOGIC ---
    let distanceCheckPassed = false;
    let timeCheckPassed = false;
    let qrReader = null;

    async function initValidationFlow() {
      console.log('Validating flow initialized');
      checkConditions();

      // Listen for document updates (real-time status changes)
      onSnapshot(doc(db, 'dates', dateId), (doc) => {
        dateData = { ...doc.data(), id: doc.id };
        checkFlowState();
      });
    }

    function checkConditions() {
      // 1. Time Check (30 mins before)
      const now = new Date();
      const dateTimestamp = dateData.timestamp?.toDate ? dateData.timestamp.toDate() : new Date(dateData.date);
      // Combine date and time string to be precise if needed, or just use timestamp
      // Assuming timestamp is correct date/time

      const timeDiffMinutes = (dateTimestamp - now) / 1000 / 60;
      // Approved if: timeDiffMinutes <= 30 (starts 30 mins before, and stays active)
      // Or just simply: is it within a valid window? Let's say up to 24h after too.

      const isTimeValid = timeDiffMinutes <= 30 && timeDiffMinutes > -1440; // 30 min before to 24h after
      timeCheckPassed = isTimeValid;

      const timeStatusText = document.getElementById('timeStatusText');
      if (isTimeValid) {
        timeStatusText.textContent = 'Correcto';
        timeStatusText.className = 'text-green-300 font-bold';
        document.getElementById('timeStatus').className = 'bg-green-500 bg-opacity-20 rounded-lg p-3';
      } else {
        if (timeDiffMinutes > 30) {
          timeStatusText.textContent = `Faltan ${Math.round(timeDiffMinutes)} min`;
        } else {
          timeStatusText.textContent = 'Expirado';
        }
        timeStatusText.className = 'text-white text-opacity-70';
        document.getElementById('timeStatus').className = 'bg-white bg-opacity-10 rounded-lg p-3';
      }

      checkFlowState();
    }

    // Override updateLocationStatus to update flow state
    const originalUpdateLocationStatus = updateLocationStatus;
    updateLocationStatus = function (distance) {
      originalUpdateLocationStatus(distance);
      // Logic for flow
      distanceCheckPassed = distance <= 250;

      const locationStatusText = document.getElementById('locationStatusText');
      if (distanceCheckPassed) {
        locationStatusText.textContent = 'Correcto';
        locationStatusText.className = 'text-green-300 font-bold';
        document.getElementById('locationStatusBox').className = 'bg-green-500 bg-opacity-20 rounded-lg p-3';
      } else {
        locationStatusText.textContent = 'Fuera del √°rea';
        locationStatusText.className = 'text-white text-opacity-70';
        document.getElementById('locationStatusBox').className = 'bg-white bg-opacity-10 rounded-lg p-3';
      }

      checkFlowState();
    }

    async function checkFlowState() {
      console.log('Checking Flow State...');
      console.log('Current User Gender:', currentUserData?.gender);
      console.log('Date Data:', {
        hostPresent: dateData.hostPresent,
        guestPresent: dateData.guestPresent,
        hostId: dateData.hostId,
        guestId: dateData.guestId,
        currentUid: currentUser.uid
      });

      const isHost = dateData.hostId === currentUser.uid;
      const myPinField = isHost ? 'hostPin' : 'guestPin';
      const myPresentField = isHost ? 'hostPresent' : 'guestPresent';
      const otherPresentField = isHost ? 'guestPresent' : 'hostPresent';

      const notReadySection = document.getElementById('notReadySection');
      const confirmPresenceSection = document.getElementById('confirmPresenceSection');
      const waitingSection = document.getElementById('waitingSection');
      const qrCodeSection = document.getElementById('qrCodeSection');
      const qrScannerSection = document.getElementById('qrScannerSection');

      // Hide all first
      notReadySection.classList.add('hidden');
      confirmPresenceSection.classList.add('hidden');
      waitingSection.classList.add('hidden');
      qrCodeSection.classList.add('hidden');
      qrScannerSection.classList.add('hidden');

      // 1. Conditions check
      const SUPER_USERS = ['cesar@tucitasegura.com', 'admin@tucitasegura.com', 'cesar.herrera.rojo@gmail.com', 'gonzalo.hrrj@gmail.com', 'lacasitadebarajas@gmail.com', 'paulikacyrus@gmail.com'];
      const isSuperUser = SUPER_USERS.includes(currentUser.email);

      // Allow testing without time check check if needed, but per request:
      if (!distanceCheckPassed && !isSuperUser) {
        // Temporarily ignore timeCheckPassed for testing if needed, or keep strictly
        // For now, keep logic. If user forced testing, maybe they bypassed time/loc.
        // If distance failed, show waiting/not ready.
        console.log('Distance check failed.');
        notReadySection.classList.remove('hidden');

        // Show debug msg if superuser but logic failed? No, logic above bypasses if superUser.
        // If NOT super user, we return.
        return;
      }

      if (isSuperUser && !distanceCheckPassed) {
        showToast('‚ö†Ô∏è MODO DEBUG: Ignorando chequeo de ubicaci√≥n', 'warning');
      }
      /* // STRICT TIME CHECK DISABLED FOR TESTING
     if (!timeCheckPassed) {
         console.log('Time check failed.');
         notReadySection.classList.remove('hidden');
         return;
     } */

      // 2. Presence check
      // Have I confirmed my presence?
      const iAmPresent = dateData[myPresentField] === true;
      const otherIsPresent = dateData[otherPresentField] === true;

      console.log(`Presence: Me=${iAmPresent}, Other=${otherIsPresent}`);

      if (!iAmPresent) {
        console.log('Step: Confirm Presence');
        confirmPresenceSection.classList.remove('hidden');
        // Ensure my PIN is generated and displayed
        ensureMyPinGenerated(myPinField);
        return;
      }

      // 3. Waiting for other
      if (iAmPresent && !otherIsPresent) {
        console.log('Step: Waiting for other');
        waitingSection.classList.remove('hidden');
        return;
      }

      // 4. Both Present -> QR Phase
      if (iAmPresent && otherIsPresent) {
        console.log('Step: Both Present. Determining Role (Scan vs Show)');
        // Logic: Female Shows, Male Scans.
        // Fallback: Host Scans, Guest Shows if gender undefined.

        let shouldShowQR = false;

        if (currentUserData.gender === 'femenino') {
          shouldShowQR = true;
        } else if (currentUserData.gender === 'masculino') {
          shouldShowQR = false;
        } else {
          // Fallback based on Host/Guest if gender not clear
          // Assume Host (usually Male in this app's context?) scans.
          shouldShowQR = !isHost;
        }

        console.log(`Should Show QR? ${shouldShowQR} (Gender: ${currentUserData.gender})`);

        if (shouldShowQR) {
          qrCodeSection.classList.remove('hidden');
          generateQRCode();
        } else {
          qrScannerSection.classList.remove('hidden');
          checkCameraPermissionState();
        }
      }
    }

    async function checkCameraPermissionState() {
      const scannerSection = document.getElementById('qrScannerSection');
      // Check if we already have a permission button, if so remove it to re-eval
      const existingBtn = document.getElementById('prePermissionBtn');
      if (existingBtn) existingBtn.remove();

      try {
        // Check permissions API if available
        if (navigator.permissions && navigator.permissions.query) {
          const result = await navigator.permissions.query({ name: 'camera' });
          if (result.state === 'granted') {
            // All good - permission already granted
            showToast('‚úÖ C√°mara lista', 'success');
            return;
          } else if (result.state === 'prompt') {
            // Auto-request permission NOW
            await autoRequestCameraPermission();
          } else if (result.state === 'denied') {
            showPermissionButton(scannerSection, true);
          }
        } else {
          // Fallback: Auto-request permission
          await autoRequestCameraPermission();
        }
      } catch (e) {
        console.error('Permission check failed', e);
        // Fallback: Auto-request permission
        await autoRequestCameraPermission();
      }
    }

    async function autoRequestCameraPermission() {
      console.log('Auto-requesting camera permission...');
      showToast('üé• Solicitando acceso a la c√°mara...', 'info');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        // Got permission! Stop the stream immediately (we just needed to trigger the prompt)
        stream.getTracks().forEach(track => track.stop());
        console.log('Camera permission granted!');
        showToast('‚úÖ C√°mara habilitada', 'success');

        // Remove the permission button if it exists
        const btn = document.getElementById('prePermissionBtn');
        if (btn) btn.remove();
      } catch (err) {
        console.error('Camera permission error:', err);
        const scannerSection = document.getElementById('qrScannerSection');

        if (err.name === 'NotAllowedError') {
          showToast('üîí Permiso denegado. Pulsa el candado üîí en la barra de direcciones.', 'error');
          showPermissionButton(scannerSection, true);
        } else if (err.name === 'NotFoundError') {
          showToast('üì∑ No se detect√≥ ninguna c√°mara.', 'error');
        } else {
          showToast('Error de c√°mara: ' + err.message, 'error');
          showPermissionButton(scannerSection, false);
        }
      }
    }

    function showPermissionButton(container, denied = false) {
      // Create a dedicated container for this if doesn't exist?
      // Just append to container (qrScannerSection) before the scanner div

      const btnId = 'prePermissionBtn';
      if (document.getElementById(btnId)) return;

      const btn = document.createElement('div');
      btn.id = btnId;
      btn.className = 'mb-4 bg-white bg-opacity-10 p-4 rounded-xl text-center';

      if (denied) {
        btn.innerHTML = `
                <p class="text-red-300 mb-2"><i class="fas fa-lock mr-2"></i>Acceso a c√°mara bloqueado</p>
                <p class="text-white text-sm opacity-80 mb-3">Pulsa el icono del candado üîí en la barra de direcciones para permitir el acceso.</p>
            `;
      } else {
        btn.innerHTML = `
                <p class="text-white mb-3"><i class="fas fa-camera mr-2"></i>Necesitamos acceso a tu c√°mara para escanear</p>
                <button onclick="requestCameraAccess()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg font-bold transition">
                    Habilitar C√°mara
                </button>
            `;
      }

      // Insert before qrReader
      const ref = document.getElementById('qrReader');
      container.insertBefore(btn, ref);
    }

    window.requestCameraAccess = async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        // Got it! Stop it immediately
        stream.getTracks().forEach(track => track.stop());

        showToast('‚úÖ C√°mara habilitada', 'success');
        const btn = document.getElementById('prePermissionBtn');
        if (btn) btn.remove();

      } catch (err) {
        console.error('Pre-check error:', err);
        let msg = 'Error: ' + err.message;
        if (err.name === 'NotAllowedError' || err.toString().includes('Permission')) {
          showPermissionButton(document.getElementById('qrScannerSection'), true);
          msg = 'Permiso denegado. Revisa el candado üîí';
        }
        showToast(msg, 'error');
      }
    };

    // ... (ensureMyPinGenerated hidden for brevity, unchanged) ...

    // ... (confirmPresenceBtn listener hidden for brevity, unchanged) ...

    // Generate QR Code
    function generateQRCode() {
      const qrData = JSON.stringify({
        dateId: dateId,
        action: 'validate_date',
        timestamp: Date.now()
      });

      console.log('Generating QR for data:', qrData);
      const canvas = document.getElementById('qrCanvas');

      if (typeof QRCode === 'undefined') {
        console.error('QRCode library not loaded!');
        showToast('Error: Librer√≠a QR no cargada', 'error');
        return;
      }

      QRCode.toCanvas(canvas, qrData, { width: 200 }, function (error) {
        if (error) console.error('QR Generation Error:', error);
        else console.log('QR Code generated successfully');
      });
    }

    // Start Scanner
    document.getElementById('startScanBtn').addEventListener('click', () => {
      // Toggle scanner
      if (qrReader) {
        // Stop
        qrReader.stop().then(() => {
          qrReader.clear();
          qrReader = null;
          document.getElementById('startScanBtn').innerHTML = '<i class="fas fa-qrcode mr-2"></i>Abrir esc√°ner';
        }).catch(err => console.error(err));
        return;
      }

      // Check if library is loaded
      if (typeof Html5Qrcode === 'undefined') {
        console.error('Html5Qrcode library not loaded!');
        showToast('Error: Librer√≠a del esc√°ner no cargada. Recarga la p√°gina.', 'error');
        return;
      }

      showToast('Inicializando c√°mara...', 'info');
      console.log('Creating Html5Qrcode instance...');

      const html5QrCode = new Html5Qrcode("qrReader");
      qrReader = html5QrCode;

      document.getElementById('startScanBtn').innerHTML = '<i class="fas fa-stop mr-2"></i>Detener esc√°ner';

      console.log('Calling html5QrCode.start()...');
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        async (decodedText, decodedResult) => {
          console.log('QR Scanned:', decodedText);
          // Verify
          try {
            const data = JSON.parse(decodedText);
            if (data.dateId === dateId && data.action === 'validate_date') {
              // SUCCESS!
              console.log('QR Validated!');
              html5QrCode.stop();
              await completeDateValidation();
            } else {
              showToast('C√≥digo QR inv√°lido para esta cita', 'error');
              console.warn('Invalid QR content:', data);
            }
          } catch (e) {
            console.error(e);
            showToast('Error leyendo QR (Formato inv√°lido)', 'error');
          }
        },
        (errorMessage) => {
          // ignore
        })
        .catch((err) => {
          console.error('Camera Start Error:', err);
          let msg = 'Error de c√°mara: ' + err;
          if (err.name === 'NotAllowedError' || err.toString().includes('Permission')) {
            msg = 'üîí Permiso denegado. Pulsa en el icono del candado en la barra de direcci√≥n y permite el acceso a la c√°mara.';
            showPermissionButton(document.getElementById('qrScannerSection'), true);
          } else if (err.name === 'NotFoundError') {
            msg = 'üì∑ No se detect√≥ ninguna c√°mara.';
          } else if (err.name === 'NotReadableError') {
            msg = '‚ö†Ô∏è La c√°mara est√° en uso por otra aplicaci√≥n.';
          }
          showToast(msg, 'error');
          alert(msg); // Alert to be very visible

          // Clean up UI
          qrReader = null;
          document.getElementById('startScanBtn').innerHTML = '<i class="fas fa-qrcode mr-2"></i>Abrir esc√°ner';
        });
    });

    async function completeDateValidation() {
      // ... (unchanged)
      showToast('Validando cita...', 'info');
      try {
        await updateDoc(doc(db, 'dates', dateId), {
          status: 'completed',
          completedAt: serverTimestamp(),
          hostValidated: true,
          guestValidated: true
        });

        // Payments
        const paymentsQuery = query(
          collection(db, 'payments'),
          where('dateId', '==', dateId),
          where('type', '==', 'deposit')
        );
        const paymentsSnapshot = await getDocs(paymentsQuery);
        paymentsSnapshot.forEach(async (paymentDoc) => {
          await updateDoc(doc(db, 'payments', paymentDoc.id), {
            status: 'completed',
            completedAt: serverTimestamp()
          });
        });

        // Show success
        document.getElementById('successModal').classList.remove('opacity-0', 'pointer-events-none');
        document.getElementById('successModal').classList.add('opacity-100');

      } catch (e) {
        console.error('Validation Error:', e);
        showToast('Error finalizando validaci√≥n', 'error');
      }
    }

    // Close success modal
    document.getElementById('closeSuccessModal').addEventListener('click', () => {
      window.location.href = '/conversaciones.html';
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Error signing out:', error);
        showToast('Error al cerrar sesi√≥n', 'error');
      }
    });


    // Setup PIN inputs (Global scope)
    function setupPinInputs() {
      const inputs = [
        document.getElementById('pin1'),
        document.getElementById('pin2'),
        document.getElementById('pin3'),
        document.getElementById('pin4')
      ];

      inputs.forEach((input, index) => {
        if (!input) return;

        input.addEventListener('input', (e) => {
          if (e.target.value.length === 1) {
            if (index < inputs.length - 1) {
              inputs[index + 1].focus();
            }
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && e.target.value === '') {
            if (index > 0) {
              inputs[index - 1].focus();
            }
          }
        });

        // Allow only numbers
        input.addEventListener('keypress', (e) => {
          if (!/[0-9]/.test(e.key)) {
            e.preventDefault();
          }
        });
      });
    }

    // Wire up save button for edit modal
    const saveDateBtn = document.getElementById('btnSaveDateChanges');
    if (saveDateBtn) {
      saveDateBtn.addEventListener('click', async () => {
        console.log('Save button clicked');
        await saveDateChanges();
      });
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');

      toastMessage.textContent = message;

      if (type === 'success') {
        toastIcon.className = 'fas fa-check-circle text-green-400 text-2xl';
      } else if (type === 'error') {
        toastIcon.className = 'fas fa-exclamation-circle text-red-400 text-2xl';
      } else if (type === 'warning') {
        toastIcon.className = 'fas fa-exclamation-triangle text-yellow-400 text-2xl';
      } else if (type === 'info') {
        toastIcon.className = 'fas fa-info-circle text-blue-400 text-2xl';
      }

      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, 4000);
    }
  </script>

  <script type="module" src="./js/legal-consent.js"></script>
</body>

</html>