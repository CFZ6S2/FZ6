<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limpiar Usuarios Semilla - TuCitaSegura</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0369a1 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .warning-box {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .user-list {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .user-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      flex: 1;
    }

    .user-email {
      font-weight: bold;
      color: #60a5fa;
    }

    .user-alias {
      color: #cbd5e1;
      margin-top: 5px;
    }

    .seed-badge {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 10px;
    }

    button {
      background: linear-gradient(to right, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .delete-btn {
      background: linear-gradient(to right, #dc2626, #b91c1c);
      margin-left: 10px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #60a5fa;
    }

    .stat-label {
      color: #cbd5e1;
      margin-top: 5px;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid rgba(34, 197, 94, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üßπ Limpiar Usuarios Semilla</h1>
      <p>Elimina usuarios de prueba, demo y semilla de la base de datos</p>
    </div>

    <div class="warning-box">
      <strong>‚ö†Ô∏è ADVERTENCIA:</strong> Esta acci√≥n es IRREVERSIBLE. Se eliminar√°n permanentemente todos los usuarios identificados como semilla/demo/prueba.
    </div>

    <div id="stats" class="stats"></div>

    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Cargando usuarios...</p>
    </div>

    <div id="userList" class="user-list"></div>

    <div class="actions">
      <button id="loadBtn" onclick="loadUsers()">üîç Buscar Usuarios Semilla</button>
      <button id="deleteAllBtn" onclick="deleteAllSeedUsers()" disabled style="background: linear-gradient(to right, #dc2626, #991b1b);">
        üóëÔ∏è Eliminar TODOS los Usuarios Semilla
      </button>
    </div>

    <div id="result"></div>
  </div>

  <script type="module">
    import './js/firebase-appcheck.js';
    import { auth, db } from './js/firebase-config-env.js';
    import { onAuthStateChanged } from "firebase/auth";
    import { collection, getDocs, deleteDoc, doc, query, where, or } from "firebase/firestore";
    import { signInAnonymously } from "firebase/auth";

    let currentUser = null;
    let seedUsers = [];

    // Patterns to identify seed/demo users
    const SEED_PATTERNS = {
      email: [
    /^demo/i,
    /^test/i,
    /^seed/i,
    /@example\./i,
    /@test\./i,
    /@demo\./i,
    /usuario.*test/i,
    /user.*test/i
      ],
      alias: [
    /^demo/i,
    /^test/i,
    /^seed/i,
    /usuario.*prueba/i,
    /usuario.*test/i,
    /test.*user/i,
    /demo.*user/i,
    /ejemplo/i
      ],
      uid: [
    /^demo_/i,
    /^test_/i,
    /^seed_/i,
    /_demo$/i,
    /_test$/i
      ]
    };

    function isSeedUser(userDoc) {
      const data = userDoc.data();
      const id = userDoc.id;

      // Check email patterns
      if (data.email) {
        if (SEED_PATTERNS.email.some(pattern => pattern.test(data.email))) {
          return { isSeed: true, reason: 'Email coincide con patr√≥n de semilla' };
        }
      }

      // Check alias patterns
      if (data.alias) {
        if (SEED_PATTERNS.alias.some(pattern => pattern.test(data.alias))) {
          return { isSeed: true, reason: 'Alias coincide con patr√≥n de semilla' };
        }
      }

      // Check UID patterns
      if (SEED_PATTERNS.uid.some(pattern => pattern.test(id))) {
        return { isSeed: true, reason: 'UID coincide con patr√≥n de semilla' };
      }

      // Check for common demo/test aliases
      const commonDemoAliases = [
        'Demo User', 'Test User', 'Usuario Demo', 'Usuario Test',
        'Ejemplo', 'Prueba', 'Test', 'Demo'
      ];
      if (data.alias && commonDemoAliases.includes(data.alias.trim())) {
        return { isSeed: true, reason: 'Alias com√∫n de demo/test' };
      }

      // Check if email contains specific domains
      if (data.email && (data.email.includes('@example') || data.email.includes('@test') || data.email.includes('@demo'))) {
        return { isSeed: true, reason: 'Dominio de email de prueba' };
      }

      return { isSeed: false };
    }

    window.loadUsers = async function() {
      const loadingEl = document.getElementById('loading');
      const userListEl = document.getElementById('userList');
      const loadBtn = document.getElementById('loadBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const statsEl = document.getElementById('stats');

      loadingEl.style.display = 'block';
      userListEl.innerHTML = '';
      loadBtn.disabled = true;
      deleteAllBtn.disabled = true;
      seedUsers = [];

      try {
        // Get all users
        const usersRef = collection(db, 'users');
        const querySnapshot = await getDocs(usersRef);

        console.log(`üìä Total usuarios en Firestore: ${querySnapshot.size}`);

        let totalUsers = 0;
        let seedCount = 0;

        querySnapshot.forEach((doc) => {
          totalUsers++;
          const seedCheck = isSeedUser(doc);
          if (seedCheck.isSeed) {
            seedCount++;
            seedUsers.push({
              id: doc.id,
              data: doc.data(),
              reason: seedCheck.reason
            });
          }
        });

        console.log(`üîç Usuarios semilla encontrados: ${seedCount}`);

        // Update stats
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${totalUsers}</div>
            <div class="stat-label">Total Usuarios</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${seedCount}</div>
            <div class="stat-label">Usuarios Semilla</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${totalUsers - seedCount}</div>
            <div class="stat-label">Usuarios Reales</div>
          </div>
        `;

        // Display seed users
        if (seedUsers.length === 0) {
          userListEl.innerHTML = '<p style="text-align: center; padding: 20px;">‚úÖ No se encontraron usuarios semilla</p>';
        } else {
          userListEl.innerHTML = seedUsers.map((user, index) => `
            <div class="user-item">
              <div class="user-info">
                <div class="user-email">
                  ${user.data.email || 'Sin email'} 
                  <span class="seed-badge">SEMILLA</span>
                </div>
                <div class="user-alias">Alias: ${user.data.alias || 'Sin alias'} | ID: ${user.id}</div>
                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                  ${user.reason}
                </div>
              </div>
              <button class="delete-btn" onclick="deleteUser('${user.id}', ${index})">Eliminar</button>
            </div>
          `).join('');
        }

        deleteAllBtn.disabled = seedUsers.length === 0;

      } catch (error) {
        console.error('Error loading users:', error);
        userListEl.innerHTML = `<p style="color: #fca5a5;">‚ùå Error: ${error.message}</p>`;
      } finally {
        loadingEl.style.display = 'none';
        loadBtn.disabled = false;
      }
    };

    window.deleteUser = async function(userId, index) {
      if (!confirm(`¬øEst√°s seguro de eliminar este usuario?\nID: ${userId}`)) {
        return;
      }

      try {
        const userRef = doc(db, 'users', userId);
        await deleteDoc(userRef);
        
        // Remove from list
        seedUsers.splice(index, 1);
        
        // Reload list
        await window.loadUsers();
        
        document.getElementById('result').innerHTML = `
          <div class="success">
            ‚úÖ Usuario eliminado correctamente: ${userId}
          </div>
        `;
        
        setTimeout(() => {
          document.getElementById('result').innerHTML = '';
        }, 3000);
      } catch (error) {
        console.error('Error deleting user:', error);
        alert(`Error al eliminar usuario: ${error.message}`);
      }
    };

    window.deleteAllSeedUsers = async function() {
      if (!confirm(`¬øEst√°s SEGURO de eliminar TODOS los ${seedUsers.length} usuarios semilla?\n\nEsta acci√≥n es IRREVERSIBLE.`)) {
        return;
      }

      if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Esto eliminar√° permanentemente todos los usuarios semilla. ¬øContinuar?')) {
        return;
      }

      const loadingEl = document.getElementById('loading');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      
      loadingEl.style.display = 'block';
      deleteAllBtn.disabled = true;

      let deleted = 0;
      let errors = 0;

      for (const user of seedUsers) {
        try {
          const userRef = doc(db, 'users', user.id);
          await deleteDoc(userRef);
          deleted++;
          console.log(`‚úÖ Eliminado: ${user.id}`);
        } catch (error) {
          errors++;
          console.error(`‚ùå Error eliminando ${user.id}:`, error);
        }
      }

      loadingEl.style.display = 'none';
      deleteAllBtn.disabled = false;

      document.getElementById('result').innerHTML = `
        <div class="success">
          <h3>‚úÖ Proceso completado</h3>
          <p>Eliminados: ${deleted} usuarios</p>
          <p>Errores: ${errors} usuarios</p>
        </div>
      `;

      // Reload list
      await window.loadUsers();
    };

    // Auto-authenticate and load users
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        console.log('‚úÖ Autenticado:', user.uid);
        await window.loadUsers();
      } else {
        try {
          // Try anonymous auth for admin operations
          const cred = await signInAnonymously(auth);
          currentUser = cred.user;
          console.log('‚úÖ Autenticado an√≥nimamente');
        } catch (error) {
          console.error('Error en autenticaci√≥n:', error);
          document.getElementById('result').innerHTML = `
            <div class="warning-box">
              ‚ùå Error de autenticaci√≥n: ${error.message}<br>
              Por favor, inicia sesi√≥n en la aplicaci√≥n primero.
            </div>
          `;
        }
      }
    });
  </script>
</body>
</html>
