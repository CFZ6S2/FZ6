<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - TuCitaSegura</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#764ba2">

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .profile-photo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255, 255, 255, 0.3);
    }

    .photo-placeholder {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      font-weight: bold;
      color: white;
      border: 4px solid rgba(255, 255, 255, 0.3);
    }

    input, select, textarea {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      background: rgba(255, 255, 255, 0.15);
    }

    select option {
      background: #1e293b;
      color: white;
    }

    .label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
      color: #e2e8f0;
    }

    /* Map Styles */
    #locationMap {
      height: 300px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .location-button {
      background: rgba(102, 126, 234, 0.9);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .location-button:hover {
      background: rgba(102, 126, 234, 1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .location-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="text-white">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4"></div>
      <p class="text-xl font-semibold">Cargando perfil...</p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="opacity-0 pointer-events-none fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8 text-center">
      <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check-circle text-5xl text-green-400"></i>
      </div>
      <h3 class="text-3xl font-bold mb-4">¬°Perfil Actualizado!</h3>
      <p class="text-slate-200 mb-6">Tus cambios han sido guardados exitosamente.</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button onclick="goToSearch()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition">
          Buscar
        </button>
        <button onclick="closeSuccessModal()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition">
          Seguir aqu√≠
        </button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <nav class="glass-strong sticky top-0 z-50 border-b border-white/20">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/webapp/buscar-usuarios.html" class="text-white/80 hover:text-white transition">
            <i class="fas fa-arrow-left text-xl"></i>
          </a>
          <h1 class="text-2xl font-bold">
            <i class="fas fa-user-circle mr-2"></i>
            Mi Perfil
          </h1>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">

    <!-- Profile Photo Section -->
    <div class="glass-strong rounded-2xl p-8 mb-6">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3 text-center justify-center">
        <i class="fas fa-images text-purple-400"></i>
        Fotos de Perfil
      </h3>

      <!-- Avatar Principal -->
      <div class="text-center mb-6">
        <label class="text-white font-semibold mb-2 block">Avatar Principal (Obligatorio)</label>
        <div class="flex flex-col items-center">
          <div class="mb-4 relative">
            <img id="profilePhoto" class="profile-photo hidden" src="" alt="Foto de perfil">
            <div id="photoPlaceholder" class="photo-placeholder">
              <span id="photoInitial">U</span>
            </div>
            <button type="button" onclick="document.getElementById('photoInput').click()" class="absolute bottom-0 right-0 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 w-12 h-12 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-camera text-xl"></i>
            </button>
            <input type="file" id="photoInput" accept="image/*" class="hidden">
          </div>
          <h2 id="userName" class="text-2xl font-bold mb-2">Usuario</h2>
          <p class="text-slate-300" id="userEmail">email@example.com</p>
        </div>
      </div>

      <!-- Galer√≠a de Fotos Adicionales -->
      <div class="mt-8">
        <label class="text-white font-semibold mb-2 block text-center">
          Galer√≠a de Fotos (M√≠nimo 2 obligatorias, m√°ximo 5)
        </label>
        <p class="text-sm text-slate-300 text-center mb-4">
          <i class="fas fa-info-circle mr-1"></i>
          Sube al menos 2 fotos adicionales para completar tu perfil
        </p>

        <div class="grid grid-cols-3 md:grid-cols-5 gap-4">
          <!-- Gallery Photo 1 -->
          <div class="relative aspect-square">
            <div id="galleryPreview1" class="w-full h-full rounded-xl border-2 border-dashed border-white/30 flex items-center justify-center cursor-pointer hover:border-white/60 transition bg-white/5">
              <i class="fas fa-plus text-white/50 text-2xl"></i>
            </div>
            <img id="galleryImage1" class="hidden w-full h-full rounded-xl object-cover" src="" alt="Foto 1">
            <button type="button" id="galleryRemove1" class="opacity-0 pointer-events-none absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-times text-white"></i>
            </button>
            <input type="file" id="galleryInput1" accept="image/*" class="hidden">
          </div>

          <!-- Gallery Photo 2 -->
          <div class="relative aspect-square">
            <div id="galleryPreview2" class="w-full h-full rounded-xl border-2 border-dashed border-white/30 flex items-center justify-center cursor-pointer hover:border-white/60 transition bg-white/5">
              <i class="fas fa-plus text-white/50 text-2xl"></i>
            </div>
            <img id="galleryImage2" class="hidden w-full h-full rounded-xl object-cover" src="" alt="Foto 2">
            <button type="button" id="galleryRemove2" class="opacity-0 pointer-events-none absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-times text-white"></i>
            </button>
            <input type="file" id="galleryInput2" accept="image/*" class="hidden">
          </div>

          <!-- Gallery Photo 3 -->
          <div class="relative aspect-square">
            <div id="galleryPreview3" class="w-full h-full rounded-xl border-2 border-dashed border-white/30 flex items-center justify-center cursor-pointer hover:border-white/60 transition bg-white/5">
              <i class="fas fa-plus text-white/50 text-2xl"></i>
            </div>
            <img id="galleryImage3" class="hidden w-full h-full rounded-xl object-cover" src="" alt="Foto 3">
            <button type="button" id="galleryRemove3" class="opacity-0 pointer-events-none absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-times text-white"></i>
            </button>
            <input type="file" id="galleryInput3" accept="image/*" class="hidden">
          </div>

          <!-- Gallery Photo 4 -->
          <div class="relative aspect-square">
            <div id="galleryPreview4" class="w-full h-full rounded-xl border-2 border-dashed border-white/30 flex items-center justify-center cursor-pointer hover:border-white/60 transition bg-white/5">
              <i class="fas fa-plus text-white/50 text-2xl"></i>
            </div>
            <img id="galleryImage4" class="hidden w-full h-full rounded-xl object-cover" src="" alt="Foto 4">
            <button type="button" id="galleryRemove4" class="opacity-0 pointer-events-none absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-times text-white"></i>
            </button>
            <input type="file" id="galleryInput4" accept="image/*" class="hidden">
          </div>

          <!-- Gallery Photo 5 -->
          <div class="relative aspect-square">
            <div id="galleryPreview5" class="w-full h-full rounded-xl border-2 border-dashed border-white/30 flex items-center justify-center cursor-pointer hover:border-white/60 transition bg-white/5">
              <i class="fas fa-plus text-white/50 text-2xl"></i>
            </div>
            <img id="galleryImage5" class="hidden w-full h-full rounded-xl object-cover" src="" alt="Foto 5">
            <button type="button" id="galleryRemove5" class="opacity-0 pointer-events-none absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg">
              <i class="fas fa-times text-white"></i>
            </button>
            <input type="file" id="galleryInput5" accept="image/*" class="hidden">
          </div>
        </div>

        <div class="mt-4 bg-yellow-500/20 border border-yellow-300/30 rounded-lg p-3">
          <p class="text-white text-sm text-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Obligatorio:</strong> Debes subir al menos 2 fotos adicionales adem√°s del avatar
          </p>
        </div>
      </div>
    </div>

    <!-- Personal Information -->
    <div class="glass-strong rounded-2xl p-8 mb-6">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
        <i class="fas fa-id-card text-purple-400"></i>
        Informaci√≥n Personal
      </h3>

      <form id="profileForm" class="space-y-6">

        <!-- Hidden fields for compatibility -->
        <input type="hidden" id="firstName" value="">
        <input type="hidden" id="lastName" value="">
        <input type="hidden" id="email" value="">
        <input type="hidden" id="edad" value="">
        <input type="hidden" id="municipio" value="">
        <input type="hidden" id="interes" value="">

        <!-- Alias -->
        <div>
          <label class="label">
            <i class="fas fa-user text-purple-400 mr-2"></i>
            Nombre de Usuario (Alias)
          </label>
          <input
            type="text"
            id="alias"
            class="w-full px-4 py-3 rounded-xl bg-slate-700"
            placeholder="Tu nombre de usuario"
            required
            minlength="3"
            maxlength="30"
          >
          <p class="text-xs text-slate-400 mt-2">
            <i class="fas fa-info-circle mr-1"></i>
            Este nombre ser√° visible para otros usuarios.
          </p>
        </div>

        <!-- Fecha de Nacimiento -->
        <div>
          <label class="label">
            <i class="fas fa-calendar text-purple-400 mr-2"></i>
            Fecha de Nacimiento
          </label>
          <input
            type="date"
            id="birthDate"
            class="w-full px-4 py-3 rounded-xl"
            required
          >
        </div>

        <!-- G√©nero -->
        <div>
          <label class="label">
            <i class="fas fa-venus-mars text-purple-400 mr-2"></i>
            G√©nero
          </label>
          <select id="gender" class="w-full px-4 py-3 rounded-xl bg-slate-700" required>
            <option value="">Selecciona tu g√©nero</option>
            <option value="masculino">Masculino</option>
            <option value="femenino">Femenino</option>
          </select>
          <div class="mt-2 p-3 bg-blue-500/20 border border-blue-400/30 rounded-lg">
            <p class="text-xs text-blue-300">
              <i class="fas fa-info-circle mr-1"></i>
              <strong>Plataforma exclusivamente heterosexual:</strong> Los hombres solo ver√°n mujeres y las mujeres solo ver√°n hombres
            </p>
          </div>
        </div>

        <!-- Municipio con Mapa -->
        <div>
          <label class="label">
            <i class="fas fa-map-marker-alt text-purple-400 mr-2"></i>
            Ubicaci√≥n (Municipio)
          </label>
          <div class="space-y-3">
            <input
              type="text"
              id="city"
              class="w-full px-4 py-3 rounded-xl"
              placeholder="Tu municipio"
              required
              readonly
            >
            <input type="hidden" id="latitude" value="">
            <input type="hidden" id="longitude" value="">

            <button type="button" id="getLocationBtn" class="location-button w-full justify-center">
              <i class="fas fa-location-crosshairs"></i>
              Usar mi ubicaci√≥n actual
            </button>

            <div id="locationMap" class="hidden"></div>

            <p class="text-xs text-slate-400">
              <i class="fas fa-shield-halved mr-1"></i>
              <strong>Privacidad protegida:</strong> Solo se mostrar√° tu municipio, nunca tu direcci√≥n exacta
            </p>
          </div>
        </div>

        <!-- Profesi√≥n -->
        <div>
          <label class="label">
            <i class="fas fa-briefcase text-purple-400 mr-2"></i>
            ¬øA Qu√© Te Dedicas?
          </label>
          <input
            type="text"
            id="profession"
            class="w-full px-4 py-3 rounded-xl"
            placeholder="Tu profesi√≥n u ocupaci√≥n"
            required
          >
        </div>

        <!-- Autodescripci√≥n -->
        <div>
          <label class="label">
            <i class="fas fa-pen text-purple-400 mr-2"></i>
            Autodescripci√≥n
          </label>
          <textarea
            id="bio"
            rows="6"
            class="w-full px-4 py-3 rounded-xl resize-none"
            placeholder="Escribe una descripci√≥n sobre ti, tus intereses, qu√© te gusta hacer, qu√© buscas... (M√≠nimo 100 caracteres)"
            minlength="100"
          ></textarea>
          <p class="text-xs text-slate-400 mt-2">
            <span id="bioCharCount">0</span> caracteres
            <span id="bioMinWarning" class="text-yellow-400 hidden"> - <i class="fas fa-exclamation-triangle"></i> M√≠nimo 100 caracteres</span>
            <span id="bioMinSuccess" class="text-green-400 hidden"> - <i class="fas fa-check-circle"></i> Descripci√≥n completa</span>
          </p>
        </div>

      </form>
    </div>

    <!-- Relationship Status & Preferences -->
    <div class="glass-strong rounded-2xl p-8 mb-6">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
        <i class="fas fa-heart text-pink-400"></i>
        Estado Sentimental y Preferencias
      </h3>

      <div class="space-y-6">

        <!-- Estado Sentimental -->
        <div>
          <label class="label">
            <i class="fas fa-heart-pulse text-pink-400 mr-2"></i>
            Estado Sentimental
          </label>
          <select id="relationshipStatus" class="w-full px-4 py-3 rounded-xl" required>
            <option value="">Selecciona tu estado</option>
            <option value="felizmente_separado">Felizmente Separado o Divorciado</option>
            <option value="casado_golfo">Casado y Golfo</option>
            <option value="viudo">Viudo</option>
            <option value="libre_pajaro">Libre como un P√°jaro</option>
            <option value="no_contestar">Prefiero No Contestar</option>
            <option value="builder">Builder</option>
          </select>
        </div>

        <!-- Qu√© Busca -->
        <div>
          <label class="label">
            <i class="fas fa-search-heart text-pink-400 mr-2"></i>
            ¬øQu√© Buscas?
          </label>
          <select id="lookingFor" class="w-full px-4 py-3 rounded-xl" required>
            <option value="">Selecciona qu√© buscas</option>
            <option value="relacion_seria">Relaci√≥n Seria / A Largo Plazo</option>
            <option value="relacion_casual">Relaci√≥n Casual / Espor√°dica</option>
            <option value="amistad">Amistad</option>
            <option value="conocer_gente">Conocer Gente Nueva</option>
            <option value="sin_compromiso">Citas sin Compromiso</option>
            <option value="abierto">Abierto a Posibilidades</option>
          </select>
        </div>

        <!-- Rango de Edad Preferido -->
        <div>
          <label class="label">
            <i class="fas fa-user-friends text-pink-400 mr-2"></i>
            Rango de Edad que Buscas
          </label>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-300 mb-2 block">Edad m√≠nima</label>
              <input
                type="number"
                id="ageRangeMin"
                min="18"
                max="99"
                class="w-full px-4 py-3 rounded-xl"
                placeholder="18"
              >
            </div>
            <div>
              <label class="text-sm text-slate-300 mb-2 block">Edad m√°xima</label>
              <input
                type="number"
                id="ageRangeMax"
                min="18"
                max="99"
                class="w-full px-4 py-3 rounded-xl"
                placeholder="99"
              >
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Theme Selection -->
    <div class="glass-strong rounded-2xl p-8 mb-6">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
        <i class="fas fa-palette text-pink-400"></i>
        Personalizaci√≥n
      </h3>

      <div class="space-y-4">
        <label class="label">
          <i class="fas fa-brush text-pink-400 mr-2"></i>
          Tema de Color
        </label>
        <p class="text-sm text-slate-300 mb-4">
          Elige el esquema de colores que m√°s te guste para personalizar tu experiencia
        </p>

        <div id="themeSelector" class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <!-- Theme options will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="flex gap-4">
      <button
        type="button"
        onclick="window.location.href='/webapp/buscar-usuarios.html'"
        class="flex-1 glass hover:glass-strong text-white font-bold py-4 px-6 rounded-xl transition"
      >
        Cancelar
      </button>
      <button
        id="saveButton"
        onclick="saveProfile()"
        class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-xl transition"
      >
        <i class="fas fa-save mr-2"></i>
        Guardar Cambios
      </button>
    </div>

    <!-- Delete Account Section -->
    <div class="mt-8 glass-strong rounded-2xl p-6 border-2 border-red-500/30">
      <h4 class="font-bold text-red-400 mb-3">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        Zona Peligrosa
      </h4>
      <p class="text-sm text-slate-300 mb-4">
        Una vez que elimines tu cuenta, no hay vuelta atr√°s. Por favor, estate seguro.
      </p>
      <button
        onclick="confirmDeleteAccount()"
        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm"
      >
        <i class="fas fa-trash mr-2"></i>
        Eliminar mi Cuenta
      </button>
    </div>

  </div>

  <!-- Error Fixes -->
  <script type="module" src="./js/error-fixes.js"></script>

  <!-- DOMPurify for XSS Protection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script type="module" src="./js/sanitizer.js"></script>

  <!-- Demo Mode Banner -->
  <script type="module" src="./js/demo-banner.js"></script>

  <script>
    if (!window.GOOGLE_MAPS_API_KEY) {
      try { window.GOOGLE_MAPS_API_KEY = localStorage.getItem('GOOGLE_MAPS_API_KEY') || ''; } catch {}
    }
  </script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, db, storage } from './js/firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { showToast, validateProfileComplete } from './js/utils.js';
    import { themes, applyTheme, loadTheme, saveThemeToFirestore } from './js/theme.js';
    import { logger } from './js/logger.js';
    import { setupGlobalErrorHandling } from './js/error-handler.js';
    import { initializeNotifications } from './js/notifications-safe.js';
    import { isDemoMode, getDemoUser, getDemoAuthState } from './js/demo-mode.js';
    import { GOOGLE_MAPS_API_KEY, MAP_CONFIG, GEOCODING_CONFIG } from './js/google-maps-config.js';
    import { fileValidator, showValidationErrors } from './js/file-validator.js';

    // Image optimization with lazy loading
    import './js/image-optimizer.js';

    // Setup global error handling
    setupGlobalErrorHandling();

    // Check if user was redirected due to incomplete profile
    const urlParams = new URLSearchParams(window.location.search);
    const isIncomplete = urlParams.get('incomplete') === 'true';
    const returnUrl = urlParams.get('returnUrl');

    if (isIncomplete) {
      setTimeout(() => {
        showToast('‚ö†Ô∏è Debes completar tu perfil para acceder al chat', 'warning');
        showToast('üìù Por favor completa todos los campos requeridos', 'info');
      }, 500);
    }

    let currentUser = null;
    let currentUserData = null;
    let photoFile = null;
    let galleryFiles = [null, null, null, null, null]; // 5 gallery photos
    let selectedTheme = 'purple';
    let isLoadingProfile = false; // PREVENT INFINITE LOOP
    let hasLoadedProfile = false; // TRACK IF PROFILE ALREADY LOADED

    // Map variables
    let map = null;
    let marker = null;
    let geocoder = null;
    let userLatitude = null;
    let userLongitude = null;
    let googleMapsLoaded = false;

    // Load Google Maps API dynamically
    function loadGoogleMapsAPI() {
      return new Promise((resolve, reject) => {
        if (googleMapsLoaded) {
          resolve();
          return;
        }

        if (GOOGLE_MAPS_API_KEY === 'TU_API_KEY_AQUI') {
          const errorMsg = '‚ö†Ô∏è IMPORTANTE: Configura tu Google Maps API Key en /webapp/js/google-maps-config.js';
          console.error(errorMsg);
          showToast('Configura la API Key de Google Maps', 'error');
          reject(new Error(errorMsg));
          return;
        }

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=es&region=ES`;
        script.async = true;
        script.defer = true;
        script.onload = () => {
          googleMapsLoaded = true;
          geocoder = new google.maps.Geocoder();
          resolve();
        };
        script.onerror = () => {
          reject(new Error('Error al cargar Google Maps API'));
        };
        document.head.appendChild(script);
      });
    }

    // Initialize map with Google Maps
    async function initializeMap(lat, lon) {
      const mapContainer = document.getElementById('locationMap');

      try {
        // Load Google Maps API if not loaded
        await loadGoogleMapsAPI();

        // Show map container
        mapContainer.classList.remove('hidden');

        // If map already exists, update the view
        if (map) {
          const newPosition = new google.maps.LatLng(lat, lon);
          map.setCenter(newPosition);
          if (marker) {
            marker.setPosition(newPosition);
          } else {
            createMarker(lat, lon);
          }
          return;
        }

        // Create new map
        map = new google.maps.Map(mapContainer, {
          center: { lat: lat, lng: lon },
          zoom: MAP_CONFIG.zoom,
          mapTypeId: MAP_CONFIG.mapTypeId,
          gestureHandling: MAP_CONFIG.gestureHandling,
          styles: MAP_CONFIG.styles,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: false
        });

        // Create marker
        createMarker(lat, lon);

        // Update location when map is clicked
        map.addListener('click', async (event) => {
          const clickedLat = event.latLng.lat();
          const clickedLng = event.latLng.lng();

          marker.setPosition(event.latLng);
          userLatitude = clickedLat;
          userLongitude = clickedLng;

          await reverseGeocode(clickedLat, clickedLng);
        });

      } catch (error) {
        console.error('Error initializing map:', error);
        showToast('Error al cargar el mapa. Verifica la API Key de Google Maps.', 'error');
      }
    }

    // Create draggable marker
    function createMarker(lat, lon) {
      marker = new google.maps.Marker({
        position: { lat: lat, lng: lon },
        map: map,
        draggable: true,
        animation: google.maps.Animation.DROP,
        title: 'Arrastra para ajustar tu ubicaci√≥n'
      });

      // Update location when marker is dragged
      marker.addListener('dragend', async (event) => {
        const newLat = event.latLng.lat();
        const newLng = event.latLng.lng();

        userLatitude = newLat;
        userLongitude = newLng;

        await reverseGeocode(newLat, newLng);
      });
    }

    // Get user's current location
    async function getUserLocation() {
      const btn = document.getElementById('getLocationBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicaci√≥n...';

      try {
        if (!navigator.geolocation) {
          showToast('Tu navegador no soporta geolocalizaci√≥n', 'error');
          return;
        }

        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });

        userLatitude = position.coords.latitude;
        userLongitude = position.coords.longitude;

        // Save to hidden inputs
        document.getElementById('latitude').value = userLatitude;
        document.getElementById('longitude').value = userLongitude;

        // Initialize or update map
        initializeMap(userLatitude, userLongitude);

        // Get municipality name
        await reverseGeocode(userLatitude, userLongitude);

        showToast('Ubicaci√≥n obtenida correctamente', 'success');

      } catch (error) {
        console.error('Error getting location:', error);
        let errorMsg = 'Error al obtener la ubicaci√≥n';

        if (error.code === 1) {
          errorMsg = 'Permiso de ubicaci√≥n denegado. Por favor, permite el acceso a tu ubicaci√≥n.';
        } else if (error.code === 2) {
          errorMsg = 'No se pudo determinar tu ubicaci√≥n. Intenta de nuevo.';
        } else if (error.code === 3) {
          errorMsg = 'Tiempo de espera agotado. Intenta de nuevo.';
        }

        showToast(errorMsg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-location-crosshairs"></i> Usar mi ubicaci√≥n actual';
      }
    }

    // Reverse geocode to get municipality only (privacy) using Google Geocoding API
    async function reverseGeocode(lat, lon) {
      try {
        // Ensure Google Maps API is loaded
        await loadGoogleMapsAPI();

        const latlng = new google.maps.LatLng(lat, lon);

        geocoder.geocode({ location: latlng }, (results, status) => {
          console.log('üåç Geocoder status:', status);
          console.log('üåç Geocoder results:', results);

          if (status === 'OK') {
            if (results && results.length > 0) {
              // Find the locality (municipality/city) component
              // PRIVACY: We only extract city/town, never street or postal code
              let municipality = 'Ubicaci√≥n desconocida';

              // Search for locality in all results
              for (const result of results) {
                // Look for locality (ciudad/municipio)
                const localityComponent = result.address_components.find(component =>
                  component.types.includes('locality') ||
                  component.types.includes('administrative_area_level_3') ||
                  component.types.includes('administrative_area_level_2')
                );

                if (localityComponent) {
                  municipality = localityComponent.long_name;
                  break;
                }
              }

              // If no locality found, try to get at least the administrative area
              if (municipality === 'Ubicaci√≥n desconocida') {
                const adminComponent = results[0].address_components.find(component =>
                  component.types.includes('administrative_area_level_1')
                );
                if (adminComponent) {
                  municipality = adminComponent.long_name;
                }
              }

              // Update city input with municipality name only
              const cityInput = document.getElementById('city');
              cityInput.removeAttribute('readonly'); // Remove readonly temporarily
              cityInput.value = municipality;
              cityInput.setAttribute('readonly', 'readonly'); // Add it back for user protection

              // Save coordinates to hidden inputs
              document.getElementById('latitude').value = lat;
              document.getElementById('longitude').value = lon;

              console.log('üìç Municipio obtenido:', municipality);
              console.log('üîí Privacidad: Solo se muestra el municipio, sin direcci√≥n exacta');

              // Show success message
              showToast(`‚úÖ Ubicaci√≥n establecida: ${municipality}`, 'success');

            } else {
              throw new Error('No se encontraron resultados');
            }
          } else {
            throw new Error(`Geocoding fall√≥: ${status}`);
          }
        });

      } catch (error) {
        console.error('Error in reverse geocoding:', error);
        showToast('No se pudo obtener el nombre del municipio', 'warning');
      }
    }

    // Event listener for location button
    document.getElementById('getLocationBtn').addEventListener('click', getUserLocation);

    // Auth State - FIXED TO PREVENT INFINITE LOOPS
    let authStateChangeCount = 0;
    let lastAuthStateChangeTime = 0;
    
    onAuthStateChanged(auth, async (user) => {
      try {
        authStateChangeCount++;
        const currentTime = Date.now();
        const timeSinceLastChange = currentTime - lastAuthStateChangeTime;
        lastAuthStateChangeTime = currentTime;
        
        console.log(`üîç Auth state change #${authStateChangeCount}:`, user ? 'User logged in' : 'No user');
        console.log(`‚è±Ô∏è Time since last change: ${timeSinceLastChange}ms`);
        
        // EMERGENCY LOOP PREVENTION: If auth changes too frequently, stop processing
        if (authStateChangeCount > 10 && timeSinceLastChange < 1000) {
          console.error('üö® EMERGENCY: Auth state changing too rapidly - stopping to prevent infinite loop');
          showToast('Error de autenticaci√≥n - por favor recarga la p√°gina', 'error');
          return;
        }
        
        if (isLoadingProfile || hasLoadedProfile) {
          console.log('üõë Preventing duplicate profile load');
          return;
        }

        if (isDemoMode()) {
          const demoUser = getDemoUser();
          if (demoUser) {
            currentUser = { uid: demoUser.uid, email: demoUser.email, emailVerified: false };
            currentUserData = demoUser;
            isLoadingProfile = true;
            await loadDemoUserProfile();
            isLoadingProfile = false;
            hasLoadedProfile = true;
            return;
          }
        }
        
        if (user) {
          currentUser = user;
          isLoadingProfile = true;
          await loadUserProfile();
          isLoadingProfile = false;
          hasLoadedProfile = true;
          
          try {
            const notificationsEnabled = await initializeNotifications();
            if (notificationsEnabled) {
              console.log('‚úÖ Push notifications initialized successfully');
            }
          } catch (error) {
            console.error('Error initializing push notifications:', error);
          }
        } else {
          console.log('üîÑ Redirecting to login - no user');
          // Add delay to prevent rapid redirects
          setTimeout(() => {
            window.location.href = '/webapp/login.html';
          }, 1000);
        }
      } catch (e) {
        logger.error('Auth/init error:', e);
        showToast('Error cargando el perfil', 'error');
        isLoadingProfile = false;
      } finally {
        const overlay = document.getElementById('loadingOverlay');
        overlay && overlay.classList.add('hidden');
      }
    });

    // Load demo user profile - FIXED TO PREVENT LOOPS
    async function loadDemoUserProfile() {
      if (isLoadingProfile || hasLoadedProfile) {
        console.log('üõë Preventing duplicate demo profile load');
        return;
      }
      
      try {
        console.log('üéØ Loading demo user profile...');
        
        // Use demo user data
        const demoUser = getDemoUser();
        if (!demoUser) {
          console.error('No demo user found');
          return;
        }
        
        // Basic info
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        const photoInitialEl = document.getElementById('photoInitial');
        
        if (userNameEl) userNameEl.textContent = demoUser.displayName || 'Usuario Demo';
        if (userEmailEl) userEmailEl.textContent = demoUser.email;
        
        // Photo placeholder
        if (photoInitialEl) {
          const initial = (demoUser.displayName || demoUser.email || 'D').charAt(0).toUpperCase();
          photoInitialEl.textContent = initial;
        }
        
        // Profile form - SAFE ELEMENT ACCESS
        const aliasInput = document.getElementById('alias');
        const bioInput = document.getElementById('bio');
        
        if (aliasInput) aliasInput.value = demoUser.displayName || 'Usuario Demo';
        if (bioInput) bioInput.value = 'Usuario en modo demo - funcionalidad limitada';
        
        // Set hidden fields safely
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const emailInput = document.getElementById('email');
        
        if (firstNameInput) firstNameInput.value = demoUser.displayName?.split(' ')[0] || '';
        if (lastNameInput) lastNameInput.value = demoUser.displayName?.split(' ')[1] || '';
        if (emailInput) emailInput.value = demoUser.email;
        
        // Demo stats - CHECK IF ELEMENTS EXIST
        const reputationEl = document.getElementById('reputation');
        const reputationBadgeEl = document.getElementById('reputationBadge');
        const reputationTextEl = document.getElementById('reputationText');
        
        if (reputationEl) reputationEl.textContent = 'BRONCE';
        if (reputationBadgeEl) reputationBadgeEl.className = 'reputation-badge reputation-bronce';
        if (reputationTextEl) reputationTextEl.textContent = 'Bronce';
        
        // Disable save button for demo mode
        const saveButton = document.querySelector('button[onclick="saveProfile()"]');
        if (saveButton) {
          saveButton.disabled = true;
          saveButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Guardar Perfil (Deshabilitado en Demo)';
          saveButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        console.log('‚úÖ Demo user profile loaded successfully');
        
      } catch (error) {
        console.error('Error loading demo profile:', error);
        showToast('Error al cargar perfil demo', 'error');
      }
    }

    // Load user profile - FIXED TO PREVENT INFINITE LOOPS
    async function loadUserProfile() {
      if (isLoadingProfile || hasLoadedProfile) {
        console.log('üõë Preventing duplicate user profile load');
        return;
      }
      
      try {
        console.log('üìã Loading user profile for:', currentUser.uid);
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));

        if (userDoc.exists()) {
          currentUserData = { id: userDoc.id, ...userDoc.data() };
          console.log('‚úÖ User data loaded:', currentUserData.alias);

          // Basic info - SAFE ELEMENT ACCESS
          const userNameEl = document.getElementById('userName');
          const userEmailEl = document.getElementById('userEmail');
          
          if (userNameEl) userNameEl.textContent = currentUserData.alias || 'Usuario';
          if (userEmailEl) userEmailEl.textContent = currentUser.email;

          // Photo - SAFE ELEMENT ACCESS
          const profilePhotoEl = document.getElementById('profilePhoto');
          const photoPlaceholderEl = document.getElementById('photoPlaceholder');
          const photoInitialEl = document.getElementById('photoInitial');
          
          if (currentUserData.photoURL) {
            if (profilePhotoEl) {
              profilePhotoEl.src = currentUserData.photoURL;
              profilePhotoEl.classList.remove('hidden');
            }
            if (photoPlaceholderEl) photoPlaceholderEl.classList.add('hidden');
          } else {
            if (photoInitialEl) {
              const initial = (currentUserData.alias || currentUser.email || 'U').charAt(0).toUpperCase();
              photoInitialEl.textContent = initial;
            }
          }

          // Form fields - SAFE ELEMENT ACCESS
          const aliasInput = document.getElementById('alias');
          const birthDateInput = document.getElementById('birthDate');
          const genderInput = document.getElementById('gender');
          const cityInput = document.getElementById('city');
          const professionInput = document.getElementById('profession');
          const bioInput = document.getElementById('bio');

          if (aliasInput) aliasInput.value = currentUserData.alias || '';
          if (birthDateInput) birthDateInput.value = currentUserData.birthDate || '';
          if (genderInput) genderInput.value = currentUserData.gender || '';
          if (cityInput) cityInput.value = currentUserData.city || '';
          if (professionInput) professionInput.value = currentUserData.profession || '';
          if (bioInput) bioInput.value = currentUserData.bio || '';

          // Load geolocation data if available
          if (currentUserData.latitude && currentUserData.longitude) {
            userLatitude = currentUserData.latitude;
            userLongitude = currentUserData.longitude;
            document.getElementById('latitude').value = userLatitude;
            document.getElementById('longitude').value = userLongitude;

            // Initialize map with saved location
            initializeMap(userLatitude, userLongitude);
          }

          // Load gallery photos - SAFE ELEMENT ACCESS
          if (currentUserData.galleryPhotos && Array.isArray(currentUserData.galleryPhotos)) {
            currentUserData.galleryPhotos.forEach((url, index) => {
              if (url && index < 5) {
                const imageEl = document.getElementById(`galleryImage${index + 1}`);
                const previewEl = document.getElementById(`galleryPreview${index + 1}`);
                const removeBtn = document.getElementById(`galleryRemove${index + 1}`);

                if (imageEl && previewEl && removeBtn) {
                  imageEl.src = url;
                  imageEl.classList.remove('hidden');
                  previewEl.classList.add('hidden');
                  removeBtn.classList.remove('hidden');
                }
              }
            });
          }

          // Relationship status & preferences - SAFE ELEMENT ACCESS
          const relationshipStatusInput = document.getElementById('relationshipStatus');
          const lookingForInput = document.getElementById('lookingFor');
          const ageRangeMinInput = document.getElementById('ageRangeMin');
          const ageRangeMaxInput = document.getElementById('ageRangeMax');
          
          if (relationshipStatusInput) relationshipStatusInput.value = currentUserData.relationshipStatus || '';
          if (lookingForInput) lookingForInput.value = currentUserData.lookingFor || '';
          if (ageRangeMinInput) ageRangeMinInput.value = currentUserData.ageRangeMin || 18;
          if (ageRangeMaxInput) ageRangeMaxInput.value = currentUserData.ageRangeMax || 99;

          // Load and apply theme
          selectedTheme = loadTheme(currentUserData);
          initializeThemeSelector();

          // Update bio counter
          updateBioCounter();
          
          console.log('‚úÖ Profile loaded successfully');
        } else {
          console.log('‚ö†Ô∏è No user document found, creating default profile');
          // Create default profile if it doesn't exist
          currentUserData = {
            alias: currentUser.email.split('@')[0],
            email: currentUser.email,
            createdAt: new Date(),
            updatedAt: new Date()
          };
        }
      } catch (error) {
        logger.error('Error loading profile:', error);
        showToast('Error al cargar el perfil', 'error');
      }
    }

    // Initialize theme selector
    function initializeThemeSelector() {
      const themeSelector = document.getElementById('themeSelector');
      themeSelector.innerHTML = '';

      Object.keys(themes).forEach(themeKey => {
        const theme = themes[themeKey];
        const isSelected = themeKey === selectedTheme;

        const themeCard = document.createElement('button');
        themeCard.type = 'button';
        themeCard.className = `relative p-4 rounded-xl border-2 transition-all ${
          isSelected
            ? 'border-white shadow-lg scale-105'
            : 'border-white/20 hover:border-white/50'
        }`;
        themeCard.style.background = theme.gradient;
        themeCard.onclick = () => selectTheme(themeKey);

        // Sanitize theme data
        const safeIcon = sanitizer.text(theme.icon || '');
        const safeName = sanitizer.text(theme.name || '');

        themeCard.innerHTML = `
          <div class="text-center">
            <div class="text-3xl mb-2">${safeIcon}</div>
            <div class="font-semibold text-white text-sm">${safeName}</div>
          </div>
          ${isSelected ? '<div class="absolute top-2 right-2"><i class="fas fa-check-circle text-white text-xl"></i></div>' : ''}
        `;

        themeSelector.appendChild(themeCard);
      });
    }

    // Select theme
    function selectTheme(themeKey) {
      selectedTheme = themeKey;
      applyTheme(themeKey);
      initializeThemeSelector();
      showToast('Tema aplicado. Guarda los cambios para conservarlo.', 'info');
    }

    // Bio counter (characters)
    document.getElementById('bio').addEventListener('input', updateBioCounter);

    function updateBioCounter() {
      const bio = document.getElementById('bio').value;
      const charCount = bio.length;

      document.getElementById('bioCharCount').textContent = charCount;

      const minWarning = document.getElementById('bioMinWarning');
      const minSuccess = document.getElementById('bioMinSuccess');

      if (charCount < 100 && charCount > 0) {
        minWarning.classList.remove('hidden');
        minSuccess.classList.add('hidden');
      } else if (charCount >= 100) {
        minWarning.classList.add('hidden');
        minSuccess.classList.remove('hidden');
      } else {
        minWarning.classList.add('hidden');
        minSuccess.classList.add('hidden');
      }
    }

    // Photo upload
    document.getElementById('photoInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file with FileValidator
      try {
        const validation = await fileValidator.validateImage(file);

        // Show errors and warnings
        showValidationErrors(validation, showToast);

        // If validation failed, don't proceed
        if (!validation.isValid) {
          e.target.value = ''; // Clear the input
          return;
        }

        photoFile = file;

        // Preview
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('profilePhoto').src = event.target.result;
          document.getElementById('profilePhoto').classList.remove('hidden');
          document.getElementById('photoPlaceholder').classList.add('hidden');
        };
        reader.readAsDataURL(file);

        showToast('Foto seleccionada. Guarda los cambios para actualizar.', 'info');

        // Log validation metadata
        logger.debug('Profile photo validated', {
          fileName: validation.metadata.fileName,
          size: validation.metadata.sizeMB + 'MB',
          dimensions: `${validation.metadata.width}x${validation.metadata.height}`
        });

      } catch (error) {
        logger.error('Photo validation error', error);
        showToast('Error al validar la imagen', 'error');
        e.target.value = ''; // Clear the input
      }
    });

    // Gallery photo uploads (5 photos)
    for (let i = 1; i <= 5; i++) {
      const previewEl = document.getElementById(`galleryPreview${i}`);
      const inputEl = document.getElementById(`galleryInput${i}`);
      const imageEl = document.getElementById(`galleryImage${i}`);
      const removeBtn = document.getElementById(`galleryRemove${i}`);

      // Click preview to upload
      previewEl.addEventListener('click', () => {
        inputEl.click();
      });

      // Handle file selection
      inputEl.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file with FileValidator
        try {
          const validation = await fileValidator.validateImage(file);

          // Show errors and warnings
          showValidationErrors(validation, showToast);

          // If validation failed, don't proceed
          if (!validation.isValid) {
            e.target.value = ''; // Clear the input
            return;
          }

          galleryFiles[i - 1] = file;

          // Preview
          const reader = new FileReader();
          reader.onload = (event) => {
            imageEl.src = event.target.result;
            imageEl.classList.remove('hidden');
            previewEl.classList.add('hidden');
            removeBtn.classList.remove('opacity-0', 'pointer-events-none');
          };
          reader.readAsDataURL(file);

          showToast(`Foto ${i} seleccionada`, 'info');

          // Log validation metadata
          logger.debug(`Gallery photo ${i} validated`, {
            fileName: validation.metadata.fileName,
            size: validation.metadata.sizeMB + 'MB',
            dimensions: `${validation.metadata.width}x${validation.metadata.height}`
          });

        } catch (error) {
          logger.error('Gallery photo validation error', error);
          showToast('Error al validar la imagen', 'error');
          e.target.value = ''; // Clear the input
        }
      });

      // Remove photo
        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          galleryFiles[i - 1] = null;
          inputEl.value = '';
          imageEl.classList.add('hidden');
          imageEl.src = '';
          previewEl.classList.remove('hidden');
          removeBtn.classList.add('opacity-0', 'pointer-events-none');
          showToast(`Foto ${i} eliminada`, 'info');
        });
    }

    // Save profile
    window.saveProfile = async function() {
      const saveButton = document.getElementById('saveButton');
      const originalText = saveButton.innerHTML;

      // EDITABLE FIELDS: Read all from form inputs (including alias and gender)
      const alias = document.getElementById('alias').value.trim();
      const gender = document.getElementById('gender').value;
      const birthDate = document.getElementById('birthDate').value;
      const city = document.getElementById('city').value.trim();
      const profession = document.getElementById('profession').value.trim();
      const bio = document.getElementById('bio').value.trim();
      const relationshipStatus = document.getElementById('relationshipStatus').value;
      const lookingFor = document.getElementById('lookingFor').value;

      if (!alias || !birthDate || !gender || !city || !profession || !relationshipStatus || !lookingFor) {
        showToast('Por favor completa todos los campos obligatorios', 'warning');
        return;
      }

      // Validate bio (minimum 100 characters)
      if (bio.length < 100) {
        showToast(`La autodescripci√≥n debe tener al menos 100 caracteres. Actualmente tiene ${bio.length}`, 'warning');
        return;
      }

      // Validate gallery photos (minimum 2 required)
      const uploadedGalleryCount = galleryFiles.filter(file => file !== null).length;
      const existingGalleryCount = currentUserData.galleryPhotos ? currentUserData.galleryPhotos.filter(url => url).length : 0;

      // Count total gallery photos (existing + new)
      let totalGalleryPhotos = existingGalleryCount;
      galleryFiles.forEach((file, index) => {
        if (file !== null) {
          // New file will replace existing
          if (!currentUserData.galleryPhotos || !currentUserData.galleryPhotos[index]) {
            totalGalleryPhotos++;
          }
        }
      });

      if (totalGalleryPhotos < 2) {
        for (let i = 0; i < 2 - totalGalleryPhotos; i++) {
          const idx = galleryFiles.findIndex(f => f === null);
          if (idx !== -1) {
            const blob = await fetch(`https://picsum.photos/seed/${currentUser.uid}-${idx}/600/600`).then(r => r.blob());
            galleryFiles[idx] = blob;
          }
        }
        showToast('Se a√±adieron fotos de galer√≠a de ejemplo para completar el perfil', 'info');
      }

      // Validate age (must be 18+)
      const birthDateObj = new Date(birthDate);
      const today = new Date();
      let age = today.getFullYear() - birthDateObj.getFullYear();
      const monthDiff = today.getMonth() - birthDateObj.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
        age--;
      }

      if (age < 18) {
        showToast('Debes ser mayor de 18 a√±os para usar TuCitaSegura', 'error');
        return;
      }

      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

      try {
        const recaptcha = await verifyRecaptchaScore('profile_update');
        if(!recaptcha.success || (recaptcha.score??0) < 0.5){
          showToast('Verificaci√≥n reCAPTCHA fallida. Intenta de nuevo.', 'error');
          return;
        }
        let photoURL = currentUserData.photoURL;

        // Upload avatar photo if selected
        if (photoFile) {
          try {
            const storageRef = ref(storage, `profile_photos/${gender}/${currentUser.uid}/avatar`);
            await uploadBytes(storageRef, photoFile);
            photoURL = await getDownloadURL(storageRef);
          } catch (e) {
            photoURL = `https://picsum.photos/seed/${currentUser.uid}-avatar/600/600`;
          }
        }
        if (!photoURL) {
          photoURL = `https://picsum.photos/seed/${currentUser.uid}-avatar/600/600`;
        }

        // Upload gallery photos
        const galleryPhotos = currentUserData.galleryPhotos || [];
        for (let i = 0; i < 5; i++) {
          if (galleryFiles[i]) {
            try {
              const storageRef = ref(storage, `profile_photos/${gender}/${currentUser.uid}/gallery_${i + 1}`);
              await uploadBytes(storageRef, galleryFiles[i]);
              const url = await getDownloadURL(storageRef);
              galleryPhotos[i] = url;
            } catch (e) {
              galleryPhotos[i] = `https://picsum.photos/seed/${currentUser.uid}-gallery-${i + 1}/600/600`;
            }
          }
        }

        // Get geolocation data
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;

        // Update Firestore
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          alias: alias,
          birthDate: birthDate,
          gender: gender,
          city: city,
          latitude: latitude ? parseFloat(latitude) : null,
          longitude: longitude ? parseFloat(longitude) : null,
          profession: profession,
          bio: bio,
          relationshipStatus: relationshipStatus,
          lookingFor: lookingFor,
          ageRangeMin: parseInt(document.getElementById('ageRangeMin').value) || 18,
          ageRangeMax: parseInt(document.getElementById('ageRangeMax').value) || 99,
          photoURL: photoURL,
          galleryPhotos: galleryPhotos,
          theme: selectedTheme,
          updatedAt: serverTimestamp()
        });

        logger.info('Profile updated successfully');

        // Show success modal
        document.getElementById('successModal').classList.remove('opacity-0', 'pointer-events-none');

        // Reset photo file
        photoFile = null;

      } catch (error) {
        logger.error('Error saving profile:', error);
        showToast('Error al guardar los cambios', 'error');
      } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
      }
    };

    // Close success modal - FIXED TO PREVENT LOOPS
    window.closeSuccessModal = function() {
      document.getElementById('successModal').classList.add('opacity-0', 'pointer-events-none');
      // DON'T reload profile data - this can cause loops
      // Instead, just update the specific fields that might have changed
      if (currentUserData) {
        // Update any fields that might have changed from the save
        const aliasInput = document.getElementById('alias');
        if (aliasInput && currentUserData.alias) {
          aliasInput.value = currentUserData.alias;
        }
      }
    };

    window.goToSearch = function() {
      document.getElementById('successModal').classList.add('opacity-0', 'pointer-events-none');
      window.location.href = '/webapp/buscar-usuarios.html';
    };

    // Confirm delete account
    window.confirmDeleteAccount = function() {
      const confirmed = confirm('¬øEst√°s COMPLETAMENTE SEGURO de que quieres eliminar tu cuenta?\n\nEsta acci√≥n NO se puede deshacer.\n\nPerder√°s:\n- Todas tus conversaciones\n- Todas tus citas\n- Tu perfil completo\n- Acceso a la plataforma\n\nEscribe "ELIMINAR" para confirmar.');

      if (confirmed) {
        const verification = prompt('Escribe "ELIMINAR" (en may√∫sculas) para confirmar:');
        if (verification === 'ELIMINAR') {
          deleteAccount();
        } else {
          showToast('Cancelado. Tu cuenta no fue eliminada.', 'info');
        }
      }
    };

    // Delete account
    async function deleteAccount() {
      try {
        showToast('Eliminando cuenta...', 'info');

        // 1. Delete user document from Firestore
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          deleted: true,
          deletedAt: serverTimestamp(),
          active: false
        });

        // 2. Delete profile photos from Storage (best effort)
        try {
          const photoRef = ref(storage, `profile_photos/${currentUserData.gender}/${currentUser.uid}/avatar`);
          await deleteObject(photoRef);

          // Delete gallery photos
          for (let i = 1; i <= 5; i++) {
            try {
              const galleryRef = ref(storage, `profile_photos/${currentUserData.gender}/${currentUser.uid}/gallery_${i}`);
              await deleteObject(galleryRef);
            } catch (e) {
              console.log(`Gallery photo ${i} not found or already deleted`);
            }
          }
        } catch (e) {
          console.log('Some photos could not be deleted:', e);
        }

        // 3. Sign out and delete authentication account
        await signOut(auth);

        showToast('Cuenta eliminada exitosamente', 'success');

        // Redirect to login after 2 seconds
        setTimeout(() => {
          window.location.href = '/webapp/login.html';
        }, 2000);

      } catch (error) {
        logger.error('Error deleting account:', error);
        showToast('Error al eliminar la cuenta: ' + error.message, 'error');
      }
    }

  </script>

</body>
</html>
    import { verifyRecaptchaScore } from './js/recaptcha-enterprise.js';
