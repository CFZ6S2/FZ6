<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login por SMS - Demo</title>
  <link rel="icon" type="image/png" href="/webapp/images/favicon.png">
  <link rel="manifest" href="/webapp/site.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Personalizaci√≥n del widget de reCAPTCHA */
    .g-recaptcha {
      margin: 20px auto;
      display: inline-block;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-purple-800 to-pink-800 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">üì± Login por SMS</h1>
      <p class="text-white text-opacity-80">Autenticaci√≥n con Firebase Phone Auth + reCAPTCHA v2</p>
      <div class="mt-4 p-4 bg-blue-500 bg-opacity-20 rounded-lg inline-block">
        <p class="text-white text-sm">
          ‚ÑπÔ∏è Este sistema es <strong>independiente</strong> de App Check (reCAPTCHA Enterprise)
        </p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-4xl mx-auto mb-6">
      <div class="flex gap-2 bg-white bg-opacity-10 p-2 rounded-lg">
        <button id="tab-visible" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all bg-white text-purple-900">
          reCAPTCHA Visible
        </button>
        <button id="tab-invisible" class="flex-1 px-4 py-2 rounded-lg font-semibold text-white transition-all hover:bg-white hover:bg-opacity-10">
          reCAPTCHA Invisible
        </button>
      </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Panel de Autenticaci√≥n -->
      <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-xl p-6 shadow-2xl">
        <h2 class="text-2xl font-bold text-white mb-4">Iniciar Sesi√≥n</h2>

        <!-- Formulario de tel√©fono -->
        <div id="phone-form" class="space-y-4">
          <div>
            <label for="phone-number" class="block text-white font-semibold mb-2">
              N√∫mero de Tel√©fono
            </label>
            <div class="flex gap-2">
              <input
                type="text"
                id="country-code"
                value="+34"
                class="w-20 px-3 py-2 bg-white bg-opacity-20 text-white rounded-lg border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-pink-500"
                placeholder="+34"
              >
              <input
                type="tel"
                id="phone-number"
                class="flex-1 px-4 py-2 bg-white bg-opacity-20 text-white rounded-lg border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-pink-500"
                placeholder="612 34 56 78"
                maxlength="12"
              >
            </div>
            <p class="text-white text-opacity-60 text-sm mt-1">
              Formato: 612345678 (sin espacios para Espa√±a)
            </p>
          </div>

          <!-- Contenedor para reCAPTCHA -->
          <div class="text-center">
            <div id="recaptcha-container" class="inline-block"></div>
          </div>

          <button
            id="send-code-btn"
            class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            üì® Enviar C√≥digo por SMS
          </button>
        </div>

        <!-- Formulario de verificaci√≥n -->
        <div id="verify-form" class="space-y-4 hidden">
          <div>
            <label for="sms-code" class="block text-white font-semibold mb-2">
              C√≥digo de Verificaci√≥n
            </label>
            <input
              type="text"
              id="sms-code"
              class="w-full px-4 py-2 bg-white bg-opacity-20 text-white text-center text-2xl tracking-widest rounded-lg border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-pink-500"
              placeholder="123456"
              maxlength="6"
              pattern="\d{6}"
            >
            <p class="text-white text-opacity-60 text-sm mt-1 text-center">
              Ingresa el c√≥digo de 6 d√≠gitos recibido por SMS
            </p>
          </div>

          <button
            id="verify-code-btn"
            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            ‚úÖ Verificar C√≥digo
          </button>

          <button
            id="cancel-btn"
            class="w-full bg-gray-500 text-white font-bold py-2 rounded-lg hover:bg-gray-600 transition-all"
          >
            ‚Üê Volver
          </button>
        </div>

        <!-- Estado de autenticaci√≥n -->
        <div id="auth-status" class="mt-6 p-4 rounded-lg hidden">
          <p class="font-semibold text-white"></p>
        </div>
      </div>

      <!-- Panel de Informaci√≥n -->
      <div class="space-y-6">
        <!-- Logs en tiempo real -->
        <div class="bg-black bg-opacity-50 backdrop-blur-lg rounded-xl p-4 shadow-2xl">
          <h3 class="text-xl font-bold text-white mb-3 flex items-center gap-2">
            <span>üìä</span> Logs en Tiempo Real
          </h3>
          <div id="logs-container" class="space-y-2 max-h-64 overflow-y-auto text-sm font-mono">
            <div class="text-gray-400">Esperando acciones...</div>
          </div>
        </div>

        <!-- Informaci√≥n -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-xl p-4 shadow-2xl">
          <h3 class="text-xl font-bold text-white mb-3">‚ÑπÔ∏è Informaci√≥n</h3>
          <div class="space-y-2 text-white text-opacity-80 text-sm">
            <div id="info-mode" class="p-2 bg-blue-500 bg-opacity-20 rounded">
              <strong>Modo:</strong> <span id="current-mode">Visible</span>
            </div>
            <div class="p-2 bg-purple-500 bg-opacity-20 rounded">
              <strong>App Check:</strong> <span id="appcheck-status">Cargando...</span>
            </div>
            <div class="p-2 bg-pink-500 bg-opacity-20 rounded">
              <strong>Phone Auth:</strong> <span id="phoneauth-status">No inicializado</span>
            </div>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="bg-yellow-500 bg-opacity-20 backdrop-blur-lg rounded-xl p-4 shadow-2xl border border-yellow-500 border-opacity-30">
          <h3 class="text-lg font-bold text-yellow-300 mb-2">‚ö†Ô∏è Importante</h3>
          <ul class="text-white text-opacity-90 text-sm space-y-1 list-disc list-inside">
            <li>Firebase Phone Auth tiene <strong>l√≠mite diario</strong> de SMS gratuitos</li>
            <li>Usa n√∫meros de prueba en <a href="https://console.firebase.google.com/project/tuscitasseguras-2d1a6/authentication/providers" class="underline" target="_blank">Firebase Console</a></li>
            <li>reCAPTCHA v2 es manejado autom√°ticamente por Firebase</li>
            <li>No necesitas configurar site key manualmente</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- IMPORTANTE: Importar App Check ANTES de firebase-config.js -->
  <script type="module">
    import './js/firebase-appcheck.js';
    import { auth } from './js/firebase-config.js';
    import {
      initRecaptchaVisible,
      initRecaptchaInvisible,
      sendSmsCode,
      verifySmsCode,
      cleanupRecaptcha,
      formatSpanishPhone,
      getPhoneAuthState
    } from './js/phone-auth.js';

    // ========================================================================
    // ESTADO DE LA APLICACI√ìN
    // ========================================================================

    let currentMode = 'visible'; // 'visible' o 'invisible'
    let logs = [];

    // ========================================================================
    // ELEMENTOS DEL DOM
    // ========================================================================

    const tabVisible = document.getElementById('tab-visible');
    const tabInvisible = document.getElementById('tab-invisible');
    const phoneForm = document.getElementById('phone-form');
    const verifyForm = document.getElementById('verify-form');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const phoneNumberInput = document.getElementById('phone-number');
    const countryCodeInput = document.getElementById('country-code');
    const smsCodeInput = document.getElementById('sms-code');
    const authStatus = document.getElementById('auth-status');
    const logsContainer = document.getElementById('logs-container');
    const currentModeSpan = document.getElementById('current-mode');
    const phoneauthStatus = document.getElementById('phoneauth-status');
    const appcheckStatus = document.getElementById('appcheck-status');

    // ========================================================================
    // FUNCIONES DE UI
    // ========================================================================

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('es-ES');
      const colors = {
        info: 'text-blue-400',
        success: 'text-green-400',
        error: 'text-red-400',
        warning: 'text-yellow-400'
      };

      logs.unshift({ timestamp, message, type });
      if (logs.length > 20) logs.pop();

      logsContainer.innerHTML = logs.map(log => `
        <div class="${colors[log.type]}">
          <span class="text-gray-500">[${log.timestamp}]</span> ${log.message}
        </div>
      `).join('');
    }

    function showStatus(message, type = 'info') {
      const colors = {
        info: 'bg-blue-500',
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500'
      };

      authStatus.className = `mt-6 p-4 rounded-lg ${colors[type]} bg-opacity-30 border border-${type} border-opacity-50`;
      authStatus.querySelector('p').textContent = message;
      authStatus.classList.remove('hidden');

      setTimeout(() => {
        if (type !== 'error') {
          authStatus.classList.add('hidden');
        }
      }, 5000);
    }

    function switchToVerifyForm() {
      phoneForm.classList.add('hidden');
      verifyForm.classList.remove('hidden');
      smsCodeInput.focus();
    }

    function switchToPhoneForm() {
      verifyForm.classList.add('hidden');
      phoneForm.classList.remove('hidden');
      smsCodeInput.value = '';
    }

    function setLoading(isLoading) {
      sendCodeBtn.disabled = isLoading;
      verifyCodeBtn.disabled = isLoading;
      phoneNumberInput.disabled = isLoading;
      smsCodeInput.disabled = isLoading;
    }

    // ========================================================================
    // INICIALIZACI√ìN
    // ========================================================================

    async function initRecaptcha() {
      try {
        await cleanupRecaptcha();
        addLog('Limpiando reCAPTCHA anterior...', 'info');

        if (currentMode === 'visible') {
          await initRecaptchaVisible('recaptcha-container');
          addLog('‚úÖ reCAPTCHA Visible inicializado', 'success');
        } else {
          await initRecaptchaInvisible('recaptcha-container');
          addLog('‚úÖ reCAPTCHA Invisible inicializado', 'success');
        }

        phoneauthStatus.textContent = `Listo (${currentMode})`;
        sendCodeBtn.disabled = false;

      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
        phoneauthStatus.textContent = 'Error';
        sendCodeBtn.disabled = true;
      }
    }

    // ========================================================================
    // CAMBIO DE MODO
    // ========================================================================

    tabVisible.addEventListener('click', async () => {
      if (currentMode === 'visible') return;

      currentMode = 'visible';
      currentModeSpan.textContent = 'Visible';
      tabVisible.classList.add('bg-white', 'text-purple-900');
      tabVisible.classList.remove('text-white');
      tabInvisible.classList.remove('bg-white', 'text-purple-900');
      tabInvisible.classList.add('text-white');

      addLog('Cambiando a modo Visible...', 'info');
      await initRecaptcha();
    });

    tabInvisible.addEventListener('click', async () => {
      if (currentMode === 'invisible') return;

      currentMode = 'invisible';
      currentModeSpan.textContent = 'Invisible';
      tabInvisible.classList.add('bg-white', 'text-purple-900');
      tabInvisible.classList.remove('text-white');
      tabVisible.classList.remove('bg-white', 'text-purple-900');
      tabVisible.classList.add('text-white');

      addLog('Cambiando a modo Invisible...', 'info');
      await initRecaptcha();
    });

    // ========================================================================
    // ENVIAR C√ìDIGO SMS
    // ========================================================================

    sendCodeBtn.addEventListener('click', async () => {
      try {
        setLoading(true);
        addLog('üì± Enviando SMS...', 'info');

        const countryCode = countryCodeInput.value.trim();
        const phone = phoneNumberInput.value.trim().replace(/\s/g, '');
        const fullPhone = countryCode + phone;

        addLog(`N√∫mero: ${fullPhone}`, 'info');

        await sendSmsCode(fullPhone);

        addLog('‚úÖ SMS enviado correctamente', 'success');
        showStatus('SMS enviado. Revisa tu tel√©fono.', 'success');
        switchToVerifyForm();

      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
        showStatus(error.message, 'error');
      } finally {
        setLoading(false);
      }
    });

    // ========================================================================
    // VERIFICAR C√ìDIGO
    // ========================================================================

    verifyCodeBtn.addEventListener('click', async () => {
      try {
        setLoading(true);
        const code = smsCodeInput.value.trim();

        addLog('üîç Verificando c√≥digo...', 'info');

        const userCredential = await verifySmsCode(code);

        addLog('‚úÖ C√≥digo verificado', 'success');
        addLog(`üë§ Usuario: ${userCredential.user.uid}`, 'success');
        showStatus(`¬°Bienvenido! ${userCredential.user.phoneNumber}`, 'success');

        // Resetear formulario
        setTimeout(() => {
          switchToPhoneForm();
          phoneNumberInput.value = '';
          smsCodeInput.value = '';
        }, 2000);

      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
        showStatus(error.message, 'error');
      } finally {
        setLoading(false);
      }
    });

    // ========================================================================
    // BOT√ìN CANCELAR
    // ========================================================================

    cancelBtn.addEventListener('click', () => {
      switchToPhoneForm();
      addLog('Operaci√≥n cancelada', 'warning');
    });

    // ========================================================================
    // AUTO-SUBMIT AL COMPLETAR C√ìDIGO
    // ========================================================================

    smsCodeInput.addEventListener('input', (e) => {
      const code = e.target.value;
      if (code.length === 6 && /^\d{6}$/.test(code)) {
        verifyCodeBtn.click();
      }
    });

    // ========================================================================
    // INICIALIZACI√ìN AL CARGAR
    // ========================================================================

    window.addEventListener('load', async () => {
      addLog('üöÄ Cargando Phone Auth Demo...', 'info');

      // Verificar App Check
      if (window._appCheckInstance) {
        appcheckStatus.textContent = '‚úÖ Activo (independiente)';
        addLog('App Check est√° activo (independiente de Phone Auth)', 'success');
      } else {
        appcheckStatus.textContent = '‚ö†Ô∏è No activo';
        addLog('App Check no est√° activo', 'warning');
      }

      // Inicializar reCAPTCHA
      await initRecaptcha();

      addLog('‚úÖ Demo lista para usar', 'success');
    });

    // Monitorear estado de autenticaci√≥n
    auth.onAuthStateChanged((user) => {
      if (user) {
        addLog(`üë§ Usuario autenticado: ${user.phoneNumber || user.uid}`, 'info');
      } else {
        addLog('No hay usuario autenticado', 'info');
      }
    });
  </script>
</body>
</html>
