<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Seed Demo User</title>
</head>

<body>
    <h1>Seeding Demo User...</h1>
    <div id="log" style="font-family: monospace; white-space: pre-wrap;"></div>

    <script type="module">
        import { auth, db } from './js/firebase-config-env.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const DEMO_EMAIL = 'demo@tucitasegura.com';
        const DEMO_PASSWORD = 'demo123';

        function log(msg) {
            console.log(msg);
            document.getElementById('log').innerText += msg + '\n';
        }

        async function seed() {
            try {
                log('Attempting login...');
                let userCredential;
                try {
                    userCredential = await signInWithEmailAndPassword(auth, DEMO_EMAIL, DEMO_PASSWORD);
                    log('User already exists and logged in: ' + userCredential.user.uid);
                } catch (e) {
                    if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') {
                        log('User not found. Creating...');
                        userCredential = await createUserWithEmailAndPassword(auth, DEMO_EMAIL, DEMO_PASSWORD);
                        log('User created: ' + userCredential.user.uid);
                    } else {
                        throw e;
                    }
                }

                const user = userCredential.user;
                const uid = user.uid;

                log('Setting complete profile in Firestore...');
                await setDoc(doc(db, 'users', uid), {
                    email: DEMO_EMAIL,
                    alias: 'Demo User',
                    gender: 'male',
                    photoURL: 'https://ui-avatars.com/api/?name=Demo+User&background=random',
                    bio: 'This is a demo account for testing purposes.',
                    municipio: 'Demo City',
                    photos: ['https://ui-avatars.com/api/?name=Demo+User&background=random'],
                    birthDate: '1990-01-01',
                    createdAt: new Date().toISOString(),
                    isVerified: true,
                    role: 'demo'
                }, { merge: true });

                log('Profile set successfully.');
                log('DONE');

            } catch (error) {
                log('ERROR: ' + error.message);
                console.error(error);
            }
        }

        seed();
    </script>
</body>

</html>