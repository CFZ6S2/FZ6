<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ejemplo - Integración de Notificaciones</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/webapp/site.webmanifest">
  <meta name="theme-color" content="#764ba2">

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">

  <!-- Notification Bell Icon (with badge) -->
  <div class="fixed top-4 right-4 z-40">
    <button id="notification-bell" class="relative glass p-3 rounded-full hover:bg-white/10">
      <i class="fas fa-bell text-white text-xl"></i>
      <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
        0
      </span>
    </button>
  </div>

  <div class="container mx-auto p-8">
    <h1 class="text-4xl font-bold text-white mb-8">Ejemplo de Integración de Notificaciones</h1>

    <!-- Notification Settings Card -->
    <div class="glass rounded-2xl p-6 mb-6">
      <h2 class="text-2xl font-bold text-white mb-4">Estado de Notificaciones</h2>

      <div id="notification-status" class="flex items-center gap-4 mb-4">
        <i class="fas fa-circle-notch fa-spin text-white text-2xl"></i>
        <span class="text-white">Verificando estado...</span>
      </div>

      <button id="enable-notifications-btn" class="hidden bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl">
        <i class="fas fa-bell mr-2"></i>
        Activar Notificaciones
      </button>

      <button id="test-notification-btn" class="hidden bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl ml-4">
        <i class="fas fa-vial mr-2"></i>
        Probar Notificación
      </button>

      <div id="fcm-token-display" class="hidden mt-4 p-4 bg-black/20 rounded-lg">
        <p class="text-sm text-gray-300 mb-2">FCM Token:</p>
        <code class="text-xs text-green-400 break-all" id="fcm-token"></code>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
    <!-- DOMPurify for XSS Protection -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <script type="module" src="./js/sanitizer.js"></script>


  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

    // Import notification module
    import {
      initializeNotifications,
      requestNotificationPermission,
      areNotificationsEnabled,
      getCurrentFCMToken,
      showNotificationSettingsPrompt
    } from './js/notifications.js';

    import { showToast } from './js/utils.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmaE2tXMBsKc8DjBd1ShJ1HnDxVYQ0yzU",
      authDomain: "tucitasegura-129cc.firebaseapp.com",
      projectId: "tucitasegura-129cc",
      storageBucket: "tucitasegura-129cc.firebasestorage.app",
      messagingSenderId: "180656060538",
      appId: "1:180656060538:web:3168487130aa126db663c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);

    // Initialize on auth state change
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Initialize notifications
        const enabled = await initializeNotifications();

        updateNotificationStatus(enabled);

        // Show FCM token if enabled
        if (enabled) {
          const token = getCurrentFCMToken();
          if (token) {
            document.getElementById('fcm-token-display').classList.remove('hidden');
            document.getElementById('fcm-token').textContent = token;
          }
        }
      } else {
        updateNotificationStatus(false);
      }
    });

    // Update notification status UI
    function updateNotificationStatus(enabled) {
      const statusEl = document.getElementById('notification-status');
      const enableBtn = document.getElementById('enable-notifications-btn');
      const testBtn = document.getElementById('test-notification-btn');

      if (enabled) {
        statusEl.innerHTML = `
          <i class="fas fa-check-circle text-green-500 text-2xl"></i>
          <span class="text-white">Notificaciones activadas</span>
        `;
        enableBtn.classList.add('hidden');
        testBtn.classList.remove('hidden');
      } else {
        statusEl.innerHTML = `
          <i class="fas fa-times-circle text-red-500 text-2xl"></i>
          <span class="text-white">Notificaciones desactivadas</span>
        `;
        enableBtn.classList.remove('hidden');
        testBtn.classList.add('hidden');
      }
    }

    // Enable notifications button
    document.getElementById('enable-notifications-btn').addEventListener('click', async () => {
      const granted = await requestNotificationPermission();

      if (granted) {
        await initializeNotifications();
        updateNotificationStatus(true);
        showToast('¡Notificaciones activadas correctamente!', 'success');

        // Show FCM token
        const token = getCurrentFCMToken();
        if (token) {
          document.getElementById('fcm-token-display').classList.remove('hidden');
          document.getElementById('fcm-token').textContent = token;
        }
      } else {
        showToast('No se pudieron activar las notificaciones', 'error');
      }
    });

    // Test notification button
    document.getElementById('test-notification-btn').addEventListener('click', async () => {
      try {
        const testNotification = httpsCallable(functions, 'sendTestNotification');
        const result = await testNotification();

        console.log('Test notification result:', result);
        showToast('Notificación de prueba enviada', 'success');
      } catch (error) {
        console.error('Error sending test notification:', error);
        showToast('Error al enviar notificación de prueba', 'error');
      }
    });

    // Notification bell click
    document.getElementById('notification-bell').addEventListener('click', () => {
      if (!areNotificationsEnabled()) {
        showNotificationSettingsPrompt();
      } else {
        showToast('Las notificaciones ya están activadas', 'info');
      }
    });
  </script>
</body>
</html>
