class d{constructor(){const e=typeof window<"u"&&window.location&&window.location.hostname?window.location.hostname:"",s=e==="localhost"||e==="127.0.0.1"||e.endsWith(".local");this.isLocal=s;const r=typeof window<"u"&&window.API_BASE_URL?String(window.API_BASE_URL):"",n="https://tucitasegura-backend-tlmpmnvyda-uc.a.run.app";this.baseURL=r||(s?"http://localhost:8001":n);const o=!1;this.useSameOrigin=o,this.fallbackBaseURL=n,this.token=null,this.headers={"Content-Type":"application/json"}}setToken(e){this.token=e,this.headers.Authorization=`Bearer ${e}`}clearToken(){this.token=null,delete this.headers.Authorization}async request(e,s={}){if(!this.baseURL&&!this.useSameOrigin)throw new Error("Backend disabled in production");const r=this.useSameOrigin?e:`${this.baseURL}${e}`,n=(s.method?String(s.method):"GET").toUpperCase(),o={...this.headers,...s.headers||{}};n==="GET"&&delete o["Content-Type"];const c={...s,method:n,headers:o};try{const a=await fetch(r,c);if(!a.ok){let t=`HTTP ${a.status}`;try{t=(await a.json()).detail||t}catch{try{const i=await a.text();i&&(t=i)}catch{}}throw new Error(t)}try{return await a.json()}catch{return{}}}catch(a){const t=e||"",u=t==="/health"||t.includes("/auth/status");if(a.name==="TypeError"&&a.message.includes("Failed to fetch")){if(this.useSameOrigin&&this.fallbackBaseURL)try{const i=`${this.fallbackBaseURL}${e}`,h=await fetch(i,{...c});if(!h.ok){let l=`HTTP ${h.status}`;try{l=(await h.json()).detail||l}catch{}throw new Error(l)}try{return await h.json()}catch{return{}}}catch(i){console.warn(`Fallback request failed: ${t}`,String(i.message||i))}throw console.warn(`CORS/Network error - backend not reachable: ${t}`,a.message),new Error("Backend connection failed - CORS or network issue")}throw u?console.warn(`API warning: ${t}`,a.message||a):console.error(`API request failed: ${t}`,a),a}}async get(e,s={}){const r=new URLSearchParams(s).toString(),n=r?`${e}?${r}`:e;return this.request(n)}async post(e,s={}){return this.request(e,{method:"POST",body:JSON.stringify(s)})}async put(e,s={}){return this.request(e,{method:"PUT",body:JSON.stringify(s)})}async delete(e){return this.request(e,{method:"DELETE"})}async checkAuthStatus(){return this.get("/api/v1/auth/status")}async getUserProfile(){return this.get("/api/v1/users/me")}async uploadProfilePhoto(e,s="avatar"){const r=new FormData;r.append("file",e);const o=`/api/upload/profile?${new URLSearchParams({photo_type:s}).toString()}`;if(!this.baseURL&&!this.useSameOrigin)throw new Error("Backend disabled");const c=this.useSameOrigin?o:`${this.baseURL}${o}`,a={...this.headers};if(delete a["Content-Type"],typeof window.getAppCheckToken=="function")try{const t=await window.getAppCheckToken();t&&t.token&&(a["X-Firebase-AppCheck"]=t.token)}catch(t){console.warn("Failed to get App Check token for upload:",t)}try{const t=await fetch(c,{method:"POST",headers:a,body:r});if(!t.ok)throw new Error(`Upload failed: ${t.statusText}`);return await t.json()}catch(t){throw console.error("Upload error:",t),t}}async updateUserProfile(e){return this.put("/api/v1/users/me",e)}async checkMembershipStatus(){return this.get("/api/v1/membership/status")}async getSubscriptionPlans(){return this.get("/api/v1/membership/plans")}async createSubscription(e){return this.post("/api/v1/membership/subscribe",e)}async cancelSubscription(){return this.post("/api/v1/membership/cancel")}async moderateMessage(e){return this.post("/api/v1/moderation/message",{text:e,context:"chat"})}async getRecommendations(e={}){const s={user_id:this.getCurrentUserId(),limit:50,min_score:.1};return e.min_age&&(s.min_age=e.min_age),e.max_age&&(s.max_age=e.max_age),e.distance&&(s.max_distance=e.distance),this.get("/api/v1/recommendations",s)}async getMatches(){return this.get("/api/v1/matches")}async getConversations(){return this.get("/api/v1/chat/conversations")}async getMessages(e){return this.get(`/api/v1/chat/conversations/${e}/messages`)}async sendMessage(e,s){return this.post(`/api/v1/chat/conversations/${e}/messages`,{content:s})}getCurrentUserId(){if(!this.token)return null;try{return JSON.parse(atob(this.token.split(".")[1])).user_id||null}catch(e){return console.error("Error decoding token:",e),null}}async healthCheck(){return this.get("/health")}async isBackendAvailable(){try{return await this.healthCheck(),!0}catch{return!1}}}const g=new d;export{g as a};
