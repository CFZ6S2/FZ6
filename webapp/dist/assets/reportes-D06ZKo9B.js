import{a as S,d}from"./firebase-config-env-BtJ4KElt.js";/* empty css               */import"./error-fixes-B-QQl9aC.js";import"./firebase-appcheck-B5Dlx5A0.js";import{onAuthStateChanged as D}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDoc as L,doc as w,query as h,collection as p,where as v,getDocs as y,serverTimestamp as E,addDoc as T}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{s as A}from"./utils-B649B8Z6.js";import{l as q}from"./theme-BOByySXs.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";import"./logger-CnI7WBtq.js";let a=null,f=null,g=[],I=[];const b=new URLSearchParams(window.location.search),B=b.get("userId"),U=b.get("type");D(S,async e=>{e?(a=e,await M(),await C(),await H(),O(),document.getElementById("loadingOverlay").classList.add("hidden")):window.location.href="/login.html"});async function M(){try{const e=await L(w(d,"users",a.uid));e.exists()&&(f={id:e.id,...e.data()},q(f))}catch(e){console.error("Error loading user data:",e)}}async function C(){try{const e=h(p(d,"conversations"),v("participants","array-contains",a.uid)),t=await y(e);for(const o of t.docs){const n={id:o.id,...o.data()},u=n.participants.find(r=>r!==a.uid),s=await L(w(d,"users",u));s.exists()&&(n.otherUser={id:s.id,...s.data()},g.push(n))}$()}catch(e){console.error("Error loading conversations:",e)}}async function H(){try{const e=h(p(d,"conversations"),v("participants","array-contains",a.uid)),t=await y(e);for(const o of t.docs){const n=h(p(d,"conversations",o.id,"messages"),v("type","==","date_proposal"));(await y(n)).forEach(s=>{const r={id:s.id,conversationId:o.id,...s.data()},i=o.data(),c=i.participants.find(l=>l!==a.uid),m=i.participantsData?.[c];I.push({id:r.id,conversationId:o.id,date:r.date,time:r.time,place:r.place,status:r.status,otherUserAlias:m?.alias||"Usuario",senderId:r.senderId})})}x()}catch(e){console.error("Error loading dates:",e)}}function $(){const e=document.getElementById("report-user");if(g.length===0){e.innerHTML='<option value="">No tienes conversaciones aún</option>',e.disabled=!0;return}e.innerHTML='<option value="">Selecciona un usuario...</option>',g.forEach(t=>{const o=document.createElement("option");o.value=t.otherUser.id,o.textContent=t.otherUser.alias||t.otherUser.email||"Usuario",o.dataset.alias=t.otherUser.alias||"Usuario",o.dataset.gender=t.otherUser.gender||"",e.appendChild(o)}),B&&(e.value=B)}function x(){const e=document.getElementById("report-date");if(I.length===0){e.innerHTML='<option value="">No tienes citas aún</option>',e.disabled=!0;return}e.innerHTML='<option value="">Selecciona una cita...</option>',I.forEach(t=>{const o=document.createElement("option");o.value=`${t.conversationId}|${t.id}`,o.textContent=`Cita con ${t.otherUserAlias} (${t.date} - ${t.time})`,o.dataset.date=t.date,o.dataset.time=t.time,o.dataset.place=t.place,e.appendChild(o)})}function O(){const e=document.getElementById("report-type"),t=document.getElementById("user-report-section"),o=document.getElementById("date-report-section"),n=document.getElementById("report-form");U==="user"?(e.value="user",t.classList.remove("hidden")):U==="date"&&(e.value="date",o.classList.remove("hidden")),e.addEventListener("change",()=>{e.value==="user"?(t.classList.remove("hidden"),o.classList.add("hidden"),document.getElementById("report-date").removeAttribute("required"),document.getElementById("report-user").setAttribute("required","required")):e.value==="date"?(o.classList.remove("hidden"),t.classList.add("hidden"),document.getElementById("report-user").removeAttribute("required"),document.getElementById("report-date").setAttribute("required","required")):(t.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("report-user").removeAttribute("required"),document.getElementById("report-date").removeAttribute("required"))}),n.addEventListener("submit",R)}async function R(e){e.preventDefault();const t=document.getElementById("submitBtn"),o=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';try{const n=document.getElementById("report-type").value,u=document.getElementById("report-reason").value,s=document.getElementById("report-description").value;let r={reporterId:a.uid,reporterAlias:f.alias||a.email,reporterEmail:a.email,type:n,reason:u,description:s,status:"pending",createdAt:E(),updatedAt:E()};if(n==="user"){const i=document.getElementById("report-user").value,c=document.querySelector(`#report-user option[value="${i}"]`);r.reportedUserId=i,r.reportedUserAlias=c?.dataset.alias||"Usuario"}else if(n==="date"){const i=document.getElementById("report-date").value,[c,m]=i.split("|"),l=document.querySelector(`#report-date option[value="${i}"]`);r.conversationId=c,r.dateId=m,r.dateInfo={date:l?.dataset.date,time:l?.dataset.time,place:l?.dataset.place}}await T(p(d,"reports"),r),console.log("Report submitted:",r),document.getElementById("successModal").classList.remove("opacity-0","pointer-events-none")}catch(n){console.error("Error submitting report:",n),A("Error al enviar el reporte. Intenta nuevamente.","error"),t.disabled=!1,t.innerHTML=o}}window.closeSuccessModal=function(){document.getElementById("successModal").classList.add("opacity-0","pointer-events-none"),window.location.href="/conversaciones.html"};
