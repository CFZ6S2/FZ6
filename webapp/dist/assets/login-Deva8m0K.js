import{a as l,d as g}from"./firebase-config-env-BtJ4KElt.js";/* empty css               */import"./firebase-appcheck-B5Dlx5A0.js";import{s as E}from"./sanitizer-CcqdHDpm.js";import{v as h,R as u,s as f,h as v,a as p}from"./network-error-handler-B4Bzh62h.js";import{l as d}from"./logger-CnI7WBtq.js";import{i as w}from"./demo-mode-hXQ_XCDZ.js";import{sendPasswordResetEmail as S,browserLocalPersistence as I,browserSessionPersistence as y,setPersistence as _,signInWithEmailAndPassword as T}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDoc as A,doc as L}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";class b{constructor(){this.storageKey="security_events",this.maxEvents=100}_getEvents(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("Error reading security events:",e),[]}}_saveEvents(e){try{const t=e.slice(-this.maxEvents);localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(t){console.error("Error saving security events:",t)}}_logEvent(e,t,o,r={}){const s={type:e,severity:t,message:o,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href,data:r},n=this._getEvents();n.push(s),this._saveEvents(n);const c={critical:"üö®",high:"‚ö†Ô∏è",medium:"‚ö°",low:"‚ÑπÔ∏è"}[t]||"üìã";return console.warn(`${c} SECURITY [${t.toUpperCase()}]: ${o}`,r),s}_sendToBackend(e){}logFailedLogin(e,t="Invalid credentials"){return this._logEvent("FAILED_LOGIN","medium",`Failed login attempt for ${e}`,{email:e,reason:t})}logSuccessfulLogin(e,t){return this._logEvent("SUCCESSFUL_LOGIN","low",`Successful login for ${t}`,{userId:e,email:t})}logLogout(e){return this._logEvent("LOGOUT","low","User logged out",{userId:e})}logRateLimitExceeded(e,t){return this._logEvent("RATE_LIMIT_EXCEEDED","high",`Rate limit exceeded for ${e}`,{action:e,identifier:t})}logXSSAttempt(e,t){return this._logEvent("XSS_ATTEMPT","critical","Potential XSS attack detected",{input:e.substring(0,200),location:t})}logSQLInjectionAttempt(e,t){return this._logEvent("SQL_INJECTION_ATTEMPT","critical","Potential SQL injection detected",{input:e.substring(0,200),location:t})}logUnauthorizedAccess(e,t=null){return this._logEvent("UNAUTHORIZED_ACCESS","high",`Unauthorized access attempt to ${e}`,{resource:e,userId:t})}logSessionHijackAttempt(e){return this._logEvent("SESSION_HIJACK_ATTEMPT","critical","Potential session hijacking detected",{reason:e})}logCSRFAttempt(e){return this._logEvent("CSRF_ATTEMPT","high","Potential CSRF attack detected",{action:e})}logSuspiciousActivity(e,t={}){return this._logEvent("SUSPICIOUS_ACTIVITY","medium",e,t)}logDataBreachAttempt(e,t){return this._logEvent("DATA_BREACH_ATTEMPT","critical",`Data breach attempt detected: ${e}`,{dataType:e,method:t})}logPasswordChange(e){return this._logEvent("PASSWORD_CHANGE","medium","Password changed",{userId:e})}logEmailChange(e,t,o){return this._logEvent("EMAIL_CHANGE","medium","Email address changed",{userId:e,oldEmail:t,newEmail:o})}logValidationFailure(e,t,o){return this._logEvent("VALIDATION_FAILURE","low",`Validation failed for ${e}`,{field:e,value:t?.substring(0,50),reason:o})}getEventsByType(e){return this._getEvents().filter(o=>o.type===e)}getEventsBySeverity(e){return this._getEvents().filter(o=>o.severity===e)}getRecentEvents(e=10){return this._getEvents().slice(-e).reverse()}getEventsInRange(e,t){return this._getEvents().filter(r=>{const s=new Date(r.timestamp);return s>=e&&s<=t})}getEventStats(){const e=this._getEvents(),t={};return e.forEach(o=>{t[o.type]=(t[o.type]||0)+1}),t}detectAttackPattern(){const e=this.getRecentEvents(20),t=e.filter(r=>r.type==="FAILED_LOGIN"&&new Date(r.timestamp)>new Date(Date.now()-3e5));if(t.length>=5)return this._logEvent("ATTACK_PATTERN_DETECTED","critical","Brute force attack pattern detected",{failedAttempts:t.length}),!0;const o=e.filter(r=>r.type==="XSS_ATTEMPT");return o.length>=3?(this._logEvent("ATTACK_PATTERN_DETECTED","critical","Multiple XSS attempts detected",{attempts:o.length}),!0):!1}clearLogs(){localStorage.removeItem(this.storageKey),console.log("Security logs cleared")}exportLogs(){const e=this._getEvents(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),r=document.createElement("a");r.href=o,r.download=`security-logs-${new Date().toISOString()}.json`,r.click(),URL.revokeObjectURL(o)}}const m=new b;window.verifyRecaptchaScore=async function(a){return console.warn("üëª verifyRecaptchaScore invocado (shim local). Retornando √©xito."),{success:!0,score:1,action:"login"}};l.onAuthStateChanged(a=>{a&&a.emailVerified&&(window.location.href="/buscar-usuarios.html")});function i(a,e="info"){const t=document.createElement("div");t.className=`glass-strong rounded-lg p-4 shadow-lg transform transition-all duration-300 ${e==="success"?"border-l-4 border-green-500":e==="error"?"border-l-4 border-red-500":e==="warning"?"border-l-4 border-yellow-500":"border-l-4 border-blue-500"}`;const o=e==="success"?"fa-check-circle":e==="error"?"fa-exclamation-circle":e==="warning"?"fa-exclamation-triangle":"fa-info-circle",r=e==="success"?"text-green-400":e==="error"?"text-red-400":e==="warning"?"text-yellow-400":"text-blue-400",s=E.text(a);t.innerHTML=`
        <div class="flex items-center gap-3">
          <i class="fas ${o} ${r} text-xl"></i>
          <span class="text-white">${s}</span>
        </div>
      `,document.getElementById("toastContainer").appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>t.remove(),300)},4e3)}document.getElementById("togglePassword").addEventListener("click",function(){const a=document.getElementById("password"),e=this.querySelector("i");a.type==="password"?(a.type="text",e.classList.remove("fa-eye"),e.classList.add("fa-eye-slash")):(a.type="password",e.classList.remove("fa-eye-slash"),e.classList.add("fa-eye"))});document.getElementById("forgotPassword").addEventListener("click",async function(a){a.preventDefault();const e=document.getElementById("email").value;if(!e){i("Por favor ingresa tu correo electr√≥nico","warning"),document.getElementById("email").focus();return}try{await S(l,e),i("Correo de recuperaci√≥n enviado. Revisa tu bandeja de entrada.","success")}catch(t){d.error("Error sending password reset:",t),t.code==="auth/user-not-found"?i("No existe una cuenta con este correo electr√≥nico","error"):i("Error al enviar correo de recuperaci√≥n: "+t.message,"error")}});document.getElementById("loginForm").addEventListener("submit",async function(a){a.preventDefault();const e=document.getElementById("email").value.trim(),t=document.getElementById("password").value,o=document.getElementById("rememberMe").checked,r=document.getElementById("loginButton");if(!h.email(e)){i("Por favor ingresa un email v√°lido","error");return}if(!t||t.length<6){i("Contrase√±a inv√°lida","error");return}if(!u.login.tryRequest(e)){const s=u.login.getRetryAfter(e);f("inicio de sesi√≥n",s);return}r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando sesi√≥n...';try{await _(l,o?I:y);const c=(await T(l,e,t)).user;if((await c.getIdTokenResult()).claims.role==="admin")d.info("Admin login - bypassing email verification and profile checks",{uid:c.uid});else{if(!c.emailVerified){i("Por favor verifica tu correo electr√≥nico antes de iniciar sesi√≥n","warning"),await l.signOut(),r.disabled=!1,r.innerHTML='<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n';return}if(!(await A(L(g,"users",c.uid))).exists()){i("Error: Perfil de usuario no encontrado","error"),await l.signOut(),r.disabled=!1,r.innerHTML='<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n';return}}m.logSuccessfulLogin(c.uid,e),i("¬°Bienvenido de vuelta!","success"),setTimeout(()=>{window.location.href="/buscar-usuarios.html"},1e3)}catch(s){if(console.error("‚ùå LOGIN FAILURE DEBUG INFO:"),console.error("   Message:",s.message),console.error("   Code:",s.code),console.error("   Full Error:",JSON.stringify(s,null,2)),d.error("Login error:",s.message||s),s.code==="auth/network-request-failed"||s.code==="auth/internal-error"||s.code==="auth/unavailable"||s.code==="auth/timeout"){const n=v(s,"inicio de sesi√≥n");if(p(n,i),console.error("[LOGIN NETWORK ERROR]",{code:s.code,hostname:location.hostname,protocol:location.protocol,online:navigator.onLine,timestamp:new Date().toISOString()}),n.isDomainIssue||location.hostname==="localhost"||location.hostname==="127.0.0.1")try{console.log("üîÑ Activando modo demo autom√°ticamente para login...");const c={uid:"demo_user_123",email:e,displayName:"Usuario Demo",role:"user",subscription:"free",isDemo:!0,loginTime:new Date().toISOString(),demoMessage:"Modo demo activado - dominio no autorizado en Firebase"};localStorage.setItem("demoUser",JSON.stringify(c)),localStorage.setItem("demoToken","demo_token_"+Date.now()),localStorage.setItem("isDemoMode","true"),i("‚úÖ Modo demo activado autom√°ticamente","success"),i("üéØ Inicio de sesi√≥n demo exitoso","info"),i("üí° Nota: Est√°s en modo demo - funcionalidad limitada","warning"),setTimeout(()=>{window.location.href="/buscar-usuarios.html?demo=true&auto=true"},3e3);return}catch(c){console.error("Demo mode error:",c),i("‚ùå Error incluso en modo demo","error")}}else{let n="Error al iniciar sesi√≥n";switch(s.code){case"auth/invalid-email":n="Correo electr√≥nico inv√°lido";break;case"auth/user-disabled":n="Esta cuenta ha sido deshabilitada";break;case"auth/user-not-found":n="No existe una cuenta con este correo";break;case"auth/wrong-password":n="Contrase√±a incorrecta";break;case"auth/invalid-credential":n="Credenciales inv√°lidas. Verifica tu correo y contrase√±a";break;case"auth/too-many-requests":n="Demasiados intentos fallidos. Intenta m√°s tarde";break;default:n=s.message}m.logFailedLogin(e,n),i(n,"error")}r.disabled=!1,r.innerHTML='<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n'}});w();
