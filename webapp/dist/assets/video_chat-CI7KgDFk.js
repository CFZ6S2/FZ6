import{d as r,a as E}from"./firebase-config-env-BtJ4KElt.js";/* empty css               */import{serverTimestamp as h,setDoc as y,doc as l,updateDoc as I,onSnapshot as p,collection as C,addDoc as g,deleteDoc as b,getDoc as k}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{s as c}from"./utils-B649B8Z6.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";const w={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun.services.mozilla.com"},{urls:"stun:global.stun.twilio.com:3478"}],iceCandidatePoolSize:10};class v{constructor(e,t,n){this.conversationId=e,this.currentUserId=t,this.remoteUserId=n,this.peerConnection=null,this.localStream=null,this.remoteStream=null,this.unsubscribeOffer=null,this.unsubscribeAnswer=null,this.unsubscribeIceCandidates=null,this.isCallActive=!1,this.isMuted=!1,this.isVideoOff=!1,this.isScreenSharing=!1,this.onRemoteStream=null,this.onCallEnded=null,this.onError=null,this.onStatusChange=null}async startCall(e,t){try{this.updateStatus("Iniciando llamada..."),this.localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),e.srcObject=this.localStream,this.peerConnection=new RTCPeerConnection(w),this.localStream.getTracks().forEach(o=>{this.peerConnection.addTrack(o,this.localStream)}),this.remoteStream=new MediaStream,t.srcObject=this.remoteStream,this.peerConnection.ontrack=o=>{o.streams[0].getTracks().forEach(d=>{this.remoteStream.addTrack(d)}),this.updateStatus("Conectado"),this.onRemoteStream&&this.onRemoteStream(this.remoteStream)},this.peerConnection.onicecandidate=o=>{o.candidate&&this.addIceCandidate("caller",o.candidate.toJSON())},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection state:",this.peerConnection.connectionState),this.peerConnection.connectionState==="connected"?(this.isCallActive=!0,this.updateStatus("Conectado")):this.peerConnection.connectionState==="disconnected"?(this.updateStatus("Desconectado"),this.endCall()):this.peerConnection.connectionState==="failed"&&(this.updateStatus("Fallo de conexión"),this.handleError(new Error("Fallo de conexión WebRTC")))},this.updateStatus("Creando oferta...");const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const s={type:"offer",offer:{type:n.type,sdp:n.sdp},caller:this.currentUserId,callee:this.remoteUserId,status:"calling",createdAt:h()};return await y(l(r,"conversations",this.conversationId,"calls","current"),s),this.listenForAnswer(),this.listenForRemoteIceCandidates("callee"),this.updateStatus("Llamando..."),!0}catch(n){return this.handleError(n),!1}}async answerCall(e,t,n){try{this.updateStatus("Respondiendo llamada..."),this.localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),e.srcObject=this.localStream,this.peerConnection=new RTCPeerConnection(w),this.localStream.getTracks().forEach(o=>{this.peerConnection.addTrack(o,this.localStream)}),this.remoteStream=new MediaStream,t.srcObject=this.remoteStream,this.peerConnection.ontrack=o=>{o.streams[0].getTracks().forEach(d=>{this.remoteStream.addTrack(d)}),this.updateStatus("Conectado"),this.onRemoteStream&&this.onRemoteStream(this.remoteStream)},this.peerConnection.onicecandidate=o=>{o.candidate&&this.addIceCandidate("callee",o.candidate.toJSON())},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection state:",this.peerConnection.connectionState),this.peerConnection.connectionState==="connected"?(this.isCallActive=!0,this.updateStatus("Conectado")):this.peerConnection.connectionState==="disconnected"?(this.updateStatus("Desconectado"),this.endCall()):this.peerConnection.connectionState==="failed"&&(this.updateStatus("Fallo de conexión"),this.handleError(new Error("Fallo de conexión WebRTC")))},await this.peerConnection.setRemoteDescription(new RTCSessionDescription(n.offer)),this.updateStatus("Creando respuesta...");const s=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(s),await I(l(r,"conversations",this.conversationId,"calls","current"),{answer:{type:s.type,sdp:s.sdp},status:"connected",answeredAt:h()}),this.listenForRemoteIceCandidates("caller"),this.isCallActive=!0,this.updateStatus("Conectado"),!0}catch(s){return this.handleError(s),!1}}listenForAnswer(){const e=l(r,"conversations",this.conversationId,"calls","current");this.unsubscribeAnswer=p(e,async t=>{const n=t.data();if(n&&n.answer&&!this.peerConnection.currentRemoteDescription){this.updateStatus("Respuesta recibida...");const s=new RTCSessionDescription(n.answer);await this.peerConnection.setRemoteDescription(s),this.updateStatus("Conectando...")}})}async addIceCandidate(e,t){const n=C(r,"conversations",this.conversationId,"calls","current",`${e}Candidates`);await g(n,t)}listenForRemoteIceCandidates(e){const t=C(r,"conversations",this.conversationId,"calls","current",`${e}Candidates`);this.unsubscribeIceCandidates=p(t,n=>{n.docChanges().forEach(s=>{if(s.type==="added"){const o=new RTCIceCandidate(s.doc.data());this.peerConnection.addIceCandidate(o)}})})}toggleMute(){if(this.localStream)return this.isMuted=!this.isMuted,this.localStream.getAudioTracks().forEach(e=>{e.enabled=!this.isMuted}),this.isMuted}toggleVideo(){if(this.localStream)return this.isVideoOff=!this.isVideoOff,this.localStream.getVideoTracks().forEach(e=>{e.enabled=!this.isVideoOff}),this.isVideoOff}async toggleScreenShare(e){if(this.isScreenSharing){this.localStream.getVideoTracks()[0].stop();const s=(await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}}})).getVideoTracks()[0];this.localStream.addTrack(s),this.peerConnection.getSenders().find(d=>d.track.kind==="video").replaceTrack(s),e.srcObject=this.localStream,this.isScreenSharing=!1}else try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0}),n=t.getVideoTracks()[0];this.peerConnection.getSenders().find(o=>o.track.kind==="video").replaceTrack(n),e.srcObject=t,this.isScreenSharing=!0,n.onended=()=>{this.toggleScreenShare(e)}}catch(t){console.error("Error compartiendo pantalla:",t),this.handleError(t)}return this.isScreenSharing}async endCall(){this.updateStatus("Finalizando llamada..."),this.localStream&&this.localStream.getTracks().forEach(e=>e.stop()),this.peerConnection&&this.peerConnection.close(),this.unsubscribeOffer&&this.unsubscribeOffer(),this.unsubscribeAnswer&&this.unsubscribeAnswer(),this.unsubscribeIceCandidates&&this.unsubscribeIceCandidates();try{await b(l(r,"conversations",this.conversationId,"calls","current"))}catch(e){console.error("Error eliminando llamada:",e)}await this.saveToHistory(),this.isCallActive=!1,this.localStream=null,this.remoteStream=null,this.peerConnection=null,this.updateStatus("Llamada finalizada"),this.onCallEnded&&this.onCallEnded()}async saveToHistory(){try{await g(C(r,"conversations",this.conversationId,"callHistory"),{participants:[this.currentUserId,this.remoteUserId],caller:this.currentUserId,startedAt:h(),endedAt:h(),duration:0})}catch(e){console.error("Error guardando historial:",e)}}updateStatus(e){console.log("Video Chat Status:",e),this.onStatusChange&&this.onStatusChange(e)}handleError(e){console.error("Video Chat Error:",e);let t="Error en video chat";e.name==="NotAllowedError"?t="Permisos de cámara/micrófono denegados":e.name==="NotFoundError"?t="Cámara o micrófono no encontrados":e.name==="NotReadableError"?t="Cámara o micrófono en uso por otra aplicación":e.message&&(t=e.message),this.updateStatus(`Error: ${t}`),this.onError&&this.onError(e,t)}static isSupported(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.RTCPeerConnection)}}function T(a,e,t){const n=l(r,"conversations",a,"calls","current");return p(n,s=>{const o=s.data();o&&o.status==="calling"&&o.callee===e&&t(o)})}let i=null,u=null,m=null,f=null,S=null;document.addEventListener("DOMContentLoaded",async()=>{if(u=E.currentUser,!u){window.location.href="login.html";return}if(!v.isSupported()){c("Tu navegador no soporta video chat. Usa Chrome, Firefox o Edge.","error"),setTimeout(()=>window.history.back(),3e3);return}const a=new URLSearchParams(window.location.search);m=a.get("conversationId"),f=a.get("remoteUserId");const e=a.get("action");if(!m||!f){c("Parámetros inválidos","error"),window.history.back();return}await B(),i=new v(m,u.uid,f),i.onRemoteStream=t=>{document.getElementById("waitingMessage").style.display="none",document.getElementById("remoteVideo").muted=!1},i.onCallEnded=()=>{c("Llamada finalizada","info"),setTimeout(()=>window.history.back(),2e3)},i.onError=(t,n)=>{c(n,"error")},i.onStatusChange=t=>{document.getElementById("statusText").textContent=t},e==="call"?R():D(),L()});async function B(){try{const a=await k(l(r,"users",f));if(a.exists()){const e=a.data();document.getElementById("remoteUserName").textContent=e.alias||"Usuario",document.getElementById("callerName").textContent=e.alias||"Usuario"}}catch(a){console.error("Error cargando usuario:",a)}}async function R(){const a=document.getElementById("localVideo"),e=document.getElementById("remoteVideo");await i.startCall(a,e)||(c("Error iniciando llamada","error"),setTimeout(()=>window.history.back(),2e3))}function D(){S=T(m,u.uid,a=>{V(a)})}function V(a){const e=document.getElementById("incomingCallModal");e.classList.remove("hidden"),e.classList.add("flex"),document.getElementById("acceptCallBtn").onclick=async()=>{e.classList.add("hidden");const t=document.getElementById("localVideo"),n=document.getElementById("remoteVideo");await i.answerCall(t,n,a)||(c("Error respondiendo llamada","error"),setTimeout(()=>window.history.back(),2e3))},document.getElementById("declineCallBtn").onclick=()=>{e.classList.add("hidden"),c("Llamada rechazada","info"),window.history.back()}}function L(){document.getElementById("muteBtn").addEventListener("click",()=>{const a=i.toggleMute(),e=document.getElementById("muteBtn"),t=e.querySelector("i");a?(t.className="fas fa-microphone-slash text-2xl",e.classList.add("active")):(t.className="fas fa-microphone text-2xl",e.classList.remove("active"))}),document.getElementById("videoBtn").addEventListener("click",()=>{const a=i.toggleVideo(),e=document.getElementById("videoBtn"),t=e.querySelector("i");a?(t.className="fas fa-video-slash text-2xl",e.classList.add("active")):(t.className="fas fa-video text-2xl",e.classList.remove("active"))}),document.getElementById("screenBtn").addEventListener("click",async()=>{const a=document.getElementById("localVideo"),e=await i.toggleScreenShare(a),t=document.getElementById("screenBtn");e?t.classList.add("active"):t.classList.remove("active")}),document.getElementById("endCallBtn").addEventListener("click",async()=>{await i.endCall()})}window.addEventListener("beforeunload",async()=>{i&&i.isCallActive&&await i.endCall(),S&&S()});
