import{a as I,d as m}from"./firebase-config-env-BtJ4KElt.js";/* empty css               */import{G as $}from"./google-maps-config-env-B4GqPX9R.js";import"./firebase-appcheck-B5Dlx5A0.js";import{onAuthStateChanged as A,signOut as q}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDoc as D,doc as y,query as B,collection as M,where as w,getDocs as L,updateDoc as v,serverTimestamp as E}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{l as z}from"./theme-BOByySXs.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";import"./logger-CnI7WBtq.js";const h=document.createElement("script");h.src=`https://maps.googleapis.com/maps/api/js?key=${$}&libraries=places`;h.async=!0;h.defer=!0;document.head.appendChild(h);let g=null,b=null,a=null,x=null,f=null,u=null;const O=new URLSearchParams(window.location.search);x=O.get("id");x||(window.location.href="/conversaciones.html");A(I,async e=>{e?(g=e,await H(),await R(),_(),F(),document.getElementById("loadingOverlay").classList.add("hidden")):window.location.href="/login.html"});async function H(){try{const e=await D(y(m,"users",g.uid));e.exists()&&(b={id:e.id,...e.data()},z(b))}catch(e){console.error("Error loading user data:",e),r("Error al cargar datos de usuario","error")}}async function R(){try{const e=B(M(m,"conversations"),w("participants","array-contains",g.uid)),o=await L(e);for(const t of o.docs){const n={id:t.id,...t.data()};if(n.proposedDate&&n.proposedDate.id===x){a=n.proposedDate,a.conversationId=n.id;const i=n.participants.find(s=>s!==g.uid);if(i){const s=await D(y(m,"users",i));s.exists()&&(a.otherUser={id:s.id,...s.data()})}break}}if(!a){r("Cita no encontrada","error"),setTimeout(()=>{window.location.href="/conversaciones.html"},2e3);return}G(),Q()}catch(e){console.error("Error loading date data:",e),r("Error al cargar información de la cita","error")}}function G(){const e=document.getElementById("dateInfo"),o=document.getElementById("dateStatusBadge"),t=a.dateTime?.toDate?a.dateTime.toDate():new Date(a.dateTime),n=t.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i=t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});a.validated?(o.textContent="Validada",o.className="status-validated px-4 py-2 rounded-full text-white font-semibold text-sm",document.getElementById("pinSection").classList.add("hidden")):new Date>new Date(t.getTime()+2*60*60*1e3)&&(o.textContent="Expirada",o.className="status-expired px-4 py-2 rounded-full text-white font-semibold text-sm",document.getElementById("pinSection").classList.add("hidden"));const s=sanitizer.text(a.otherUser?.alias||"Usuario"),c=sanitizer.text(n),p=sanitizer.text(i),d=sanitizer.text(a.location||"No especificado"),l=a.depositAmount?sanitizer.text(String(a.depositAmount)):null;e.innerHTML=`
        <div class="bg-white bg-opacity-10 p-4 rounded-lg">
          <p class="text-white text-opacity-70 text-sm">Cita con</p>
          <p class="text-white font-semibold text-lg">${s}</p>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white bg-opacity-10 p-4 rounded-lg">
            <p class="text-white text-opacity-70 text-sm">Fecha</p>
            <p class="text-white font-semibold">${c}</p>
          </div>

          <div class="bg-white bg-opacity-10 p-4 rounded-lg">
            <p class="text-white text-opacity-70 text-sm">Hora</p>
            <p class="text-white font-semibold">${p}</p>
          </div>
        </div>

        <div class="bg-white bg-opacity-10 p-4 rounded-lg">
          <p class="text-white text-opacity-70 text-sm">Lugar</p>
          <p class="text-white font-semibold">${d}</p>
        </div>

        ${l?`
          <div class="bg-gradient-to-r from-green-500 to-emerald-500 bg-opacity-20 border border-green-300 border-opacity-30 p-4 rounded-lg">
            <p class="text-white text-opacity-70 text-sm">Depósito de Seguridad</p>
            <p class="text-white font-bold text-2xl">${l} €</p>
          </div>
        `:""}
      `}function _(){if(!a||!a.coordinates){document.getElementById("map").innerHTML='<div class="flex items-center justify-center h-full bg-gray-800 bg-opacity-50"><p class="text-white">Ubicación no disponible</p></div>';return}const e={lat:a.coordinates.lat,lng:a.coordinates.lng};f=new google.maps.Map(document.getElementById("map"),{center:e,zoom:15,styles:[{elementType:"geometry",stylers:[{color:"#212121"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{elementType:"labels.text.stroke",stylers:[{color:"#212121"}]}]}),new google.maps.Marker({position:e,map:f,title:"Lugar de la cita",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}}),new google.maps.Circle({map:f,center:e,radius:250,fillColor:"#667eea",fillOpacity:.2,strokeColor:"#667eea",strokeOpacity:.5,strokeWeight:2}),navigator.geolocation&&navigator.geolocation.watchPosition(o=>{const t={lat:o.coords.latitude,lng:o.coords.longitude};u?u.setPosition(t):u=new google.maps.Marker({position:t,map:f,title:"Tu ubicación",icon:{url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}});const n=T(t.lat,t.lng,e.lat,e.lng);j(n)})}function T(e,o,t,n){const s=e*Math.PI/180,c=t*Math.PI/180,p=(t-e)*Math.PI/180,d=(n-o)*Math.PI/180,l=Math.sin(p/2)*Math.sin(p/2)+Math.cos(s)*Math.cos(c)*Math.sin(d/2)*Math.sin(d/2);return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function j(e){const o=document.getElementById("locationStatus"),t=document.getElementById("rule1");e<=250?(o.className="bg-green-500 bg-opacity-20 border border-green-300 border-opacity-30 rounded-lg p-4",o.innerHTML=`
          <p class="text-white text-sm">
            <i class="fas fa-check-circle mr-2"></i>
            ¡Estás dentro del área! Distancia: ${Math.round(e)} metros
          </p>
        `,t.querySelector("i").className="fas fa-check-circle text-green-300 text-sm"):(o.className="bg-red-500 bg-opacity-20 border border-red-300 border-opacity-30 rounded-lg p-4",o.innerHTML=`
          <p class="text-white text-sm">
            <i class="fas fa-exclamation-circle mr-2"></i>
            Estás fuera del área. Distancia: ${Math.round(e)} metros (máximo: 250m)
          </p>
        `)}function Q(){const e=Math.floor(1e3+Math.random()*9e3).toString();document.getElementById("yourPin").textContent=e,a.userPin=e}function F(){const e=[document.getElementById("pin1"),document.getElementById("pin2"),document.getElementById("pin3"),document.getElementById("pin4")];e.forEach((o,t)=>{o.addEventListener("input",n=>{n.target.value.length===1&&t<3&&e[t+1].focus()}),o.addEventListener("keydown",n=>{n.key==="Backspace"&&!n.target.value&&t>0&&e[t-1].focus()})})}document.getElementById("validateBtn").addEventListener("click",async()=>{try{const e=document.getElementById("pin1").value,o=document.getElementById("pin2").value,t=document.getElementById("pin3").value,n=document.getElementById("pin4").value;if((e+o+t+n).length!==4){r("Por favor ingresa el PIN completo","error");return}if(!u){r("No se pudo obtener tu ubicación","error");return}const s=u.getPosition(),c={lat:a.coordinates.lat,lng:a.coordinates.lng};if(T(s.lat(),s.lng(),c.lat,c.lng)>250){r("Debes estar dentro de 250 metros del lugar de la cita","error");return}const d=a.dateTime?.toDate?a.dateTime.toDate():new Date(a.dateTime);if(Math.abs(new Date-d)/1e3/60>30){r("Debes validar dentro de 30 minutos de la hora de la cita","error");return}const k=y(m,"conversations",a.conversationId);await v(k,{"proposedDate.validated":!0,"proposedDate.validatedAt":E(),"proposedDate.validatedBy":g.uid});const P=B(M(m,"payments"),w("dateId","==",x),w("type","==","deposit"));(await L(P)).forEach(async U=>{await v(y(m,"payments",U.id),{status:"completed",completedAt:E()})}),document.getElementById("successModal").classList.remove("opacity-0","pointer-events-none");const N=document.getElementById("rule2"),C=document.getElementById("rule3");N.querySelector("i").className="fas fa-check-circle text-green-300 text-sm",C.querySelector("i").className="fas fa-check-circle text-green-300 text-sm"}catch(e){console.error("Error validating date:",e),r("Error al validar la cita","error")}});document.getElementById("closeSuccessModal").addEventListener("click",()=>{window.location.href="/conversaciones.html"});document.getElementById("logoutBtn").addEventListener("click",async()=>{try{await q(I),window.location.href="/login.html"}catch(e){console.error("Error signing out:",e),r("Error al cerrar sesión","error")}});function r(e,o="success"){const t=document.getElementById("toast"),n=document.getElementById("toastMessage"),i=document.getElementById("toastIcon");n.textContent=e,o==="success"?i.className="fas fa-check-circle text-green-400 text-2xl":o==="error"&&(i.className="fas fa-exclamation-circle text-red-400 text-2xl"),t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},4e3)}
