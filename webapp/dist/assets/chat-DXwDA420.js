import{a as k,d as c}from"./firebase-config-env-BtJ4KElt.js";/* empty css               */import"./error-fixes-B-QQl9aC.js";import"./firebase-appcheck-B5Dlx5A0.js";import{onAuthStateChanged as j}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDoc as C,doc as m,collection as P,query as R,orderBy as z,onSnapshot as q,updateDoc as y,addDoc as T,serverTimestamp as E,increment as N,arrayUnion as B}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{s as n,c as O}from"./utils-B649B8Z6.js";import{l as F}from"./theme-BOByySXs.js";import{a as S}from"./api-service-BrFQUPuu.js";import"./image-optimizer-CfUQm69F.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";import"./logger-CnI7WBtq.js";const U=new URLSearchParams(window.location.search),d=U.get("conversationId"),h=U.get("userId");let g=null,r=null,s=null,x=[],u=null,b=null,p=new Date;(!d||!h)&&(window.location.href="/conversaciones.html");j(k,async e=>{e?(g=e,await H(),_()):window.location.href="/login.html"});async function H(){try{const e=await C(m(c,"users",g.uid));e.exists()&&(r={id:e.id,...e.data()},F(r));const t=await C(m(c,"users",h));t.exists()?(s={id:t.id,...t.data()},Y(),V()):(n("Usuario no encontrado","error"),setTimeout(()=>window.location.href="/conversaciones.html",2e3))}catch(e){console.error("Error loading user data:",e),n("Error al cargar datos","error")}}function Y(){const e=s.alias||"Usuario";if(document.getElementById("otherUserName").textContent=e,document.getElementById("otherUserAvatar").textContent=e.charAt(0).toUpperCase(),s.isOnline&&document.getElementById("onlineIndicator").classList.remove("hidden"),s.emailVerified&&document.getElementById("verifiedBadge").classList.remove("hidden"),r.location&&s.location){const t=O(r.location.lat,r.location.lng,s.location.lat,s.location.lng);document.getElementById("distanceValue").textContent=t.toFixed(1)}if(s.gender==="masculino"&&s.reputation){const t=document.getElementById("reputationBadge"),a={BRONCE:"bg-gradient-to-r from-orange-700 to-orange-900",PLATA:"bg-gradient-to-r from-gray-400 to-gray-600",ORO:"bg-gradient-to-r from-yellow-400 to-yellow-600",PLATINO:"bg-gradient-to-r from-cyan-400 to-blue-500"};t.className=`px-2 py-0.5 text-xs rounded-full font-bold ${a[s.reputation]}`,t.textContent=s.reputation,t.classList.remove("hidden")}if(s.gender==="femenino"&&s.availability){const t=document.getElementById("availabilityBadge"),a={verde:"bg-green-500",amarillo:"bg-yellow-500",rojo:"bg-red-500"};t.className=`w-2 h-2 rounded-full ${a[s.availability]}`,t.title=`Disponibilidad: ${s.availability}`,t.classList.remove("hidden")}}function V(){const e=r.gender==="masculino",t=r.hasActiveSubscription;e&&!t&&(document.getElementById("paymentWarningChat").classList.remove("hidden"),document.getElementById("sendButton").disabled=!0,document.getElementById("messageInput").disabled=!0)}function _(){const e=P(c,"conversations",d,"messages"),t=R(e,z("timestamp","asc"));q(t,a=>{document.getElementById("loadingMessages").classList.add("hidden"),x=[],a.forEach(o=>{x.push({id:o.id,...o.data()})}),G(),J(),W()},a=>{console.error("Error loading messages:",a),n("Error al cargar mensajes","error")})}function G(){const e=document.getElementById("messagesContainer");if(x.length===0){e.innerHTML=`
          <div class="text-center py-8 text-slate-300">
            <i class="fas fa-comment-dots text-4xl mb-3 opacity-50"></i>
            <p>No hay mensajes a√∫n. ¬°Empieza la conversaci√≥n!</p>
          </div>
        `;return}const t=x.map(a=>{const o=a.senderId===g.uid,l=a.timestamp?new Date(a.timestamp.toDate()).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}):"";if(a.type==="date_proposal"){const v=sanitizer.text(a.date||""),M=sanitizer.text(a.time||""),w=sanitizer.text(a.place||""),i=sanitizer.text(a.message||""),D=sanitizer.text(a.id||"");return`
            <div class="flex ${o?"justify-end":"justify-start"}">
              <div class="max-w-[80%] glass-strong rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3 text-pink-400">
                  <i class="fas fa-calendar-heart"></i>
                  <span class="font-bold">Propuesta de Cita</span>
                </div>
                <div class="space-y-2 text-sm">
                  <p><i class="fas fa-calendar text-purple-400 w-5"></i> ${v}</p>
                  <p><i class="fas fa-clock text-purple-400 w-5"></i> ${M}</p>
                  <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> ${w}</p>
                  ${i?`<p class="mt-3 text-slate-300">"${i}"</p>`:""}
                </div>
                <div class="flex gap-2 mt-4">
                  ${!o&&a.status==="pending"?`
                    <button onclick="acceptDate('${D}')" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg text-sm font-bold transition">
                      Aceptar
                    </button>
                    <button onclick="rejectDate('${D}')" class="flex-1 bg-red-500 hover:bg-red-600 py-2 rounded-lg text-sm font-bold transition">
                      Rechazar
                    </button>
                  `:""}
                  ${a.status==="accepted"?'<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i> Aceptada</span>':""}
                  ${a.status==="rejected"?'<span class="text-red-400 text-sm"><i class="fas fa-times-circle"></i> Rechazada</span>':""}
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">${l}</p>
              </div>
            </div>
          `}const f=sanitizer.text(a.text||"");return`
          <div class="flex ${o?"justify-end":"justify-start"}">
            <div class="max-w-[70%] ${o?"message-sent":"message-received"} rounded-2xl px-4 py-3">
              <p class="break-words">${f}</p>
              <p class="text-xs text-white/60 mt-1 text-right">${l}</p>
            </div>
          </div>
        `}).join("");e.innerHTML=t}function J(){const e=document.getElementById("messagesContainer");setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}async function W(){try{const e=m(c,"conversations",d);await y(e,{[`participantsData.${g.uid}.unreadCount`]:0})}catch(e){console.error("Error marking as read:",e)}}window.sendMessage=async function(){const e=document.getElementById("messageInput"),t=e.value.trim();if(!t)return;if(r.gender==="masculino"&&!r.hasActiveSubscription){n("‚ö†Ô∏è Membres√≠a requerida para enviar mensajes","error"),confirm(`Necesitas una membres√≠a activa (‚Ç¨29.99/mes) para enviar mensajes.

¬øDeseas activar tu membres√≠a ahora?`)&&(window.location.href="/suscripcion.html");return}try{e.disabled=!0;const o=await k.currentUser.getIdToken();S.setToken(o);const l=await S.moderateMessage(t);if(!l.is_safe){n(`üö´ Mensaje bloqueado: ${l.reasons[0]||"Contenido inapropiado"}`,"error"),e.disabled=!1,e.focus();return}const f=P(c,"conversations",d,"messages");await T(f,{text:t,senderId:g.uid,timestamp:E(),read:!1,type:"text"});const v=m(c,"conversations",d);await y(v,{lastMessage:t,lastMessageTimestamp:E(),[`participantsData.${h}.unreadCount`]:N(1)}),e.value="",e.style.height="auto",e.disabled=!1,e.focus()}catch(o){console.error("Error sending message:",o),e.disabled=!1,n(`Error al enviar mensaje: ${o.message}`,"error")}};document.getElementById("messageInput").addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"});document.getElementById("messageInput").addEventListener("keydown",function(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),sendMessage())});window.showOptionsMenu=function(){document.getElementById("optionsMenu").classList.remove("opacity-0","pointer-events-none")};window.closeOptionsMenu=function(){document.getElementById("optionsMenu").classList.add("opacity-0","pointer-events-none")};window.reportUser=function(){closeOptionsMenu(),window.location.href=`/reportes.html?type=user&userId=${h}`};window.hideConversation=async function(){try{const e=m(c,"users",g.uid);await y(e,{hiddenConversations:B(d)}),n("Conversaci√≥n ocultada","success"),setTimeout(()=>window.location.href="/conversaciones.html",1e3)}catch(e){console.error("Error hiding conversation:",e),n("Error al ocultar conversaci√≥n","error")}};window.blockUser=function(){document.getElementById("blockUserName").textContent=s.alias||"Este usuario",document.getElementById("blockModal").classList.remove("opacity-0","pointer-events-none"),closeOptionsMenu()};window.closeBlockModal=function(){document.getElementById("blockModal").classList.add("opacity-0","pointer-events-none")};window.confirmBlock=async function(){try{const e=m(c,"users",g.uid);await y(e,{blockedUsers:B(h),hiddenConversations:B(d)}),closeBlockModal(),n("Usuario bloqueado","success"),setTimeout(()=>window.location.href="/conversaciones.html",1e3)}catch(e){console.error("Error blocking user:",e),n("Error al bloquear usuario","error")}};window.startVideoCall=function(){if(r.gender==="masculino"&&!r.hasActiveSubscription){n("üí≥ Membres√≠a Premium requerida para video llamadas","error"),confirm(`Para realizar video llamadas necesitas una Membres√≠a Premium (‚Ç¨29.99/mes).

¬øDeseas suscribirte ahora?`)&&(window.location.href="/suscripcion.html");return}if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){n("Tu navegador no soporta video llamadas. Usa Chrome, Firefox o Edge.","error");return}window.location.href=`/video-chat.html?conversationId=${d}&remoteUserId=${h}&action=call`};window.openDateProposal=function(){if(r.gender==="masculino"&&!r.hasAntiGhostingInsurance){n("üõ°Ô∏è Seguro Anti-Plant√≥n requerido para proponer citas","error"),confirm(`Para proponer y agendar citas necesitas contratar el Seguro Anti-Plant√≥n (‚Ç¨120 pago √∫nico).

Este seguro te protege en caso de plantones y es v√°lido de por vida.

¬øDeseas contratar el seguro ahora?`)&&(window.location.href="/seguro.html");return}document.getElementById("insuranceWarning").classList.add("hidden"),document.getElementById("dateProposalModal").classList.remove("opacity-0","pointer-events-none"),I()};window.closeDateProposal=function(){document.getElementById("dateProposalModal").classList.add("opacity-0","pointer-events-none")};function I(){const e=p.getFullYear(),t=p.getMonth(),a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];document.getElementById("calendarMonth").textContent=`${a[t]} ${e}`;const o=new Date(e,t,1).getDay(),l=new Date(e,t+1,0).getDate(),f=new Date,v=new Date(f.getFullYear(),f.getMonth(),f.getDate()),M=o===0?6:o-1;let w="";for(let i=0;i<M;i++)w+="<div></div>";for(let i=1;i<=l;i++){const L=new Date(e,t,i)<v,A=u&&u.getDate()===i&&u.getMonth()===t&&u.getFullYear()===e;w+=`
          <button
            onclick="selectDate(${e}, ${t}, ${i})"
            class="calendar-day aspect-square rounded-lg glass flex items-center justify-center font-semibold ${L?"disabled opacity-50 cursor-not-allowed":"hover:bg-white/20"} ${A?"selected":""}"
            ${L?"disabled":""}
          >
            ${i}
          </button>
        `}document.getElementById("calendarDays").innerHTML=w}window.selectDate=function(e,t,a){u=new Date(e,t,a),I(),$()};window.previousMonth=function(){p=new Date(p.getFullYear(),p.getMonth()-1,1),I()};window.nextMonth=function(){p=new Date(p.getFullYear(),p.getMonth()+1,1),I()};window.selectTime=function(e){b=e,document.querySelectorAll(".time-slot").forEach(t=>{t.classList.remove("selected","bg-gradient-to-r","from-purple-500","to-pink-500")}),event.target.classList.add("selected","bg-gradient-to-r","from-purple-500","to-pink-500"),$()};function $(){const e=document.getElementById("datePlace").value;if(u&&b&&e){document.getElementById("submitDateProposal").disabled=!1,document.getElementById("dateSummary").classList.remove("hidden");const t=u.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});document.getElementById("summaryDate").textContent=t,document.getElementById("summaryTime").textContent=b,document.getElementById("summaryPlace").textContent=e}else document.getElementById("submitDateProposal").disabled=!0,document.getElementById("dateSummary").classList.add("hidden")}document.getElementById("datePlace").addEventListener("input",$);window.submitDateProposal=async function(){if(r.gender==="masculino"&&!r.hasAntiGhostingInsurance){n("üõ°Ô∏è Seguro Anti-Plant√≥n requerido (‚Ç¨120)","error"),closeDateProposal(),confirm(`Para proponer citas necesitas el Seguro Anti-Plant√≥n.

¬øDeseas contratar el seguro ahora?`)&&(window.location.href="/seguro.html");return}const t=document.getElementById("datePlace").value,a=document.getElementById("dateMessage").value;try{const o=P(c,"conversations",d,"messages");await T(o,{senderId:g.uid,type:"date_proposal",date:u.toLocaleDateString("es-ES"),time:b,place:t,message:a,status:"pending",timestamp:E()});const l=m(c,"conversations",d);await y(l,{lastMessage:"üìÖ Propuesta de cita",lastMessageTime:E(),lastMessageSenderId:g.uid}),closeDateProposal(),n("Propuesta de cita enviada","success"),u=null,b=null,document.getElementById("datePlace").value="",document.getElementById("dateMessage").value=""}catch(o){console.error("Error sending date proposal:",o),n("Error al enviar propuesta","error")}};window.acceptDate=async function(e){try{const t=m(c,"conversations",d,"messages",e);await y(t,{status:"accepted"}),n("Cita aceptada","success")}catch(t){console.error("Error accepting date:",t),n("Error al aceptar cita","error")}};window.rejectDate=async function(e){try{const t=m(c,"conversations",d,"messages",e);await y(t,{status:"rejected"}),n("Cita rechazada","info")}catch(t){console.error("Error rejecting date:",t),n("Error al rechazar cita","error")}};
