<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - TuCitaSegura</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TuCitaSegura">

  <meta name="theme-color" content="#764ba2">

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      height: 100dvh;
      /* Dynamic Viewport Height for mobile browsers */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .messages-container {
      height: 100%;
      overflow-y: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      padding-top: 120px;
      /* Space for fixed header */
      padding-bottom: 180px;
      /* Space for fixed footer */
    }

    .messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    .message-sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin-left: auto;
    }

    .message-received {
      background: rgba(255, 255, 255, 0.2);
    }

    .typing-indicator span {
      animation: blink 1.4s infinite both;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {

      0%,
      80%,
      100% {
        opacity: 0;
      }

      40% {
        opacity: 1;
      }
    }

    /* Calendar styles */
    .calendar-day {
      transition: all 0.2s;
    }

    .calendar-day:hover:not(.disabled) {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.3);
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* CRITICAL: Force black text on mobile chat input */
    #messageInput,
    textarea#messageInput,
    .chat-input,
    input[type="text"].chat-input {
      color: #000000 !important;
      -webkit-text-fill-color: #000000 !important;
      background-color: #ffffff !important;
      opacity: 1 !important;
    }
  </style>
</head>

<body class="text-white">

  <!-- Header -->
  <nav class="fixed top-0 left-0 right-0 glass-strong border-b border-white/20 z-50">
    <div class="container mx-auto px-custom py-3"> <!-- Using px-custom for tweaking -->
      <div class="flex items-center justify-between">
        <!-- User Info -->
        <div class="flex items-center gap-3">
          <a href="/conversaciones.html" class="text-white/80 hover:text-white transition">
            <i class="fas fa-arrow-left text-xl"></i>
          </a>

          <!-- Clickable Profile Trigger -->
          <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition flex-1 min-w-0"
            onclick="viewUserProfile()">
            <div class="relative flex-shrink-0">
              <div id="otherUserAvatar"
                class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-lg overflow-hidden">
                U
              </div>
              <div id="onlineIndicator"
                class="hidden absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full">
              </div>
            </div>
            <div class="flex-1 min-w-0"> <!-- Prevent overflow -->
              <div class="flex items-center gap-2">
                <h1 id="otherUserName" class="text-base md:text-lg font-bold truncate">Usuario</h1>
                <i id="verifiedBadge" class="hidden fas fa-circle-check text-blue-400 text-sm"></i>
              </div>
              <div class="flex items-center gap-2 text-xs md:text-sm">
                <span id="distanceBadge" class="text-slate-300 whitespace-nowrap">
                  <i class="fas fa-location-dot"></i> <span id="distanceValue">-</span> km
                </span>
                <span id="reputationBadge" class="hidden px-2 py-0.5 text-xs rounded-full font-bold"></span>
                <span id="availabilityBadge" class="hidden w-2 h-2 rounded-full" title="Disponibilidad"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
          <div id="language-selector-container" class="relative z-50 mr-2"></div>
          <button id="videoCallBtn" onclick="startVideoCall()"
            class="w-10 h-10 flex items-center justify-center glass-strong rounded-xl active:scale-95 transition bg-blue-600/30 border border-white/10"
            title="Iniciar video llamada">
            <i class="fas fa-video text-white"></i>
          </button>
          <button onclick="openDateProposal()"
            class="w-10 h-10 flex items-center justify-center glass-strong rounded-xl active:scale-95 transition hover:bg-white/10"
            title="Proponer cita">
            <i class="fas fa-calendar-alt text-white"></i>
          </button>
          <button onclick="showOptionsMenu()"
            class="w-10 h-10 flex items-center justify-center glass-strong rounded-xl active:scale-95 transition hover:bg-white/10">
            <i class="fas fa-ellipsis-v text-white"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Messages Container -->
  <!-- Flex-1 ensures it takes available space. overflow-y-auto handles scrolling. -->
  <div id="messagesContainer" class="flex-1 w-full overflow-y-auto messages-container px-4 py-4 space-y-3 relative">
    <!-- Loading State -->
    <div id="loadingMessages" class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white border-t-transparent"></div>
    </div>

    <!-- Messages will be dynamically loaded here -->

    <!-- Typing Indicator inside main container -->
    <div id="typingIndicator" class="hidden py-2">
      <div class="flex items-center gap-2 text-slate-300 text-sm">
        <div class="typing-indicator flex gap-1">
          <span class="w-2 h-2 bg-white rounded-full"></span>
          <span class="w-2 h-2 bg-white rounded-full"></span>
          <span class="w-2 h-2 bg-white rounded-full"></span>
        </div>
        <span data-i18n="chat.typing">escribiendo...</span>
      </div>
    </div>
  </div>

  <!-- Message Input (Footer) -->
  <div class="fixed bottom-0 left-0 right-0 p-3 z-50">
    <div class="container mx-auto">
      <!-- Payment Warning as floating element -->
      <div id="paymentWarningChat" class="hidden mb-2 glass-strong rounded-2xl p-3 border border-yellow-500/50">
        <div class="flex items-center gap-3">
          <i class="fas fa-lock text-yellow-400"></i>
          <p class="text-xs md:text-sm flex-1">Necesitas membres√≠a</p>
          <a href="/suscripcion.html"
            class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1.5 rounded-lg text-xs font-bold transition">
            Activar
          </a>
        </div>
      </div>

      <div class="flex items-end gap-2">
        <div class="flex-1 glass-strong rounded-3xl p-1 pl-2">
          <textarea id="messageInput" rows="1" placeholder="Escribe un mensaje..." data-i18n="chat.placeholder"
            class="w-full px-4 py-3 bg-white text-black placeholder-gray-500 focus:outline-none resize-none text-base rounded-2xl"
            maxlength="1000"
            style="min-height: 48px; max-height: 120px; color: #000000 !important; -webkit-text-fill-color: #000000 !important; background-color: #ffffff !important; opacity: 1 !important;"></textarea>
        </div>
        <button id="sendButton" onclick="sendMessage()"
          class="flex-none w-12 h-12 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-full shadow-lg transition disabled:bg-gray-600 disabled:cursor-not-allowed">
          <i class="fas fa-paper-plane text-white text-lg ml-[-2px]"></i> <!-- Slight offset for visual center -->
        </button>
      </div>
    </div>
  </div>

  <!-- Options Menu -->
  <div id="optionsMenu"
    class="opacity-0 pointer-events-none fixed inset-0 bg-black/80 flex items-end justify-center z-50 p-4"
    onclick="closeOptionsMenu()">
    <div class="glass-strong rounded-2xl w-full max-w-md p-6" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4" data-i18n="chat.options">Opciones</h3>
      <div class="space-y-2">
        <button onclick="hideConversation()"
          class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition">
          <i class="fas fa-eye-slash text-yellow-400"></i>
          <div>
            <div class="font-semibold">Ocultar conversaci√≥n</div>
            <div class="text-sm text-slate-300">No aparecer√° en tu lista</div>
          </div>
        </button>
        <button onclick="reportUser()"
          class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition text-orange-400">
          <i class="fas fa-flag"></i>
          <div>
            <div class="font-semibold">Reportar usuario</div>
            <div class="text-sm text-slate-300">Notificar comportamiento inapropiado</div>
          </div>
        </button>
        <button onclick="blockUser()"
          class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition text-red-400">
          <i class="fas fa-ban"></i>
          <div>
            <div class="font-semibold">Bloquear usuario</div>
            <div class="text-sm text-slate-300">No podr√° contactarte</div>
          </div>
        </button>
        <button onclick="deleteConversation()"
          class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition text-red-500">
          <i class="fas fa-trash"></i>
          <div>
            <div class="font-semibold">Borrar conversaci√≥n</div>
            <div class="text-sm text-slate-300">Eliminar todo el historial</div>
          </div>
        </button>
      </div>
      <button onclick="closeOptionsMenu()"
        class="w-full mt-4 glass hover:glass-strong p-3 rounded-xl font-semibold transition">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Date Proposal Modal -->
  <div id="dateProposalModal"
    class="opacity-0 pointer-events-none fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div class="glass-strong rounded-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">
          <i class="fas fa-calendar-heart text-pink-400 mr-2"></i>
          Proponer Cita
        </h3>
        <button onclick="closeDateProposal()" class="text-white/80 hover:text-white text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Insurance Check -->
      <div id="insuranceWarning" class="hidden mb-6 glass rounded-xl p-4 border-2 border-yellow-500/50">
        <div class="flex items-start gap-3">
          <i class="fas fa-shield-exclamation text-yellow-400 text-xl"></i>
          <div>
            <h4 class="font-bold mb-1">Seguro Anti-Plant√≥n Requerido</h4>
            <p class="text-sm text-slate-300 mb-3">Necesitas el seguro de ‚Ç¨120 para proponer citas</p>
            <a href="/seguro.html"
              class="inline-block bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-bold transition">
              Contratar Seguro
            </a>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div id="calendarContainer" class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <button onclick="previousMonth()" class="glass hover:glass-strong p-2 rounded-lg transition">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h4 id="calendarMonth" class="text-xl font-bold">Enero 2024</h4>
          <button onclick="nextMonth()" class="glass hover:glass-strong p-2 rounded-lg transition">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Days of week -->
        <div class="grid grid-cols-7 gap-2 mb-2">
          <div class="text-center text-sm text-slate-400 font-semibold">L</div>
          <div class="text-center text-sm text-slate-400 font-semibold">M</div>
          <div class="text-center text-sm text-slate-400 font-semibold">X</div>
          <div class="text-center text-sm text-slate-400 font-semibold">J</div>
          <div class="text-center text-sm text-slate-400 font-semibold">V</div>
          <div class="text-center text-sm text-slate-400 font-semibold">S</div>
          <div class="text-center text-sm text-slate-400 font-semibold">D</div>
        </div>

        <!-- Calendar days -->
        <div id="calendarDays" class="grid grid-cols-7 gap-2">
          <!-- Days will be dynamically generated -->
        </div>
      </div>

      <!-- Time Selection -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Hora de la cita</label>
        <div class="grid grid-cols-4 gap-2">
          <button onclick="selectTime('10:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">10:00</button>
          <button onclick="selectTime('12:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">12:00</button>
          <button onclick="selectTime('14:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">14:00</button>
          <button onclick="selectTime('16:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">16:00</button>
          <button onclick="selectTime('18:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">18:00</button>
          <button onclick="selectTime('20:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">20:00</button>
          <button onclick="selectTime('21:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">21:00</button>
          <button onclick="selectTime('22:00')"
            class="time-slot glass hover:glass-strong p-3 rounded-lg transition">22:00</button>
        </div>
      </div>

      <!-- Place Input -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Lugar de la cita</label>
        <input type="text" id="datePlace" placeholder="Ej: Caf√© Central, Calle Mayor 10"
          class="w-full px-4 py-3 rounded-xl glass text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>

      <!-- Message -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Mensaje (opcional)</label>
        <textarea id="dateMessage" rows="3" placeholder="¬øQuieres a√±adir algo?"
          class="w-full px-4 py-3 rounded-xl glass text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
      </div>

      <!-- Selected Date Summary -->
      <div id="dateSummary" class="hidden mb-6 glass rounded-xl p-4">
        <h4 class="font-bold mb-2">Resumen de la cita:</h4>
        <div class="space-y-1 text-sm text-slate-300">
          <p><i class="fas fa-calendar text-purple-400 w-5"></i> <span id="summaryDate"></span></p>
          <p><i class="fas fa-clock text-purple-400 w-5"></i> <span id="summaryTime"></span></p>
          <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> <span id="summaryPlace"></span></p>
        </div>
      </div>

      <!-- Submit Button -->
      <button id="submitDateProposal" onclick="submitDateProposal()" disabled
        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-xl transition">
        Enviar Propuesta de Cita
      </button>
    </div>
  </div>

  <!-- Block Confirmation Modal -->
  <div id="blockModal"
    class="opacity-0 pointer-events-none fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8">
      <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-ban text-4xl text-red-400"></i>
      </div>
      <h3 class="text-2xl font-bold mb-4 text-center">¬øBloquear Usuario?</h3>
      <p class="text-slate-300 mb-6 text-center">
        <span id="blockUserName"></span> no podr√° enviarte m√°s mensajes ni verte en b√∫squedas.
      </p>
      <div class="flex gap-3">
        <button onclick="closeBlockModal()"
          class="flex-1 glass hover:glass-strong font-semibold py-3 px-6 rounded-xl transition">
          Cancelar
        </button>
        <button onclick="confirmBlock()"
          class="flex-1 bg-red-500 hover:bg-red-600 font-bold py-3 px-6 rounded-xl transition">
          Bloquear
        </button>
      </div>
    </div>
  </div>

  <!-- User Details Modal (Added for Chat Profile View) -->
  <div id="userModal"
    class="opacity-0 pointer-events-none fixed inset-0 bg-black/80 modal-backdrop flex items-center justify-center z-50 p-4 transition-opacity duration-300">
    <div
      class="glass-strong rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-content shadow-2xl relative">

      <!-- Modal Header (Cover Image) -->
      <div class="h-40 md:h-52 bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 relative overflow-hidden">
        <div class="absolute inset-0 bg-black/20"></div>
        <!-- Decorative bubbles -->
        <div
          class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full mix-blend-overlay filter blur-3xl transform translate-x-1/2 -translate-y-1/2">
        </div>

        <!-- Close Button (Floating) -->
        <button onclick="closeUserModal()"
          class="absolute top-4 right-4 bg-black/30 hover:bg-black/50 text-white w-10 h-10 rounded-full flex items-center justify-center transition backdrop-blur-sm z-10">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="px-6 md:px-8 pb-8 -mt-16 md:-mt-20 relative z-10">

        <!-- User Avatar & Core Info (Centered) -->
        <div class="flex flex-col items-center text-center mb-8">
          <!-- Avatar -->
          <div class="relative mb-4">
            <div id="modalAvatarContainer"
              class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-slate-900 shadow-2xl overflow-hidden bg-slate-800 flex items-center justify-center relative">
              <!-- Content injected by JS -->
              <span class="text-4xl text-white font-bold">U</span>
            </div>
            <span id="modalOnlineIndicator"
              class="absolute bottom-2 right-2 w-6 h-6 bg-green-500 border-4 border-slate-900 rounded-full hidden z-20"></span>
          </div>

          <!-- Name & Verification -->
          <div class="flex items-center gap-2 mb-1 justify-center">
            <h3 id="modalName" class="text-3xl md:text-4xl font-bold text-white drop-shadow-md">Usuario</h3>
            <i id="modalVerifiedBadge"
              class="fas fa-check-circle text-blue-400 text-xl hidden bg-white rounded-full box-content border-2 border-transparent"
              title="Verificado"></i>
          </div>

          <!-- Meta Info (Age, Distance) -->
          <p class="text-slate-200 text-sm md:text-base flex items-center gap-3 mb-4 font-medium opacity-90">
            <span id="modalAge"><i class="fas fa-birthday-cake mr-1 text-pink-400"></i><span>25 a√±os</span></span>
            <span class="w-1 h-1 bg-slate-400 rounded-full"></span>
            <span id="modalDistance" class="hidden"><i class="fas fa-location-dot mr-1 text-blue-400"></i><span>5
                km</span></span>
            <span class="w-1 h-1 bg-slate-400 rounded-full"></span>
            <span id="modalReputationContainer"></span>
          </p>
        </div>

        <!-- Stats Grid (Compact) -->
        <div class="grid grid-cols-3 gap-2 md:gap-4 mb-8">
          <div class="glass rounded-xl p-3 md:p-4 text-center border border-white/5 hover:bg-white/5 transition">
            <div class="text-xl md:text-2xl font-bold text-blue-400" id="modalCitasCompletadas">0</div>
            <div class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider font-semibold">Citas</div>
          </div>
          <div class="glass rounded-xl p-3 md:p-4 text-center border border-white/5 hover:bg-white/5 transition">
            <div class="text-xl md:text-2xl font-bold text-green-400" id="modalCompatibilidad">--</div>
            <div class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider font-semibold">Compatibilidad
            </div>
          </div>
          <div class="glass rounded-xl p-3 md:p-4 text-center border border-white/5 hover:bg-white/5 transition">
            <div class="text-xl md:text-2xl font-bold text-purple-400" id="modalRespuesta">--</div>
            <div class="text-[10px] md:text-xs text-slate-400 uppercase tracking-wider font-semibold">Respuesta</div>
          </div>
        </div>

        <!-- Bio Section -->
        <div class="mb-8 bg-white/5 rounded-2xl p-6 border border-white/5 relative">
          <i class="fas fa-quote-left absolute top-4 left-4 text-white/10 text-4xl -z-10"></i>
          <h4 class="font-bold mb-2 text-sm uppercase tracking-wider text-slate-400">Sobre m√≠</h4>
          <p id="modalBio" class="text-slate-200 leading-relaxed italic text-lg text-center"></p>
        </div>

        <!-- Photos Gallery (Dynamic) -->
        <div id="modalGallerySection" class="mb-8 hidden">
          <h4 class="font-bold mb-3 text-sm uppercase tracking-wider text-slate-400">Galer√≠a</h4>
          <div id="modalGalleryGrid" class="grid grid-cols-3 md:grid-cols-4 gap-2">
            <!-- Photos injected here -->
          </div>
        </div>

        <!-- Interests Section -->
        <div id="modalInterestsSection" class="mb-8 hidden">
          <h4 class="font-bold mb-3 text-sm uppercase tracking-wider text-slate-400">Intereses</h4>
          <div id="modalInterests" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Map in Modal -->
        <div id="modalMapContainer" class="mb-8 hidden rounded-xl overflow-hidden border border-white/10">
          <div id="userModalMap" class="h-48 w-full"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Error Fixes -->
  <script type="module" src="./js/error-fixes.js"></script>

  <!-- DOMPurify for XSS Protection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script type="module" src="./js/i18n.js"></script>
  <script type="module" src="./js/language-selector.js"></script>
  <script type="module" src="./js/sanitizer.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, db } from './js/firebase-config-env.js';
    import { onAuthStateChanged } from "firebase/auth";
    import {
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      getDoc,
      addDoc,
      updateDoc,
      serverTimestamp,
      arrayUnion,
      where,
      getDocs,
      setDoc,
      increment,
      deleteDoc
    } from "firebase/firestore";
    import {
      showToast,
      calculateDistance,
      requireChatAccess,
      calculateAge,
      getReputationBadge,
      getAvailabilityStatus,
      calculateCompatibility,
      sanitizer
    } from './js/utils.js';
    import { loadTheme } from './js/theme.js';
    import { apiService } from './js/api-service.js';

    // Image optimization with lazy loading
    import './js/image-optimizer.js';

    // Make functions globally available
    window.closeUserModal = function () {
      const modal = document.getElementById('userModal');
      if (modal) {
        modal.classList.add('opacity-0', 'pointer-events-none');
      }
    };

    window.viewUserProfile = function () {
      if (!otherUserData) return;
      const user = otherUserData;
      const modal = document.getElementById('userModal');

      // 1. AVATAR & COVER
      const modalAvatarContainer = document.getElementById('modalAvatarContainer');
      const avatarLetter = (user.alias || user.email || 'U').charAt(0).toUpperCase();

      const photoUrl = user.photoURL || (user.photos && user.photos.length > 0 ? user.photos[0] : null);

      if (photoUrl) {
        modalAvatarContainer.innerHTML = `<img src="${sanitizer.url(photoUrl)}" class="w-full h-full object-cover">`;
      } else {
        modalAvatarContainer.innerHTML = `<span class="text-5xl font-bold text-white">${avatarLetter}</span>`;
      }

      // Online Indicator
      const onlineInd = document.getElementById('modalOnlineIndicator');
      if (user.isOnline) onlineInd.classList.remove('hidden');
      else onlineInd.classList.add('hidden');

      // 2. NAME & INFO
      document.getElementById('modalName').textContent = user.alias || 'Usuario';

      // Verified Badge
      const verBadge = document.getElementById('modalVerifiedBadge');
      if (user.emailVerified) verBadge.classList.remove('hidden');
      else verBadge.classList.add('hidden');

      // Age
      const age = user.birthDate ? calculateAge(user.birthDate) : '?';
      document.getElementById('modalAge').innerHTML = `<i class="fas fa-birthday-cake mr-1 text-pink-400"></i><span>${age} a√±os</span>`;

      // Distance
      const distEl = document.getElementById('modalDistance');
      let distanceVal = null;
      if (currentUserData && currentUserData.location && user.location) {
        distanceVal = calculateDistance(
          currentUserData.location.lat,
          currentUserData.location.lng,
          user.location.lat,
          user.location.lng
        );
      }

      if (distanceVal !== null) {
        distEl.classList.remove('hidden');
        distEl.querySelector('span').textContent = `${distanceVal.toFixed(1)} km`;
      } else {
        distEl.classList.add('hidden');
      }

      // Reputation / Status Badge
      const repCont = document.getElementById('modalReputationContainer');

      if (user.gender === 'femenino') {
        const availabilityStatus = getAvailabilityStatus(user.availabilityStatus || 'available');
        repCont.innerHTML = `<span class="badge ${availabilityStatus.color} text-xs py-0.5 px-2 rounded-full border"><i class="fas ${availabilityStatus.icon}"></i> ${sanitizer.text(availabilityStatus.label)}</span>`;
      } else {
        const reputationBadge = getReputationBadge(user.reputation || 'ORO', user.completedDates || 0);
        repCont.innerHTML = `<span class="badge ${reputationBadge.color} text-xs py-0.5 px-2 rounded-full border">${sanitizer.text(reputationBadge.icon)} ${sanitizer.text(reputationBadge.label)}</span>
              ${user.completedDates >= 5 ? '<i class="fas fa-crown ml-1 text-yellow-300" title="Usuario Experimentado"></i>' : ''}`;
      }

      // 3. BIO
      const bioEl = document.getElementById('modalBio');
      if (user.bio && user.bio.length > 0) {
        bioEl.textContent = `"${user.bio}"`;
        bioEl.classList.remove('text-slate-500', 'not-italic');
        bioEl.classList.add('text-slate-200', 'italic');
      } else {
        bioEl.textContent = "Este usuario prefiere mantener el misterio...";
        bioEl.classList.add('text-slate-500', 'not-italic');
        bioEl.classList.remove('text-slate-200', 'italic');
      }

      // 4. STATS (Deterministic Mock for consistency with search)
      const userIdHash = user.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      document.getElementById('modalCitasCompletadas').textContent = (userIdHash % 20) + 5;

      // Calculate real compatibility if possible
      let compatibility = 0;
      if (currentUserData) {
        compatibility = calculateCompatibility(currentUserData, user);
      } else {
        compatibility = ((userIdHash * 7) % 40) + 60; // Mock fallback
      }
      document.getElementById('modalCompatibilidad').textContent = `${compatibility}%`;
      document.getElementById('modalRespuesta').textContent = `${((userIdHash * 13) % 30) + 65}%`;

      // 5. GALLERY
      const gallerySection = document.getElementById('modalGallerySection');
      const galleryGrid = document.getElementById('modalGalleryGrid');

      if (user.photos && user.photos.length > 1) {
        gallerySection.classList.remove('hidden');
        galleryGrid.innerHTML = user.photos.slice(1).map(url => `
                  <div class="aspect-square rounded-lg overflow-hidden bg-white/5 border border-white/10 group cursor-pointer" onclick="window.open('${sanitizer.url(url)}', '_blank')">
                      <img src="${sanitizer.url(url)}" class="w-full h-full object-cover transition transform group-hover:scale-110">
                  </div>
              `).join('');
      } else {
        gallerySection.classList.add('hidden');
      }

      // 6. INTERESTS
      const interests = ['M√∫sica', 'Viajes', 'Deportes', 'Cine', 'Lectura', 'Baile', 'Cocina', 'Arte', 'Tecnolog√≠a', 'Moda'];
      const interestCount = (userIdHash % 3) + 2;
      const startIndex = userIdHash % interests.length;
      const userInterests = [];
      for (let i = 0; i < interestCount; i++) { userInterests.push(interests[(startIndex + i) % interests.length]); }

      const interestsSec = document.getElementById('modalInterestsSection');
      if (userInterests.length > 0) {
        interestsSec.classList.remove('hidden');
        document.getElementById('modalInterests').innerHTML = userInterests.map(i =>
          `<span class="px-3 py-1 rounded-full bg-white/10 text-xs text-white border border-white/20">${i}</span>`
        ).join('');
      } else {
        interestsSec.classList.add('hidden');
      }

      // Show Modal
      modal.classList.remove('opacity-0', 'pointer-events-none');
    };

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('conversationId');
    const otherUserId = urlParams.get('userId');

    let currentUser = null;
    let currentUserData = null;
    let otherUserData = null;
    let messages = [];
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date();

    // Redirect if missing params
    if (!conversationId || !otherUserId) {
      window.location.href = '/conversaciones.html';
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();

        // ‚úÖ VALIDACI√ìN: Verificar perfil completo + membres√≠a (hombres) antes de permitir chat
        if (currentUserData && !requireChatAccess(currentUserData, window.location.href)) {
          // requireChatAccess redirige autom√°ticamente:
          // - Hombres sin membres√≠a ‚Üí /webapp/suscripcion.html
          // - Perfil incompleto ‚Üí /webapp/perfil.html
          return;
        }

        loadMessages();
      } else {
        window.location.href = '/login.html';
      }
    });

    // Load user data
    async function loadUserData() {
      try {
        // Load current user
        const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (currentUserDoc.exists()) {
          currentUserData = { id: currentUserDoc.id, ...currentUserDoc.data() };

          // Load user theme
          loadTheme(currentUserData);
        }

        // Load other user
        const otherUserDoc = await getDoc(doc(db, 'users', otherUserId));
        if (otherUserDoc.exists()) {
          otherUserData = { id: otherUserDoc.id, ...otherUserDoc.data() };
          updateUserHeader();
          checkPaymentStatus();
        } else {
          showToast('Usuario no encontrado', 'error');
          setTimeout(() => window.location.href = '/conversaciones.html', 2000);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error al cargar datos', 'error');
      }
    }

    // Update user header
    function updateUserHeader() {
      const alias = otherUserData.alias || 'Usuario';
      document.getElementById('otherUserName').textContent = alias;
      document.getElementById('otherUserAvatar').textContent = alias.charAt(0).toUpperCase();

      // Online status
      if (otherUserData.isOnline) {
        document.getElementById('onlineIndicator').classList.remove('hidden');
      }

      // Verified badge
      if (otherUserData.emailVerified) {
        document.getElementById('verifiedBadge').classList.remove('hidden');
      }

      // Distance
      if (currentUserData.location && otherUserData.location) {
        const distance = calculateDistance(
          currentUserData.location.lat,
          currentUserData.location.lng,
          otherUserData.location.lat,
          otherUserData.location.lng
        );
        document.getElementById('distanceValue').textContent = distance.toFixed(1);
      }

      // Reputation (men)
      if (otherUserData.gender === 'masculino' && otherUserData.reputation) {
        const badge = document.getElementById('reputationBadge');
        const repColors = {
          'BRONCE': 'bg-gradient-to-r from-orange-700 to-orange-900',
          'PLATA': 'bg-gradient-to-r from-gray-400 to-gray-600',
          'ORO': 'bg-gradient-to-r from-yellow-400 to-yellow-600',
          'PLATINO': 'bg-gradient-to-r from-cyan-400 to-blue-500'
        };
        badge.className = `px-2 py-0.5 text-xs rounded-full font-bold ${repColors[otherUserData.reputation]}`;
        badge.textContent = otherUserData.reputation;
        badge.classList.remove('hidden');
      }

      // Availability (women)
      if (otherUserData.gender === 'femenino' && otherUserData.availability) {
        const badge = document.getElementById('availabilityBadge');
        const availColors = {
          'verde': 'bg-green-500',
          'amarillo': 'bg-yellow-500',
          'rojo': 'bg-red-500'
        };
        badge.className = `w-2 h-2 rounded-full ${availColors[otherUserData.availability]}`;
        badge.title = `Disponibilidad: ${otherUserData.availability}`;
        badge.classList.remove('hidden');
      }
    }

    // Check payment status
    function checkPaymentStatus() {
      const userMustPay = currentUserData.gender === 'masculino';
      const hasSubscription = currentUserData.hasActiveSubscription;

      if (userMustPay && !hasSubscription) {
        document.getElementById('paymentWarningChat').classList.remove('hidden');
        document.getElementById('sendButton').disabled = true;
        document.getElementById('messageInput').disabled = true;
      }
    }

    // Load messages
    function loadMessages() {
      const messagesRef = collection(db, 'conversations', conversationId, 'messages');
      const q = query(messagesRef, orderBy('timestamp', 'asc'));

      onSnapshot(q, (snapshot) => {
        const loadingEl = document.getElementById('loadingMessages');
        if (loadingEl) {
          loadingEl.classList.add('hidden');
        }

        messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });

        renderMessages();
        scrollToBottom();
        markAsRead();
      }, (error) => {
        console.error('Error loading messages:', error);
        showToast('Error al cargar mensajes', 'error');
      });
    }

    // Render messages
    function renderMessages() {
      const container = document.getElementById('messagesContainer');

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-slate-300">
            <i class="fas fa-comment-dots text-4xl mb-3 opacity-50"></i>
            <p>No hay mensajes a√∫n. ¬°Empieza la conversaci√≥n!</p>
          </div>
        `;
        return;
      }

      // Sanitize and render messages
      const messagesHTML = messages.map(msg => {
        const isSent = msg.senderId === currentUser.uid;
        const timeStr = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '';

        // Check if it's a date proposal
        if (msg.type === 'date_proposal') {
          // Sanitize all user input fields
          const safeDate = sanitizer.text(msg.date || '');
          const safeTime = sanitizer.text(msg.time || '');
          const safePlace = sanitizer.text(msg.place || '');
          const safeMessage = sanitizer.text(msg.message || '');
          const safeId = sanitizer.text(msg.id || '');

          return `
            <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
              <div class="max-w-[80%] glass-strong rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3 text-pink-400">
                  <i class="fas fa-calendar-heart"></i>
                  <span class="font-bold">Propuesta de Cita</span>
                </div>
                <div class="space-y-2 text-sm">
                  <p><i class="fas fa-calendar text-purple-400 w-5"></i> ${safeDate}</p>
                  <p><i class="fas fa-clock text-purple-400 w-5"></i> ${safeTime}</p>
                  <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> ${safePlace}</p>
                  ${safeMessage ? `<p class="mt-3 text-slate-300">"${safeMessage}"</p>` : ''}
                </div>
                <div class="flex gap-2 mt-4">
                  ${!isSent && msg.status === 'pending' ? `
                    <button onclick="acceptDate('${safeId}')" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg text-sm font-bold transition">
                      Aceptar
                    </button>
                    <button onclick="rejectDate('${safeId}')" class="flex-1 bg-red-500 hover:bg-red-600 py-2 rounded-lg text-sm font-bold transition">
                      Rechazar
                    </button>
                  ` : ''}
                  ${msg.status === 'accepted' ? '<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i> Aceptada</span>' : ''}
                  ${msg.status === 'rejected' ? '<span class="text-red-400 text-sm"><i class="fas fa-times-circle"></i> Rechazada</span>' : ''}
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">${timeStr}</p>
              </div>
            </div>
          `;
        }

        // Regular message - sanitize text content
        const safeText = sanitizer.text(msg.text || '');
        return `
          <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
            <div class="max-w-[70%] ${isSent ? 'message-sent' : 'message-received'} rounded-2xl px-4 py-3">
              <p class="break-words">${safeText}</p>
              <p class="text-xs text-white/60 mt-1 text-right">${timeStr}</p>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = messagesHTML;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Scroll to bottom
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // Mark messages as read
    async function markAsRead() {
      try {
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          [`participantsData.${currentUser.uid}.unreadCount`]: 0
        });
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }

    // Send message
    window.sendMessage = async function () {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();

      if (!text) return;

      // Check payment - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasActiveSubscription) {
        showToast('‚ö†Ô∏è Membres√≠a requerida para enviar mensajes', 'error');
        if (confirm('Necesitas una membres√≠a activa (‚Ç¨29.99/mes) para enviar mensajes.\n\n¬øDeseas activar tu membres√≠a ahora?')) {
          window.location.href = '/suscripcion.html';
        }
        return;
      }

      try {
        // Disable input while processing
        input.disabled = true;

        // 1. Moderate Message (Call Backend with Fallback)
        const token = await auth.currentUser.getIdToken();
        apiService.setToken(token);

        try {
          const moderation = await apiService.moderateMessage(text);
          if (!moderation.is_safe) {
            showToast(`üö´ Mensaje bloqueado: ${moderation.reasons[0] || 'Contenido inapropiado'}`, 'error');
            input.disabled = false;
            input.focus();
            return;
          }
        } catch (modError) {
          console.warn('‚ö†Ô∏è Moderation API unreachable/failed. Allowing message as fallback.', modError);
          // Fallback: Proceed without moderation (or implement simple client-side check if needed)
        }

        // 2. Send via Firestore (Serverless Pattern)
        const messagesRef = collection(db, 'conversations', conversationId, 'messages');
        await addDoc(messagesRef, {
          text: text,
          senderId: currentUser.uid,
          timestamp: serverTimestamp(),
          read: false,
          type: 'text'
        });

        // 3. Update Conversation Metadata
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          lastMessage: text,
          lastMessageTimestamp: serverTimestamp(),
          [`participantsData.${otherUserId}.unreadCount`]: increment(1)
        });

        // Clear input
        input.value = '';
        input.style.height = 'auto';
        input.disabled = false;
        input.focus();

      } catch (error) {
        console.error('Error sending message:', error);
        input.disabled = false;
        showToast(`Error al enviar mensaje: ${error.message}`, 'error');
      }
    };

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Send on Enter (Shift+Enter for new line)
    document.getElementById('messageInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Options menu
    window.showOptionsMenu = function () {
      document.getElementById('optionsMenu').classList.remove('opacity-0', 'pointer-events-none');
    };

    window.closeOptionsMenu = function () {
      document.getElementById('optionsMenu').classList.add('opacity-0', 'pointer-events-none');
    };

    // Report user
    window.reportUser = function () {
      closeOptionsMenu();
      window.location.href = `/reportes.html?type=user&userId=${otherUserId}`;
    };

    // Hide conversation
    window.hideConversation = async function () {
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          hiddenConversations: arrayUnion(conversationId)
        });

        showToast('Conversaci√≥n ocultada', 'success');
        setTimeout(() => window.location.href = '/conversaciones.html', 1000);
      } catch (error) {
        console.error('Error hiding conversation:', error);
        showToast('Error al ocultar conversaci√≥n', 'error');
      }
    };

    // Block user
    window.blockUser = function () {
      document.getElementById('blockUserName').textContent = otherUserData.alias || 'Este usuario';
      document.getElementById('blockModal').classList.remove('opacity-0', 'pointer-events-none');
      closeOptionsMenu();
    };

    window.closeBlockModal = function () {
      document.getElementById('blockModal').classList.add('opacity-0', 'pointer-events-none');
    };

    window.confirmBlock = async function () {
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          blockedUsers: arrayUnion(otherUserId),
          hiddenConversations: arrayUnion(conversationId)
        });

        closeBlockModal();
        showToast('Usuario bloqueado', 'success');
        setTimeout(() => window.location.href = '/conversaciones.html', 1000);
      } catch (error) {
        console.error('Error blocking user:', error);
        showToast('Error al bloquear usuario', 'error');
      }
    };

    // Delete conversation
    window.deleteConversation = async function () {
      if (!confirm('¬øEst√°s seguro de que quieres BORRAR esta conversaci√≥n?\n\nEsta acci√≥n NO se puede deshacer.\nSe eliminar√°n todos los mensajes permanentemente.')) {
        return;
      }

      try {
        closeOptionsMenu();
        showToast('Borrando conversaci√≥n...', 'info');

        // Delete all messages in subcollection
        const messagesRef = collection(db, 'conversations', conversationId, 'messages');
        const messagesSnapshot = await getDocs(messagesRef);

        const deletePromises = messagesSnapshot.docs.map(msgDoc => deleteDoc(msgDoc.ref));
        await Promise.all(deletePromises);

        // Delete the conversation document itself
        const conversationRef = doc(db, 'conversations', conversationId);
        await deleteDoc(conversationRef);

        showToast('Conversaci√≥n eliminada', 'success');
        setTimeout(() => window.location.href = '/conversaciones.html', 1000);
      } catch (error) {
        console.error('Error deleting conversation:', error);
        showToast('Error al borrar conversaci√≥n: ' + error.message, 'error');
      }
    };


    // Video call
    window.startVideoCall = function () {
      // Check membership - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasActiveSubscription) {
        showToast('üí≥ Membres√≠a Premium requerida para video llamadas', 'error');
        if (confirm('Para realizar video llamadas necesitas una Membres√≠a Premium (‚Ç¨29.99/mes).\n\n¬øDeseas suscribirte ahora?')) {
          window.location.href = '/suscripcion.html';
        }
        return;
      }

      // Verificar soporte del navegador
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Tu navegador no soporta video llamadas. Usa Chrome, Firefox o Edge.', 'error');
        return;
      }

      // Redirigir a p√°gina de video chat
      window.location.href = `/video-chat.html?conversationId=${conversationId}&remoteUserId=${otherUserId}&action=call`;
    };

    // Date proposal
    window.openDateProposal = function () {
      // Check insurance - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
        showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido para proponer citas', 'error');
        if (confirm('Para proponer y agendar citas necesitas contratar el Seguro Anti-Plant√≥n (‚Ç¨120 pago √∫nico).\n\nEste seguro te protege en caso de plantones y es v√°lido de por vida.\n\n¬øDeseas contratar el seguro ahora?')) {
          window.location.href = '/seguro.html';
        }
        return;
      }

      document.getElementById('insuranceWarning').classList.add('hidden');
      document.getElementById('dateProposalModal').classList.remove('opacity-0', 'pointer-events-none');
      renderCalendar();
      loadGoogleMapsScript(); // Load maps when modal opens
    };

    window.closeDateProposal = function () {
      document.getElementById('dateProposalModal').classList.add('opacity-0', 'pointer-events-none');
    };

    // Calendar functions
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      // Update header
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      // Midnight today for comparison
      const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      // Calculate max date (Today + 14 days)
      const maxDate = new Date(todayMidnight);
      maxDate.setDate(todayMidnight.getDate() + 14);

      // Adjust firstDay (Monday = 0)
      const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

      // Generate calendar days
      let calendarHTML = '';

      // Empty cells before first day
      for (let i = 0; i < adjustedFirstDay; i++) {
        calendarHTML += '<div></div>';
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);

        // Validation: Past or > 14 days future
        const isPast = date < todayMidnight;
        const isTooFar = date > maxDate;
        const isDisabled = isPast || isTooFar;

        const isSelected = selectedDate && selectedDate.getDate() === day &&
          selectedDate.getMonth() === month &&
          selectedDate.getFullYear() === year;

        calendarHTML += `
          <button
            onclick="selectDate(${year}, ${month}, ${day})"
            class="calendar-day aspect-square rounded-lg glass flex items-center justify-center font-semibold ${isDisabled ? 'opacity-30 cursor-not-allowed' : 'hover:bg-white/20'} ${isSelected ? 'selected' : ''}"
            ${isDisabled ? 'disabled' : ''}
            title="${isDisabled ? (isPast ? 'Fecha pasada' : 'Solo puedes reservar hasta 14 d√≠as en adelante') : ''}"
          >
            ${day}
          </button>
        `;
      }

      document.getElementById('calendarDays').innerHTML = calendarHTML;
    }

    window.selectDate = function (year, month, day) {
      selectedDate = new Date(year, month, day);
      renderCalendar();
      updateDateSummary();
    };

    window.previousMonth = function () {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    };

    window.nextMonth = function () {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    };

    window.selectTime = function (time) {
      selectedTime = time;

      // Update UI
      document.querySelectorAll('.time-slot').forEach(btn => {
        btn.classList.remove('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');
      });
      event.target.classList.add('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');

      updateDateSummary();
    };

    function updateDateSummary() {
      const place = document.getElementById('datePlace').value;

      if (selectedDate && selectedTime && place) {
        document.getElementById('submitDateProposal').disabled = false;
        document.getElementById('dateSummary').classList.remove('hidden');

        const dateStr = selectedDate.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        document.getElementById('summaryDate').textContent = dateStr;
        document.getElementById('summaryTime').textContent = selectedTime;
        document.getElementById('summaryPlace').textContent = place;
      } else {
        document.getElementById('submitDateProposal').disabled = true;
        document.getElementById('dateSummary').classList.add('hidden');
      }
    }

    document.getElementById('datePlace').addEventListener('input', updateDateSummary);

    window.submitDateProposal = async function () {
      // Check insurance - DOUBLE VALIDATION (should not reach here without insurance)
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
        showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido (‚Ç¨120)', 'error');
        closeDateProposal();
        if (confirm('Para proponer citas necesitas el Seguro Anti-Plant√≥n.\n\n¬øDeseas contratar el seguro ahora?')) {
          window.location.href = '/seguro.html';
        }
        return;
      }

      const place = document.getElementById('datePlace').value;
      const message = document.getElementById('dateMessage').value;

      try {
        // Add date proposal message
        const messagesRef = collection(db, 'conversations', conversationId, 'messages');
        await addDoc(messagesRef, {
          senderId: currentUser.uid,
          type: 'date_proposal',
          date: selectedDate.toLocaleDateString('es-ES'),
          time: selectedTime,
          place: place,
          message: message,
          status: 'pending',
          timestamp: serverTimestamp()
        });

        // Update conversation
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          lastMessage: 'üìÖ Propuesta de cita',
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: currentUser.uid
        });

        closeDateProposal();
        showToast('Propuesta de cita enviada', 'success');

        // Reset form
        selectedDate = null;
        selectedTime = null;
        document.getElementById('datePlace').value = '';
        document.getElementById('dateMessage').value = '';
      } catch (error) {
        console.error('Error sending date proposal:', error);
        showToast('Error al enviar propuesta', 'error');
      }
    };

    // Google Maps Loader
    import { GOOGLE_MAPS_API_KEY } from './js/google-maps-config-env.js';

    let autocomplete;

    // Load Google Maps Script
    function loadGoogleMapsScript() {
      if (document.querySelector('script[src*="maps.googleapis.com"]')) {
        initAutocomplete(); // Already loaded
        return;
      }

      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initAutocomplete`;
      script.async = true;
      script.defer = true;
      window.initAutocomplete = initAutocomplete; // Global callback
      document.head.appendChild(script);
    }

    // Initialize Autocomplete
    function initAutocomplete() {
      const region = 'es'; // Restrict to Spain if needed, or remove
      const input = document.getElementById('datePlace');

      if (!input) return;

      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['formatted_address', 'name', 'geometry'],
        strictBounds: false,
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.formatted_address) {
          input.value = place.name + (place.formatted_address ? `, ${place.formatted_address}` : '');
          updateDateSummary();
        }
      });

      console.log('üìç Google Places Autocomplete initialized');
    }

    // Call loader when modal opens
    // (This is called inside openDateProposal now)

    // Accept/Reject date
    window.acceptDate = async function (messageId) {
      try {
        const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
        await updateDoc(messageRef, {
          status: 'accepted'
        });
        showToast('Cita aceptada', 'success');
      } catch (error) {
        console.error('Error accepting date:', error);
        showToast('Error al aceptar cita', 'error');
      }
    };

    window.rejectDate = async function (messageId) {
      try {
        const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
        await updateDoc(messageRef, {
          status: 'rejected'
        });
        showToast('Cita rechazada', 'info');
      } catch (error) {
        console.error('Error rejecting date:', error);
        showToast('Error al rechazar cita', 'error');
      }
    };

    // CRITICAL FIX: Force text color on mobile
    document.addEventListener('DOMContentLoaded', function () {
      const input = document.getElementById('messageInput');
      if (input) {
        input.style.setProperty('color', '#000000', 'important');
        input.style.setProperty('-webkit-text-fill-color', '#000000', 'important');
        input.style.setProperty('background-color', '#ffffff', 'important');
        input.style.setProperty('opacity', '1', 'important');
      }
    });

  </script>

  <!-- Demo Mode Banner -->
  <script type="module" src="./js/demo-banner.js"></script>

</body>

</html>