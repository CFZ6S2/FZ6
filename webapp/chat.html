<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - TuCitaSegura</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <!DOCTYPE html>
  <html lang="es">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - TuCitaSegura</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    // Then import Firebase services
    import { auth, db } from './js/firebase-config-env.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
    collection,
    query,
    orderBy,
    onSnapshot,
    doc,
    getDoc,
    addDoc,
    updateDoc,
    serverTimestamp,
    arrayUnion,
    where,
    getDocs,
    setDoc,
    increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { showToast, calculateDistance, requireChatAccess } from './js/utils.js';
    import { loadTheme } from './js/theme.js';
    import { apiService } from './js/api-service.js';

    // Image optimization with lazy loading
    import './js/image-optimizer.js';

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('conversationId');
    const otherUserId = urlParams.get('userId');

    let currentUser = null;
    let currentUserData = null;
    let otherUserData = null;
    let messages = [];
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date();

    // Redirect if missing params
    if (!conversationId || !otherUserId) {
    window.location.href = '/conversaciones.html';
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
    if (user) {
    currentUser = user;
    await loadUserData();

    // ‚úÖ VALIDACI√ìN: Verificar perfil completo + membres√≠a (hombres) antes de permitir chat
    if (currentUserData && !requireChatAccess(currentUserData, window.location.href)) {
    // requireChatAccess redirige autom√°ticamente:
    // - Hombres sin membres√≠a ‚Üí /webapp/suscripcion.html
    // - Perfil incompleto ‚Üí /webapp/perfil.html
    return;
    }

    loadMessages();
    } else {
    window.location.href = '/login.html';
    }
    });

    // Load user data
    async function loadUserData() {
    try {
    // Load current user
    const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
    if (currentUserDoc.exists()) {
    currentUserData = { id: currentUserDoc.id, ...currentUserDoc.data() };

    // Load user theme
    loadTheme(currentUserData);
    }

    // Load other user
    const otherUserDoc = await getDoc(doc(db, 'users', otherUserId));
    if (otherUserDoc.exists()) {
    otherUserData = { id: otherUserDoc.id, ...otherUserDoc.data() };
    updateUserHeader();
    checkPaymentStatus();
    } else {
    showToast('Usuario no encontrado', 'error');
    setTimeout(() => window.location.href = '/conversaciones.html', 2000);
    }
    } catch (error) {
    console.error('Error loading user data:', error);
    showToast('Error al cargar datos', 'error');
    }
    }

    // Update user header
    function updateUserHeader() {
    const alias = otherUserData.alias || 'Usuario';
    document.getElementById('otherUserName').textContent = alias;
    document.getElementById('otherUserAvatar').textContent = alias.charAt(0).toUpperCase();

    // Online status
    if (otherUserData.isOnline) {
    document.getElementById('onlineIndicator').classList.remove('hidden');
    }

    // Verified badge
    if (otherUserData.emailVerified) {
    document.getElementById('verifiedBadge').classList.remove('hidden');
    }

    // Distance
    if (currentUserData.location && otherUserData.location) {
    const distance = calculateDistance(
    currentUserData.location.lat,
    currentUserData.location.lng,
    otherUserData.location.lat,
    otherUserData.location.lng
    );
    document.getElementById('distanceValue').textContent = distance.toFixed(1);
    }

    // Reputation (men)
    if (otherUserData.gender === 'masculino' && otherUserData.reputation) {
    const badge = document.getElementById('reputationBadge');
    const repColors = {
    'BRONCE': 'bg-gradient-to-r from-orange-700 to-orange-900',
    'PLATA': 'bg-gradient-to-r from-gray-400 to-gray-600',
    'ORO': 'bg-gradient-to-r from-yellow-400 to-yellow-600',
    'PLATINO': 'bg-gradient-to-r from-cyan-400 to-blue-500'
    };
    badge.className = `px-2 py-0.5 text-xs rounded-full font-bold ${repColors[otherUserData.reputation]}`;
    badge.textContent = otherUserData.reputation;
    badge.classList.remove('hidden');
    }

    // Availability (women)
    if (otherUserData.gender === 'femenino' && otherUserData.availability) {
    const badge = document.getElementById('availabilityBadge');
    const availColors = {
    'verde': 'bg-green-500',
    'amarillo': 'bg-yellow-500',
    'rojo': 'bg-red-500'
    };
    badge.className = `w-2 h-2 rounded-full ${availColors[otherUserData.availability]}`;
    badge.title = `Disponibilidad: ${otherUserData.availability}`;
    badge.classList.remove('hidden');
    }
    }

    // Check payment status
    function checkPaymentStatus() {
    const userMustPay = currentUserData.gender === 'masculino';
    const hasSubscription = currentUserData.hasActiveSubscription;

    if (userMustPay && !hasSubscription) {
    document.getElementById('paymentWarningChat').classList.remove('hidden');
    document.getElementById('sendButton').disabled = true;
    document.getElementById('messageInput').disabled = true;
    }
    }

    // Load messages
    function loadMessages() {
    const messagesRef = collection(db, 'conversations', conversationId, 'messages');
    const q = query(messagesRef, orderBy('timestamp', 'asc'));

    onSnapshot(q, (snapshot) => {
    document.getElementById('loadingMessages').classList.add('hidden');

    messages = [];
    snapshot.forEach((doc) => {
    messages.push({ id: doc.id, ...doc.data() });
    });

    renderMessages();
    scrollToBottom();
    markAsRead();
    }, (error) => {
    console.error('Error loading messages:', error);
    showToast('Error al cargar mensajes', 'error');
    });
    }

    // Render messages
    function renderMessages() {
    const container = document.getElementById('messagesContainer');

    if (messages.length === 0) {
    container.innerHTML = `
    <div class="text-center py-8 text-slate-300">
      <i class="fas fa-comment-dots text-4xl mb-3 opacity-50"></i>
      <p>No hay mensajes a√∫n. ¬°Empieza la conversaci√≥n!</p>
    </div>
    `;
    return;
    }

    // Sanitize and render messages
    const messagesHTML = messages.map(msg => {
    const isSent = msg.senderId === currentUser.uid;
    const timeStr = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('es-ES', {
    hour: '2-digit',
    minute: '2-digit'
    }) : '';

    // Check if it's a date proposal
    if (msg.type === 'date_proposal') {
    // Sanitize all user input fields
    const safeDate = sanitizer.text(msg.date || '');
    const safeTime = sanitizer.text(msg.time || '');
    const safePlace = sanitizer.text(msg.place || '');
    const safeMessage = sanitizer.text(msg.message || '');
    const safeId = sanitizer.text(msg.id || '');

    return `
    <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
      <div class="max-w-[80%] glass-strong rounded-2xl p-4">
        <div class="flex items-center gap-2 mb-3 text-pink-400">
          <i class="fas fa-calendar-heart"></i>
          <span class="font-bold">Propuesta de Cita</span>
        </div>
        <div class="space-y-2 text-sm">
          <p><i class="fas fa-calendar text-purple-400 w-5"></i> ${safeDate}</p>
          <p><i class="fas fa-clock text-purple-400 w-5"></i> ${safeTime}</p>
          <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> ${safePlace}</p>
          ${safeMessage ? `<p class="mt-3 text-slate-300">"${safeMessage}"</p>` : ''}
        </div>
        <div class="flex gap-2 mt-4">
          ${!isSent && msg.status === 'pending' ? `
          <button onclick="acceptDate('${safeId}')"
            class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg text-sm font-bold transition">
            Aceptar
          </button>
          <button onclick="rejectDate('${safeId}')"
            class="flex-1 bg-red-500 hover:bg-red-600 py-2 rounded-lg text-sm font-bold transition">
            Rechazar
          </button>
          ` : ''}
          ${msg.status === 'accepted' ? '<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i>
            Aceptada</span>' : ''}
          ${msg.status === 'rejected' ? '<span class="text-red-400 text-sm"><i class="fas fa-times-circle"></i>
            Rechazada</span>' : ''}
        </div>
        <p class="text-xs text-slate-400 mt-2 text-right">${timeStr}</p>
      </div>
    </div>
    `;
    }

    // Regular message - sanitize text content
    const safeText = sanitizer.text(msg.text || '');
    return `
    <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
      <div class="max-w-[70%] ${isSent ? 'message-sent' : 'message-received'} rounded-2xl px-4 py-3">
        <p class="break-words">${safeText}</p>
        <p class="text-xs text-white/60 mt-1 text-right">${timeStr}</p>
      </div>
    </div>
    `;
    }).join('');

    container.innerHTML = messagesHTML;
    }

    // Escape HTML
    function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
    }

    // Scroll to bottom
    function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    setTimeout(() => {
    container.scrollTop = container.scrollHeight;
    }, 100);
    }

    // Mark messages as read
    async function markAsRead() {
    try {
    const conversationRef = doc(db, 'conversations', conversationId);
    await updateDoc(conversationRef, {
    [`participantsData.${currentUser.uid}.unreadCount`]: 0
    });
    } catch (error) {
    console.error('Error marking as read:', error);
    }
    }

    // Send message
    window.sendMessage = async function () {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();

    if (!text) return;

    // Check payment - CRITICAL VALIDATION
    const userMustPay = currentUserData.gender === 'masculino';
    if (userMustPay && !currentUserData.hasActiveSubscription) {
    showToast('‚ö†Ô∏è Membres√≠a requerida para enviar mensajes', 'error');
    if (confirm('Necesitas una membres√≠a activa (‚Ç¨29.99/mes) para enviar mensajes.\n\n¬øDeseas activar tu membres√≠a
    ahora?')) {
    window.location.href = '/suscripcion.html';
    }
    return;
    }

    try {
    // Disable input while processing
    input.disabled = true;

    // 1. Moderate Message (Call Backend)
    const token = await auth.currentUser.getIdToken();
    apiService.setToken(token);

    const moderation = await apiService.moderateMessage(text);

    if (!moderation.is_safe) {
    showToast(`üö´ Mensaje bloqueado: ${moderation.reasons[0] || 'Contenido inapropiado'}`, 'error');
    input.disabled = false;
    input.focus();
    return;
    }

    // 2. Send via Firestore (Serverless Pattern)
    const messagesRef = collection(db, 'conversations', conversationId, 'messages');
    await addDoc(messagesRef, {
    text: text,
    senderId: currentUser.uid,
    timestamp: serverTimestamp(),
    read: false,
    type: 'text'
    });

    // 3. Update Conversation Metadata
    const conversationRef = doc(db, 'conversations', conversationId);
    await updateDoc(conversationRef, {
    lastMessage: text,
    lastMessageTimestamp: serverTimestamp(),
    [`participantsData.${otherUserId}.unreadCount`]: increment(1)
    });

    // Clear input
    input.value = '';
    input.style.height = 'auto';
    input.disabled = false;
    input.focus();

    } catch (error) {
    console.error('Error sending message:', error);
    input.disabled = false;
    showToast(`Error al enviar mensaje: ${error.message}`, 'error');
    }
    };

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    });

    // Send on Enter (Shift+Enter for new line)
    document.getElementById('messageInput').addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
    }
    });

    // Options menu
    window.showOptionsMenu = function () {
    document.getElementById('optionsMenu').classList.remove('opacity-0', 'pointer-events-none');
    };

    window.closeOptionsMenu = function () {
    document.getElementById('optionsMenu').classList.add('opacity-0', 'pointer-events-none');
    };

    // Report user
    window.reportUser = function () {
    closeOptionsMenu();
    window.location.href = `/reportes.html?type=user&userId=${otherUserId}`;
    };

    // Hide conversation
    window.hideConversation = async function () {
    try {
    const userRef = doc(db, 'users', currentUser.uid);
    await updateDoc(userRef, {
    hiddenConversations: arrayUnion(conversationId)
    });

    showToast('Conversaci√≥n ocultada', 'success');
    setTimeout(() => window.location.href = '/conversaciones.html', 1000);
    } catch (error) {
    console.error('Error hiding conversation:', error);
    showToast('Error al ocultar conversaci√≥n', 'error');
    }
    };

    // Block user
    window.blockUser = function () {
    document.getElementById('blockUserName').textContent = otherUserData.alias || 'Este usuario';
    document.getElementById('blockModal').classList.remove('opacity-0', 'pointer-events-none');
    closeOptionsMenu();
    };

    window.closeBlockModal = function () {
    document.getElementById('blockModal').classList.add('opacity-0', 'pointer-events-none');
    };

    window.confirmBlock = async function () {
    try {
    const userRef = doc(db, 'users', currentUser.uid);
    await updateDoc(userRef, {
    blockedUsers: arrayUnion(otherUserId),
    hiddenConversations: arrayUnion(conversationId)
    });

    closeBlockModal();
    showToast('Usuario bloqueado', 'success');
    setTimeout(() => window.location.href = '/conversaciones.html', 1000);
    } catch (error) {
    console.error('Error blocking user:', error);
    showToast('Error al bloquear usuario', 'error');
    }
    };

    // Video call
    window.startVideoCall = function () {
    // Check membership - CRITICAL VALIDATION
    const userMustPay = currentUserData.gender === 'masculino';
    if (userMustPay && !currentUserData.hasActiveSubscription) {
    showToast('üí≥ Membres√≠a Premium requerida para video llamadas', 'error');
    if (confirm('Para realizar video llamadas necesitas una Membres√≠a Premium (‚Ç¨29.99/mes).\n\n¬øDeseas suscribirte
    ahora?')) {
    window.location.href = '/suscripcion.html';
    }
    return;
    }

    // Verificar soporte del navegador
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('Tu navegador no soporta video llamadas. Usa Chrome, Firefox o Edge.', 'error');
    return;
    }

    // Redirigir a p√°gina de video chat
    window.location.href = `/video-chat.html?conversationId=${conversationId}&remoteUserId=${otherUserId}&action=call`;
    };

    // Date proposal
    window.openDateProposal = function () {
    // Check insurance - CRITICAL VALIDATION
    const userMustPay = currentUserData.gender === 'masculino';
    if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
    showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido para proponer citas', 'error');
    if (confirm('Para proponer y agendar citas necesitas contratar el Seguro Anti-Plant√≥n (‚Ç¨120 pago √∫nico).\n\nEste
    seguro te protege en caso de plantones y es v√°lido de por vida.\n\n¬øDeseas contratar el seguro ahora?')) {
    window.location.href = '/seguro.html';
    }
    return;
    }

    document.getElementById('insuranceWarning').classList.add('hidden');
    document.getElementById('dateProposalModal').classList.remove('opacity-0', 'pointer-events-none');
    renderCalendar();
    };

    window.closeDateProposal = function () {
    document.getElementById('dateProposalModal').classList.add('opacity-0', 'pointer-events-none');
    };

    // Calendar functions
    function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    // Update header
    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();

    // Create a date object for today at midnight for comparison (prevents mutation bug)
    const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    // Adjust firstDay (Monday = 0)
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

    // Generate calendar days
    let calendarHTML = '';

    // Empty cells before first day
    for (let i = 0; i < adjustedFirstDay; i++) { calendarHTML +='<div></div>' ; } // Days of month for (let day=1; day
      <=daysInMonth; day++) { const date=new Date(year, month, day); const isPast=date < todayMidnight; const
      isSelected=selectedDate && selectedDate.getDate()===day && selectedDate.getMonth()===month &&
      selectedDate.getFullYear()===year; calendarHTML +=` <button onclick="selectDate(${year}, ${month}, ${day})"
      class="calendar-day aspect-square rounded-lg glass flex items-center justify-center font-semibold ${isPast ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-white/20'} ${isSelected ? 'selected' : ''}"
      ${isPast ? 'disabled' : '' }>
      ${day}
      </button>
      `;
      }

      document.getElementById('calendarDays').innerHTML = calendarHTML;
      }

      window.selectDate = function (year, month, day) {
      selectedDate = new Date(year, month, day);
      renderCalendar();
      updateDateSummary();
      };

      window.previousMonth = function () {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
      };

      window.nextMonth = function () {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
      };

      window.selectTime = function (time) {
      selectedTime = time;

      // Update UI
      document.querySelectorAll('.time-slot').forEach(btn => {
      btn.classList.remove('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');
      });
      event.target.classList.add('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');

      updateDateSummary();
      };

      function updateDateSummary() {
      const place = document.getElementById('datePlace').value;

      if (selectedDate && selectedTime && place) {
      document.getElementById('submitDateProposal').disabled = false;
      document.getElementById('dateSummary').classList.remove('hidden');

      const dateStr = selectedDate.toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
      });

      document.getElementById('summaryDate').textContent = dateStr;
      document.getElementById('summaryTime').textContent = selectedTime;
      document.getElementById('summaryPlace').textContent = place;
      } else {
      document.getElementById('submitDateProposal').disabled = true;
      document.getElementById('dateSummary').classList.add('hidden');
      }
      }

      document.getElementById('datePlace').addEventListener('input', updateDateSummary);

      window.submitDateProposal = async function () {
      // Check insurance - DOUBLE VALIDATION (should not reach here without insurance)
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
      showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido (‚Ç¨120)', 'error');
      closeDateProposal();
      if (confirm('Para proponer citas necesitas el Seguro Anti-Plant√≥n.\n\n¬øDeseas contratar el seguro ahora?')) {
      window.location.href = '/seguro.html';
      }
      return;
      }

      const place = document.getElementById('datePlace').value;
      const message = document.getElementById('dateMessage').value;

      try {
      // Add date proposal message
      const messagesRef = collection(db, 'conversations', conversationId, 'messages');
      await addDoc(messagesRef, {
      senderId: currentUser.uid,
      type: 'date_proposal',
      date: selectedDate.toLocaleDateString('es-ES'),
      time: selectedTime,
      place: place,
      message: message,
      status: 'pending',
      timestamp: serverTimestamp()
      });

      // Update conversation
      const conversationRef = doc(db, 'conversations', conversationId);
      await updateDoc(conversationRef, {
      lastMessage: 'üìÖ Propuesta de cita',
      lastMessageTime: serverTimestamp(),
      lastMessageSenderId: currentUser.uid
      });

      closeDateProposal();
      showToast('Propuesta de cita enviada', 'success');

      // Reset form
      selectedDate = null;
      selectedTime = null;
      document.getElementById('datePlace').value = '';
      document.getElementById('dateMessage').value = '';
      } catch (error) {
      console.error('Error sending date proposal:', error);
      showToast('Error al enviar propuesta', 'error');
      }
      };

      // Accept/Reject date
      window.acceptDate = async function (messageId) {
      try {
      const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
      await updateDoc(messageRef, {
      status: 'accepted'
      });
      showToast('Cita aceptada', 'success');
      } catch (error) {
      console.error('Error accepting date:', error);
      showToast('Error al aceptar cita', 'error');
      }
      };

      window.rejectDate = async function (messageId) {
      try {
      const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
      await updateDoc(messageRef, {
      status: 'rejected'
      });
      showToast('Cita rechazada', 'info');
      } catch (error) {
      console.error('Error rejecting date:', error);
      showToast('Error al rechazar cita', 'error');
      }
      };

      </script>

      <!-- Demo Mode Banner -->
      <script type="module" src="./js/demo-banner.js"></script>

      </body>

  </html>