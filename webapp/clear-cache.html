<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clear Cache - TuCitaSegura</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 20px;
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }
    .alert-success {
      background: #d4edda;
      border: 1px solid #28a745;
      color: #155724;
    }
    .alert-info {
      background: #d1ecf1;
      border: 1px solid #17a2b8;
      color: #0c5460;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .step {
      background: #f8f9fa;
      padding: 15px;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
    }
    .code {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      overflow-x: auto;
      margin: 10px 0;
    }
    #status {
      margin-top: 20px;
      min-height: 40px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Clear Browser Cache</h1>

    <div class="alert alert-warning">
      <strong>‚ö†Ô∏è Module Import Error Detected</strong><br>
      If you're seeing errors like "firebase-config.js does not provide export named 'auth'",
      this is likely caused by browser caching. Let's fix it!
    </div>

    <h2>Quick Fix (Recommended)</h2>
    <button onclick="clearAllCaches()">üöÄ Clear All Caches & Reload</button>
    <button onclick="hardReloadOnly()">üîÑ Hard Reload Only</button>

    <div id="status"></div>

    <h2>Manual Steps</h2>

    <div class="step">
      <strong>Option 1: Hard Refresh (Fastest)</strong>
      <ul>
        <li><strong>Windows/Linux:</strong> Press <code>Ctrl + Shift + R</code> or <code>Ctrl + F5</code></li>
        <li><strong>Mac:</strong> Press <code>Cmd + Shift + R</code></li>
      </ul>
    </div>

    <div class="step">
      <strong>Option 2: Clear Cache via DevTools</strong>
      <ol>
        <li>Open DevTools (F12 or Right Click ‚Üí Inspect)</li>
        <li>Right-click the reload button (next to address bar)</li>
        <li>Select "Empty Cache and Hard Reload"</li>
      </ol>
    </div>

    <div class="step">
      <strong>Option 3: Clear All Site Data</strong>
      <ol>
        <li>Open DevTools (F12)</li>
        <li>Go to Application tab</li>
        <li>Click "Clear storage" in left sidebar</li>
        <li>Click "Clear site data" button</li>
        <li>Reload the page</li>
      </ol>
    </div>

    <h2>What Gets Cleared?</h2>
    <ul>
      <li>‚úÖ Browser Cache (HTTP Cache)</li>
      <li>‚úÖ Service Worker Cache</li>
      <li>‚úÖ LocalStorage (Firebase App Check data)</li>
      <li>‚úÖ SessionStorage</li>
      <li>‚úÖ IndexedDB (Firebase installations, heartbeat)</li>
      <li>‚ö†Ô∏è Cookies (you may need to log in again)</li>
    </ul>

    <div class="alert alert-info">
      <strong>üí° Why does this happen?</strong><br>
      Modern browsers aggressively cache JavaScript modules for performance.
      When code is updated, the browser might serve old cached versions,
      causing module import errors.
    </div>

    <h2>Verify Fix Worked</h2>
    <button onclick="testModuleImport()">üß™ Test Module Import</button>
    <div id="testResult"></div>
  </div>

  <script>
    const status = document.getElementById('status');
    const testResult = document.getElementById('testResult');

    async function showStatus(message, type = 'info') {
      status.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    async function clearAllCaches() {
      showStatus('<div class="spinner"></div> Clearing all caches...', 'info');

      let cleared = [];

      try {
        // 1. Clear Cache Storage (Service Worker cache)
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          cleared.push(`‚úÖ Cache Storage (${cacheNames.length} caches)`);
        }
      } catch (e) {
        cleared.push('‚ö†Ô∏è Cache Storage: ' + e.message);
      }

      try {
        // 2. Unregister Service Workers
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(registrations.map(reg => reg.unregister()));
          cleared.push(`‚úÖ Service Workers (${registrations.length} unregistered)`);
        }
      } catch (e) {
        cleared.push('‚ö†Ô∏è Service Workers: ' + e.message);
      }

      try {
        // 3. Clear LocalStorage (Firebase App Check, etc.)
        const lsKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('firebase') || key.includes('appCheck') || key.includes('fac'))) {
            lsKeys.push(key);
          }
        }
        lsKeys.forEach(key => localStorage.removeItem(key));
        cleared.push(`‚úÖ LocalStorage (${lsKeys.length} Firebase keys)`);
      } catch (e) {
        cleared.push('‚ö†Ô∏è LocalStorage: ' + e.message);
      }

      try {
        // 4. Clear SessionStorage
        sessionStorage.clear();
        cleared.push('‚úÖ SessionStorage');
      } catch (e) {
        cleared.push('‚ö†Ô∏è SessionStorage: ' + e.message);
      }

      try {
        // 5. Clear IndexedDB
        const dbsToDelete = [
          'firebaseLocalStorageDb',
          'firebase-app-check-database',
          'firebase-heartbeat-database',
          'firebase-installations-database'
        ];

        const results = await Promise.all(
          dbsToDelete.map(dbName =>
            new Promise(resolve => {
              const req = indexedDB.deleteDatabase(dbName);
              req.onsuccess = () => resolve(true);
              req.onerror = () => resolve(false);
              req.onblocked = () => resolve(false);
            })
          )
        );

        const deletedCount = results.filter(Boolean).length;
        cleared.push(`‚úÖ IndexedDB (${deletedCount}/${dbsToDelete.length} databases)`);
      } catch (e) {
        cleared.push('‚ö†Ô∏è IndexedDB: ' + e.message);
      }

      // Show results
      const results = cleared.join('<br>');
      showStatus(`
        <strong>Cache Clearing Complete!</strong><br><br>
        ${results}
        <br><br>
        Page will reload in 3 seconds...
      `, 'success');

      // Reload after 3 seconds
      setTimeout(() => {
        location.reload(true);
      }, 3000);
    }

    function hardReloadOnly() {
      showStatus('Performing hard reload...', 'info');
      setTimeout(() => {
        location.reload(true);
      }, 500);
    }

    async function testModuleImport() {
      testResult.innerHTML = '<div class="spinner"></div> Testing module import...';

      try {
        // Dynamically import firebase-config.js
        const module = await import('./js/firebase-config.js');

        const results = [];
        results.push('‚úÖ Module loaded successfully');
        results.push(`‚úÖ auth export: ${typeof module.auth !== 'undefined' ? 'Found' : '‚ùå Missing'}`);
        results.push(`‚úÖ db export: ${typeof module.db !== 'undefined' ? 'Found' : '‚ùå Missing'}`);
        results.push(`‚úÖ storage export: ${typeof module.storage !== 'undefined' ? 'Found' : '‚ùå Missing'}`);
        results.push(`‚úÖ functions export: ${typeof module.functions !== 'undefined' ? 'Found' : '‚ùå Missing'}`);
        results.push(`‚úÖ app export: ${typeof module.default !== 'undefined' ? 'Found' : '‚ùå Missing'}`);

        const allFound = typeof module.auth !== 'undefined' &&
                        typeof module.db !== 'undefined';

        testResult.innerHTML = `
          <div class="alert alert-${allFound ? 'success' : 'warning'}">
            <strong>${allFound ? '‚úÖ All Exports Working!' : '‚ö†Ô∏è Some Exports Missing'}</strong><br><br>
            ${results.join('<br>')}
            ${allFound ? '<br><br>The module import issue is fixed! üéâ' : '<br><br>Try clearing caches again.'}
          </div>
        `;
      } catch (error) {
        testResult.innerHTML = `
          <div class="alert alert-warning">
            <strong>‚ùå Module Import Failed</strong><br><br>
            Error: ${error.message}<br><br>
            Please clear caches and try again.
          </div>
        `;
      }
    }

    // Auto-test on page load
    window.addEventListener('load', () => {
      setTimeout(testModuleImport, 1000);
    });
  </script>
</body>
</html>
