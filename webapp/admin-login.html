<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administración - TuCitaSegura</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">

  <!-- DOMPurify for XSS Protection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<<<<<<< HEAD
  <script type="module" src="./js/sanitizer.js"></script>
=======
  <script type="module" src="/js/sanitizer.js"></script>
>>>>>>> c6ecb8b (Fix Dockerfile and opencv for Cloud Run)

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    .slide-down {
      animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .fade-in-up {
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .delay-100 {
      animation-delay: 0.1s;
      animation-fill-mode: both;
    }

    .delay-200 {
      animation-delay: 0.2s;
      animation-fill-mode: both;
    }

    .delay-300 {
      animation-delay: 0.3s;
      animation-fill-mode: both;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    .glass-input {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    }

    .glass-input:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(168, 85, 247, 0.5);
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.1);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      overflow: hidden;
    }

    .gradient-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(238, 130, 238, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(106, 90, 205, 0.3) 0%, transparent 50%);
      animation: pulse 8s ease-in-out infinite;
    }

    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .logo-glow {
      filter: drop-shadow(0 0 20px rgba(168, 85, 247, 0.5));
    }

    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-text-fill-color: white;
      -webkit-box-shadow: 0 0 0px 1000px rgba(255, 255, 255, 0.08) inset;
      transition: background-color 5000s ease-in-out 0s;
    }
  </style>
</head>

<body class="min-h-screen gradient-bg flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo & Title -->
    <div class="text-center mb-8 slide-down">
      <div
        class="inline-flex items-center justify-center w-24 h-24 rounded-3xl bg-white/10 backdrop-blur-xl mb-6 logo-glow">
        <i class="fas fa-shield-halved text-5xl text-white"></i>
      </div>
      <h1 class="text-4xl font-bold text-white mb-2 tracking-tight">
        Panel Administrativo
      </h1>
      <p class="text-white/70 text-lg">
        TuCitaSegura
      </p>
    </div>

    <!-- Main Card -->
    <div class="glass-card rounded-3xl p-8 mb-6 fade-in-up delay-100">
      <form id="loginForm" class="space-y-6">
        <!-- Email Input -->
        <div>
          <label for="email" class="block text-white font-semibold mb-3 text-sm uppercase tracking-wide">
            <i class="fas fa-envelope mr-2 text-purple-300"></i>
            Correo Electrónico
          </label>
          <input type="email" id="email" autocomplete="email"
            class="glass-input w-full px-4 py-4 rounded-xl text-white placeholder-white/40 focus:outline-none text-lg"
            placeholder="admin@tucitasegura.com" required>
        </div>

        <!-- Password Input -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <label for="password" class="block text-white font-semibold text-sm uppercase tracking-wide">
              <i class="fas fa-lock mr-2 text-purple-300"></i>
              Contraseña
            </label>
            <a href="#" id="forgotPasswordLink" class="text-sm text-purple-300 hover:text-white transition-colors">
              ¿Olvidaste tu contraseña?
            </a>
          </div>
          <div class="relative">
            <input type="password" id="password" autocomplete="current-password"
              class="glass-input w-full px-4 py-4 rounded-xl text-white placeholder-white/40 focus:outline-none text-lg pr-12"
              placeholder="••••••••" required>
            <button type="button" id="togglePassword"
              class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white transition-colors"
              tabindex="-1">
              <i class="fas fa-eye text-xl"></i>
            </button>
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="loginButton"
          class="btn-primary w-full text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg">
          <i class="fas fa-sign-in-alt mr-2"></i>
          Iniciar Sesión
        </button>
      </form>

      <!-- Result Message -->
      <div id="resultMessage" class="mt-6"></div>
    </div>

    <!-- Info Card -->
    <div class="glass-card rounded-2xl p-5 mb-4 fade-in-up delay-200">
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
            <i class="fas fa-info-circle text-purple-300"></i>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-white font-semibold mb-1">Acceso Administrativo</h3>
          <p class="text-white/60 text-sm leading-relaxed">
            Esta página utiliza autenticación directa sin App Check para acceso privilegiado.
          </p>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="text-center fade-in-up delay-300">
      <a href="/login.html"
        class="inline-flex items-center text-white/70 hover:text-white transition-colors text-sm font-medium">
        <i class="fas fa-arrow-left mr-2"></i>
        Volver al login principal
      </a>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8 fade-in-up delay-300">
      <p class="text-white/40 text-xs">
        © 2025 TuCitaSegura. Sistema Administrativo Seguro.
      </p>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
    <div class="glass-card rounded-3xl p-8 max-w-md w-full" style="animation: fadeInUp 0.3s ease-out;">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-500/20 mb-4">
          <i class="fas fa-key text-3xl text-purple-300"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Recuperar Contraseña</h2>
        <p class="text-white/70">Ingresa tu correo para recibir un enlace de recuperación</p>
      </div>

      <form id="forgotPasswordForm" class="space-y-4">
        <div>
          <input type="email" id="resetEmail"
            class="glass-input w-full px-4 py-4 rounded-xl text-white placeholder-white/40 focus:outline-none"
            placeholder="admin@tucitasegura.com" required>
        </div>

        <div id="resetMessage" class="hidden"></div>

        <div class="flex space-x-3">
          <button type="button" id="cancelReset"
            class="flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-xl transition-all">
            Cancelar
          </button>
          <button type="submit" id="sendResetButton"
            class="flex-1 btn-primary text-white font-semibold py-3 px-6 rounded-xl">
            Enviar Enlace
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { auth } from './js/firebase-config-env.js';
    import {
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      setPersistence,
<<<<<<< HEAD
      browserSessionPersistence,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmaE2tXMBsKc8DjBd1ShJ1HnDxVYQ0yzU",
      authDomain: "tucitasegura-129cc.firebaseapp.com",
      databaseURL: "https://tucitasegura-129cc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tucitasegura-129cc",
      storageBucket: "tucitasegura-129cc.firebasestorage.app",
      messagingSenderId: "180656060538",
      appId: "1:180656060538:web:3168487130aa126db663c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
=======
      browserSessionPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
>>>>>>> c6ecb8b (Fix Dockerfile and opencv for Cloud Run)

    // NOTE: App Check is DISABLED for admin login to avoid auth issues
    // You MUST disable App Check enforcement in Firebase Console for this to work:
    // 1. Go to: https://console.firebase.google.com/project/tucitasegura-129cc/appcheck
    // 2. Click on "Firebase Authentication" in the APIs section
    // 3. Change enforcement from "Enforced" to "Unenforced" or "Monitoring"

    console.log('✅ Firebase Auth initialized (App Check disabled for admin)');
    console.warn('⚠️  IMPORTANT: Make sure App Check enforcement is disabled in Firebase Console');
    console.warn('⚠️  URL: https://console.firebase.google.com/project/tucitasegura-129cc/appcheck');

    // Toggle Password Visibility
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');

    togglePassword.addEventListener('click', function () {
      const icon = this.querySelector('i');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });

    // Forgot Password Modal
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    const cancelReset = document.getElementById('cancelReset');

    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      forgotPasswordModal.classList.remove('hidden');
      document.getElementById('resetEmail').value = document.getElementById('email').value;
    });

    cancelReset.addEventListener('click', () => {
      forgotPasswordModal.classList.add('hidden');
      document.getElementById('resetMessage').classList.add('hidden');
    });

    forgotPasswordModal.addEventListener('click', (e) => {
      if (e.target === forgotPasswordModal) {
        forgotPasswordModal.classList.add('hidden');
        document.getElementById('resetMessage').classList.add('hidden');
      }
    });

    // Password Reset Handler
    document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const resetEmail = document.getElementById('resetEmail').value.trim();
      const resetMessage = document.getElementById('resetMessage');
      const sendResetButton = document.getElementById('sendResetButton');

      sendResetButton.disabled = true;
      sendResetButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';

      try {
        const { verifyRecaptchaScore } = await import('./js/recaptcha-enterprise.js');
        const recaptcha = await verifyRecaptchaScore('password_reset_admin');
        if(!recaptcha.success || (recaptcha.score??0) < 0.5){
          resetMessage.innerHTML = `
            <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4">
              <div class="flex items-center text-red-300">
                <i class="fas fa-exclamation-circle text-xl mr-3"></i>
                <p class="text-sm font-semibold">Verificación reCAPTCHA fallida</p>
              </div>
            </div>
          `;
          resetMessage.classList.remove('hidden');
          sendResetButton.disabled = false;
          sendResetButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Enviar';
          return;
        }
        await sendPasswordResetEmail(auth, resetEmail);

        resetMessage.innerHTML = `
          <div class="bg-green-500/20 border border-green-500/50 rounded-xl p-4">
            <div class="flex items-center text-green-300">
              <i class="fas fa-check-circle text-xl mr-3"></i>
              <div class="text-sm">
                <p class="font-semibold">¡Correo enviado!</p>
                <p class="text-green-300/80 mt-1">Revisa tu bandeja de entrada</p>
              </div>
            </div>
          </div>
        `;
        resetMessage.classList.remove('hidden');

        setTimeout(() => {
          forgotPasswordModal.classList.add('hidden');
          resetMessage.classList.add('hidden');
        }, 3000);

      } catch (error) {
        console.error('Reset error:', error);

        let errorMsg = 'Error al enviar el correo';
        if (error.code === 'auth/user-not-found') {
          errorMsg = 'No existe una cuenta con este correo';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'Correo electrónico inválido';
        }

        resetMessage.innerHTML = `
          <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4">
            <div class="flex items-center text-red-300">
              <i class="fas fa-exclamation-circle text-xl mr-3"></i>
              <p class="text-sm font-semibold">${errorMsg}</p>
            </div>
          </div>
        `;
        resetMessage.classList.remove('hidden');
      } finally {
        sendResetButton.disabled = false;
        sendResetButton.innerHTML = 'Enviar Enlace';
      }
    });

    // Login Form Handler
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('resultMessage');
      const loginButton = document.getElementById('loginButton');

      resultDiv.innerHTML = '';
      loginButton.disabled = true;
      loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando credenciales...';

      try {
        await setPersistence(auth, browserSessionPersistence);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        console.log('✅ Login successful:', user.uid);

        // Verify admin role
        const idTokenResult = await user.getIdTokenResult();
        const isAdmin = idTokenResult.claims.role === 'admin';

        if (!isAdmin) {
          await auth.signOut();
          throw new Error('Acceso denegado: Se requieren permisos de administrador');
        }

        // Success
        resultDiv.innerHTML = `
          <div class="bg-green-500/20 border border-green-500/50 rounded-xl p-5">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
                  <i class="fas fa-check-circle text-2xl text-green-300"></i>
                </div>
              </div>
              <div class="flex-1">
                <p class="font-bold text-white text-lg">¡Acceso Autorizado!</p>
                <p class="text-green-300/80 text-sm mt-1">
                  Bienvenido al panel administrativo
                </p>
                <div class="mt-3 flex items-center text-green-300/60 text-xs">
                  <i class="fas fa-circle-notch fa-spin mr-2"></i>
                  Redirigiendo...
                </div>
              </div>
            </div>
          </div>
        `;

        setTimeout(() => {
          window.location.href = '/admin.html';
        }, 1500);

      } catch (error) {
        console.error('❌ Login error:', error);

        let errorMessage = 'Error desconocido';
        let errorIcon = 'fa-exclamation-triangle';

        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          errorMessage = 'Credenciales incorrectas';
          errorIcon = 'fa-lock';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Formato de correo inválido';
          errorIcon = 'fa-envelope';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Demasiados intentos fallidos. Intenta más tarde.';
          errorIcon = 'fa-clock';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'Error de conexión. Verifica tu internet.';
          errorIcon = 'fa-wifi';
        } else if (error.message) {
          errorMessage = error.message;
        }

        resultDiv.innerHTML = `
          <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-5">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
                  <i class="fas ${errorIcon} text-2xl text-red-300"></i>
                </div>
              </div>
              <div class="flex-1">
                <p class="font-bold text-white">Error de Autenticación</p>
                <p class="text-red-300/80 text-sm mt-1">${errorMessage}</p>
              </div>
            </div>
          </div>
        `;

        loginButton.disabled = false;
        loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión';
      }
    });
  </script>
</body>

</html>