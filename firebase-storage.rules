rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helpers con custom claims
    function isAuthed() { return request.auth != null; }
    function role() { return request.auth.token.role; }
    function gender() { return request.auth.token.gender; }

    function isAdmin() { return isAuthed() && (role() == 'admin' || isOwner()); }
    function isOwner() { 
      return request.auth.token.email == 'cesar.herrera.rojo@gmail.com' || 
             request.auth.token.email == 'admin@tucitasegura.com';
    }
    function isConcierge() { return isAuthed() && role() == 'concierge'; }
    function isMale() { return isAuthed() && gender() == 'masculino'; }
    function isFemale() { return isAuthed() && gender() == 'femenino'; }

    // ========= PROFILE PHOTOS =========
    // Ruta con género del dueño para poder evaluar "género opuesto" sin Firestore:
    // /profile_photos/{ownerGender}/{userId}/{filename}
    // ========= USER FILES (Generic) =========
    // Allow users to manage everything in their own folder: /users/{userId}/...
    match /users/{userId}/{allPaths=**} {
      allow read: if isAuthed(); // Public read (simplification for MVP)
      allow write: if isAuthed() && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // ========= EVENT PHOTOS (VIP) =========
    match /event_photos/{eventId}/{filename} {
      allow read: if isAuthed() && (isFemale() || isConcierge() || isAdmin());
      allow write: if isAuthed()
                   && isConcierge()
                   && request.resource.size < 10 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // ========= SOS EVIDENCE =========
    match /sos_evidence/{userId}/{filename} {
      allow read: if isAuthed() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthed()
                   && request.auth.uid == userId
                   && request.resource.size < 50 * 1024 * 1024
                   && (
                        request.resource.contentType.matches('image/.*') ||
                        request.resource.contentType.matches('video/.*')
                      );
    }

    // ========= VERIFICATION DOCS =========
    match /verification_docs/{userId}/{filename} {
      allow read: if isAuthed() && isAdmin();
      allow write: if isAuthed()
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024
                   && (
                        request.resource.contentType.matches('image/.*') ||
                        request.resource.contentType == 'application/pdf'
                      );
    }

    // ========= CHAT ATTACHMENTS con ACL en Storage =========
    // ACL: /chat_attachments/{conversationId}/__acl__/{uid} (ficheros vacíos)
    match /chat_attachments/{conversationId}/__acl__/{memberUid} {
      allow read: if false; // No exponer ACL
      allow write: if isAuthed() && (isAdmin() || isConcierge()); // gestionado por backend
    }

    function isInConversation(conversationId) {
      return isAuthed() &&
             request.auth.uid in get(/databases/(default)/documents/conversations/$(conversationId)).data.participants;
    }

    match /chat_attachments/{conversationId}/{filename} {
      allow read: if isInConversation(conversationId);
      allow write: if isInConversation(conversationId)
                   && request.resource.size < 25 * 1024 * 1024;
    }

    // ========= COVER GIRL CAMPAIGN =========
    match /cover-girl/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Default deny
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
